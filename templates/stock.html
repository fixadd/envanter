<div class="container-xxl">
  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="stok-durumu-tab" data-bs-toggle="tab" data-bs-target="#stok-durumu" type="button" role="tab" aria-controls="stok-durumu" aria-selected="true">Stok Durumu</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="log-tab" data-bs-toggle="tab" data-bs-target="#log" type="button" role="tab" aria-controls="log" aria-selected="false">Log</button>
    </li>
  </ul>
  <div class="tab-content mt-3">
    <div class="tab-pane fade show active" id="stok-durumu" role="tabpanel" aria-labelledby="stok-durumu-tab">
      <table id="stock-table"
             data-toggle="table"
             data-url="/api/stock/status"
             data-pagination="false"
             data-search="false"
            class="table table-striped">
        <thead>
          <tr>
            <th data-field="donanim_tipi">Donanım Tipi</th>
            <th data-field="marka" data-formatter="emptyFormatter">Marka</th>
            <th data-field="model" data-formatter="emptyFormatter">Model</th>
            <th data-field="ifs_no" data-formatter="emptyFormatter">IFS No</th>
            <th data-field="net_miktar" data-align="right">Stok</th>
            <th data-field="son_islem_ts" data-formatter="emptyFormatter">Son İşlem</th>
            <th data-formatter="detailFormatter" data-align="center"></th>
          </tr>
        </thead>
      </table>
    </div>
    <div class="tab-pane fade" id="log" role="tabpanel" aria-labelledby="log-tab">
      <div id="logList" class="small text-muted">Log yüklenmedi.</div>
    </div>
  </div>
</div>

<script>
function emptyFormatter(value) {
  return value ?? '-';
}

function detailFormatter(value, row) {
  if (!['lisans', 'envanter', 'yazici'].includes(row.source_type)) return '';
  const payload = encodeURIComponent(JSON.stringify(row));
  return `<button class="btn btn-outline-secondary btn-sm" onclick="showStockDetail('${payload}')" title="Detay">&#8801;</button>`;
}

function showStockDetail(encoded) {
  const row = JSON.parse(decodeURIComponent(encoded));
  const lines = [
    `Donanım Tipi: ${row.donanim_tipi ?? '-'}`,
    `Marka: ${row.marka ?? '-'}`,
    `Model: ${row.model ?? '-'}`,
    `IFS No: ${row.ifs_no ?? '-'}`,
    `Stok: ${row.net_miktar}`,
    `Son İşlem: ${row.son_islem_ts ?? '-'}`,
  ];
  alert(lines.join('\n'));
}

document.addEventListener("DOMContentLoaded", function () {
  // sayfa yüklenince bir kez yenile
  setTimeout(() => {
    if (window.$ && $('#stock-table').bootstrapTable) {
      $('#stock-table').bootstrapTable('refresh', { silent: true });
    }
  }, 200);

  // bootstrap tab değişiminde "stok-durumu" sekmesi görünür olunca yenile
  document.querySelectorAll('[data-bs-toggle="tab"]').forEach(link => {
    link.addEventListener('shown.bs.tab', function (e) {
      const target = e.target.getAttribute('data-bs-target') || e.target.getAttribute('href');
      if (target && target.includes('stok-durumu')) {
        if (window.$ && $('#stock-table').bootstrapTable) {
          $('#stock-table').bootstrapTable('refresh', { silent: true });
        }
      }
    });
  });
});
</script>
