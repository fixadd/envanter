{% extends "base.html" %}{% block title %}Yazıcı Düzenle{% endblock %}{% block
content %}
<div
  class="modal fade show printer-edit-modal"
  id="printerEditModal"
  tabindex="-1"
  role="dialog"
  aria-modal="true"
  aria-labelledby="printer-edit-title"
  style="display: block"
  data-bs-backdrop="static"
>
  <div
    class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"
  >
    <form
      method="post"
      action="{{ '?modal=1' if modal else '' }}"
      id="printer-edit-form"
      class="modal-content needs-validation"
      autocomplete="off"
      novalidate
      tabindex="-1"
    >
      <div class="modal-header align-items-start">
        <div>
          <span class="eyebrow text-primary d-block mb-1">Yazıcı Yönetimi</span>
          <h5 class="modal-title" id="printer-edit-title">
            Yazıcı Bilgilerini Düzenleyin
          </h5>
          <p class="modal-subtitle mb-0">
            Yazıcı envanteri kayıtlarını güncel tutarak bakım ve takibi
            kolaylaştırın.
          </p>
        </div>
        <button
          type="button"
          class="btn-close"
          data-printer-edit-close
          aria-label="Pencereyi kapat"
        ></button>
      </div>

      <div class="modal-body">
        <div class="row g-3" id="printer-edit-grid">
          <div class="col-lg-6">
            <label for="printerId" class="form-label">Kayıt No</label>
            <input
              id="printerId"
              type="text"
              class="form-control"
              value="#{{ p.id }}{{ ' • ' ~ p.envanter_no if p.envanter_no }}"
              readonly
            />
          </div>
          <div class="col-12">{% include "_printer_form_fields.html" %}</div>
          <div class="col-lg-6">
            <label for="printerSerial" class="form-label">Seri No</label>
            <input
              type="text"
              name="seri_no"
              id="printerSerial"
              value="{{ p.seri_no or '' }}"
              class="form-control"
              placeholder="Seri numarası"
            />
          </div>
          <div class="col-12">
            <label for="printerNotes" class="form-label">Notlar</label>
            <textarea
              name="notlar"
              id="printerNotes"
              class="form-control"
              rows="4"
              placeholder="Bakım, toner değişimi veya diğer notlar..."
            >
{{ p.notlar or '' }}</textarea
            >
          </div>
        </div>
      </div>

      <div
        class="modal-footer flex-column flex-lg-row gap-3 align-items-stretch align-items-lg-center"
      >
        <div class="d-flex align-items-start gap-2 text-muted small w-100">
          <i class="bi bi-info-circle-fill" aria-hidden="true"></i>
          <span>Kaydedilen bilgiler yazıcı geçmişine işlenecektir.</span>
        </div>
        <div
          class="d-flex gap-2 w-100 justify-content-end ms-lg-auto justify-content-lg-end"
        >
          {% if not modal %}
          <a href="/printers/{{ p.id }}" class="btn btn-outline-secondary">
            İptal
          </a>
          {% endif %}
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-save me-1" aria-hidden="true"></i>
            Kaydet
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
<div class="modal-backdrop fade show"></div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const applyModalOpen = () => document.body.classList.add("modal-open");
    const removeModalOpen = () => document.body.classList.remove("modal-open");
    const isEmbedded = window.self !== window.top;

    applyModalOpen();
    window.addEventListener("beforeunload", removeModalOpen);

    const dialogContent = document.querySelector(
      ".printer-edit-modal .modal-content",
    );
    if (dialogContent) {
      try {
        dialogContent.focus({ preventScroll: true });
      } catch (err) {
        dialogContent.focus();
      }
    }

    const fallbackUrl = "/printers/{{ p.id }}";
    const hasUsableHistory = () => {
      if (!document.referrer) return false;
      try {
        const ref = new URL(document.referrer);
        return ref.origin === window.location.origin;
      } catch (err) {
        return false;
      }
    };

    let closing = false;
    const closeDialog = (event) => {
      if (closing) return;
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }
      closing = true;
      removeModalOpen();

      if (isEmbedded) {
        try {
          window.parent.postMessage("modal-close", "*");
        } catch (err) {}
        return;
      }

      if (window.history.length > 1 && hasUsableHistory()) {
        window.history.back();
        window.setTimeout(() => {
          if (!document.hidden) {
            window.location.href = fallbackUrl;
          }
        }, 300);
      } else {
        window.location.href = fallbackUrl;
      }
    };

    document
      .querySelectorAll("[data-printer-edit-close]")
      .forEach((trigger) => {
        trigger.addEventListener("click", closeDialog);
      });

    const form = document.getElementById("printer-edit-form");
    const setFormValue = (name, value) => {
      if (!form) return;
      const field = form.querySelector(`[name="${name}"]`);
      if (field) field.value = value ?? "";
    };

    if (form) {
      setFormValue("envanter_no", {{ (p.envanter_no or '')|tojson }});
      setFormValue("ip_adresi", {{ (p.ip_adresi or '')|tojson }});
      setFormValue("mac", {{ (p.mac or '')|tojson }});
      setFormValue("hostname", {{ (p.hostname or '')|tojson }});
      setFormValue("ifs_no", {{ (p.ifs_no or '')|tojson }});

      const hiddenBrand = form.querySelector("#printerMarkaName");
      const hiddenModel = form.querySelector("#printerModelName");
      const hiddenUsage = form.querySelector("#printerUsageName");

      const updateHiddenValue = (select, hidden) => {
        if (!select || !hidden) return;
        const opt = select.options[select.selectedIndex];
        hidden.value = opt ? opt.text.trim() : "";
      };

      const attachHiddenSync = (select, hidden) => {
        if (!select || !hidden) return;
        select.addEventListener("change", () => updateHiddenValue(select, hidden));
      };

      const setChoiceByLabel = (select, label, { hidden, fallbackPrefix } = {}) => {
        if (!select) return null;
        const targetLabel = String(label || "").trim();
        if (!targetLabel) {
          if (hidden) hidden.value = "";
          return null;
        }
        const lower = targetLabel.toLowerCase();
        const option = Array.from(select.options).find((opt) =>
          opt.text.trim().toLowerCase() === lower,
        );
        if (option) {
          const inst = select._choices;
          if (inst && option.value !== undefined) {
            inst.setChoiceByValue(String(option.value));
          }
          select.value = option.value;
          if (hidden) hidden.value = option.text.trim();
          return option.value;
        }

        const inst = select._choices;
        const fallbackValue =
          select.dataset.fallbackValue ||
          `${fallbackPrefix || "__custom"}_${select.id || "choice"}`;
        select.dataset.fallbackValue = fallbackValue;
        if (inst) {
          const hasExisting = Array.from(select.options).some(
            (opt) => opt.value === fallbackValue,
          );
          if (!hasExisting) {
            inst.setChoices(
              [
                {
                  value: fallbackValue,
                  label: targetLabel,
                  selected: true,
                },
              ],
              "value",
              "label",
              false,
            );
          }
          inst.setChoiceByValue(fallbackValue);
        } else {
          let opt = Array.from(select.options).find(
            (o) => o.value === fallbackValue,
          );
          if (!opt) {
            opt = document.createElement("option");
            opt.value = fallbackValue;
            opt.textContent = targetLabel;
            select.appendChild(opt);
          }
          opt.selected = true;
          select.value = fallbackValue;
        }
        if (hidden) hidden.value = targetLabel;
        return fallbackValue;
      };

      const initSelects = async () => {
        if (!window._selects) return;
        const brandSelect = form.querySelector("#selYaziciMarka");
        const modelSelect = form.querySelector("#selYaziciModel");
        const usageSelect = form.querySelector("#selYaziciKullanim");

        if (brandSelect) {
          attachHiddenSync(brandSelect, hiddenBrand);
          await window._selects.fillChoices({
            endpoint: "/api/lookup/marka",
            selectId: "selYaziciMarka",
            placeholder: "Yazıcı markası seçiniz…",
          });
          setChoiceByLabel(brandSelect, {{ (p.marka or '')|tojson }}, {
            hidden: hiddenBrand,
            fallbackPrefix: "brand",
          });
          await window._selects.bindMarkaModel(
            "selYaziciMarka",
            "selYaziciModel",
          );
          if (modelSelect) {
            attachHiddenSync(modelSelect, hiddenModel);
            setChoiceByLabel(modelSelect, {{ (p.model or '')|tojson }}, {
              hidden: hiddenModel,
              fallbackPrefix: "model",
            });
          }
          window._selects.enableRemoteSearch(
            "selYaziciModel",
            "/api/lookup/model",
            () => {
              const raw = brandSelect.value || "";
              const parsed = Number.parseInt(raw, 10);
              if (!Number.isFinite(parsed)) {
                return { __skip: true };
              }
              return { marka_id: parsed };
            },
          );
        }

        if (usageSelect) {
          attachHiddenSync(usageSelect, hiddenUsage);
          await window._selects.fillChoices({
            endpoint: "/api/lookup/kullanim-alani",
            selectId: "selYaziciKullanim",
            placeholder: "Kullanım alanı seçiniz…",
          });
          setChoiceByLabel(usageSelect, {{ (p.kullanim_alani or '')|tojson }}, {
            hidden: hiddenUsage,
            fallbackPrefix: "usage",
          });
        }

        updateHiddenValue(brandSelect, hiddenBrand);
        updateHiddenValue(modelSelect, hiddenModel);
        updateHiddenValue(usageSelect, hiddenUsage);
      };

      initSelects().catch((err) => {
        console.error("Printer edit modal init failed", err);
      });
    }

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        closeDialog(event);
      }
    });
  });
</script>
{% endblock %}
