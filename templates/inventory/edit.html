{% extends "base.html" %}
{% from "partials/inventory_form_fields.html" import inventory_form_fields %}
{% block title %}Envanter Düzenle{% endblock %}
{% block content %}
<div
  class="modal fade show inventory-edit-modal"
  id="inventoryEditModal"
  tabindex="-1"
  role="dialog"
  aria-modal="true"
  aria-labelledby="inventory-edit-title"
  style="display: block"
  data-bs-backdrop="static"
>
  <div
    class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"
  >
    <form
      method="post"
      action="{{ '?modal=1' if modal else '' }}"
      id="inventory-edit-form"
      class="modal-content needs-validation"
      autocomplete="off"
      novalidate
      tabindex="-1"
    >
      <div class="modal-header align-items-start">
        <div>
          <span class="eyebrow text-primary d-block mb-1"
            >Envanter Yönetimi</span
          >
          <h5 class="modal-title" id="inventory-edit-title">
            Envanter Bilgilerini Düzenleyin
          </h5>
          <p class="modal-subtitle mb-0">
            Bilgileri güncel tutarak ekipmanlarınızın durumunu daha kolay takip
            edin.
          </p>
        </div>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          data-inventory-edit-close
          aria-label="Pencereyi kapat"
        ></button>
      </div>

      <div class="modal-body">
        {{ inventory_form_fields(mode='edit', item=item) }}
      </div>

      <div class="modal-footer">
        <div class="row g-3 align-items-center w-100">
          <div class="col-lg d-flex align-items-start gap-2 text-muted small">
            <i class="bi bi-info-circle-fill" aria-hidden="true"></i>
            <span>Kaydettiğiniz bilgiler envanter geçmişine işlenecektir.</span>
          </div>
          <div class="col-lg-auto ms-lg-auto">
            <div class="d-flex gap-2 justify-content-end">
              {% if not modal %}
              <a
                href="{{ url_for('inventory.list') }}"
                class="btn btn-secondary"
              >
                İptal
              </a>
              {% endif %}
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save me-1" aria-hidden="true"></i>
                Kaydet
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>
<div class="modal-backdrop fade show"></div>

<div id="picker-modal" class="picker-modal" hidden>
  <div class="picker-card">
    <div class="picker-head">
      <strong id="picker-title">Seçim</strong>
      <button type="button" class="picker-close" aria-label="Kapat">×</button>
    </div>
    <div class="picker-search">
      <input
        id="picker-search"
        type="text"
        placeholder="Ara / yeni değer yaz..."
      />
      <button type="button" class="picker-add" id="picker-add">Ekle</button>
    </div>
    <div id="picker-list" class="picker-list"></div>
    <div class="picker-foot">
      <button type="button" class="btn btn-light" id="picker-cancel">Kapat</button>
    </div>
  </div>
</div>

<style>
  .picker-modal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 1.5rem;
    background: rgba(15, 23, 42, 0.4);
    backdrop-filter: blur(2px);
    z-index: 1080;
  }
  .picker-modal:not([hidden]) {
    display: flex;
  }
  .picker-card {
    width: min(420px, 100%);
    background: #ffffff;
    border-radius: 1rem;
    box-shadow: 0 40px 90px rgba(15, 23, 42, 0.25);
    display: flex;
    flex-direction: column;
  }
  .picker-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #f1f5f9;
  }
  .picker-close {
    border: none;
    background: transparent;
    font-size: 1.5rem;
    line-height: 1;
    color: #64748b;
    cursor: pointer;
  }
  .picker-search {
    display: flex;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #f1f5f9;
  }
  .picker-search input {
    flex: 1 1 auto;
    border: 1px solid #d1d5db;
    border-radius: 0.75rem;
    padding: 0.5rem 0.75rem;
    font-size: 0.95rem;
  }
  .picker-add {
    border: none;
    border-radius: 0.75rem;
    background: #4338ca;
    color: #fff;
    font-weight: 600;
    padding: 0.5rem 0.9rem;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  .picker-add:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    background: #a5b4fc;
  }
  .picker-list {
    max-height: 320px;
    overflow-y: auto;
  }
  .picker-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1.25rem;
    border-bottom: 1px solid #f1f5f9;
    gap: 0.75rem;
  }
  .picker-row:nth-child(even) {
    background: #f8fafc;
  }
  .picker-name {
    margin: 0;
    font-size: 0.95rem;
    color: #0f172a;
    font-weight: 500;
  }
  .picker-actions {
    display: inline-flex;
    gap: 0.5rem;
  }
  .picker-select,
  .picker-del {
    border: none;
    border-radius: 999px;
    padding: 0.3rem 0.8rem;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  .picker-select {
    background: #4f46e5;
    color: #fff;
  }
  .picker-select:hover {
    background: #3730a3;
  }
  .picker-del {
    background: #fee2e2;
    color: #b91c1c;
  }
  .picker-del:hover {
    background: #fecaca;
  }
  .picker-empty {
    padding: 1.25rem;
    text-align: center;
    color: #6b7280;
    font-size: 0.9rem;
  }
  .picker-foot {
    padding: 1rem 1.25rem;
    border-top: 1px solid #f1f5f9;
    display: flex;
    justify-content: flex-end;
  }
</style>

<script src="{{ url_for('static', path='js/mini-picker.js') }}"></script>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const applyModalOpen = () => document.body.classList.add("modal-open");
    const removeModalOpen = () => document.body.classList.remove("modal-open");
    const isEmbedded = window.self !== window.top;

    applyModalOpen();
    window.addEventListener("beforeunload", removeModalOpen);

    const dialogContent = document.querySelector(
      ".inventory-edit-modal .modal-content"
    );
    if (dialogContent) {
      try {
        dialogContent.focus({ preventScroll: true });
      } catch (err) {
        dialogContent.focus();
      }
    }

    const fallbackUrl = "{{ url_for('inventory.list') }}";
    const hasUsableHistory = () => {
      if (!document.referrer) return false;
      try {
        const ref = new URL(document.referrer);
        return ref.origin === window.location.origin;
      } catch (err) {
        return false;
      }
    };
    let closing = false;
    const closeDialog = (event) => {
      if (closing) return;
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }
      closing = true;
      removeModalOpen();

      if (isEmbedded) {
        try {
          window.parent.postMessage("modal-close", "*");
        } catch (err) {}
        return;
      }

      if (window.history.length > 1 && hasUsableHistory()) {
        window.history.back();
        window.setTimeout(() => {
          if (!document.hidden) {
            window.location.href = fallbackUrl;
          }
        }, 300);
      } else {
        window.location.href = fallbackUrl;
      }
    };

    document
      .querySelectorAll("[data-inventory-edit-close]")
      .forEach((trigger) => {
        trigger.addEventListener("click", closeDialog);
      });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        closeDialog(event);
      }
    });

    const current = {{ {
      "bilgisayar_adi": item.bilgisayar_adi or "",
      "fabrika": item.fabrika or "",
      "departman": item.departman or "",
      "donanim": item.donanim_tipi or "",
      "sorumlu": item.sorumlu_personel or "",
      "marka": item.marka or "",
      "model": item.model or "",
      "seri_no": item.seri_no or "",
      "kullanim": item.kullanim_alani or "",
      "ifs_no": item.ifs_no or "",
      "bagli": item.bagli_envanter_no or "",
      "not": item.not_ or "",
    } | tojson }};

    function setInputValue(name, value) {
      const el = document.querySelector(`[name="${name}"]`);
      if (el) el.value = value || "";
    }

    setInputValue("bilgisayar_adi", current.bilgisayar_adi);
    setInputValue("seri_no", current.seri_no);
    setInputValue("ifs_no", current.ifs_no);
    setInputValue("bagli_envanter_no", current.bagli);
    setInputValue("not", current.not);

    const optionCache = new Map();

    function makeCacheKey(endpoint, params) {
      const entries = Object.entries(params || {})
        .filter(([_, v]) => v !== undefined && v !== null && v !== "")
        .sort(([a], [b]) => a.localeCompare(b));
      const query = entries
        .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
        .join("&");
      return `${endpoint}?${query}`;
    }

    async function fetchOptions(endpoint, params = {}) {
      const key = makeCacheKey(endpoint, params);
      if (optionCache.has(key)) {
        return optionCache.get(key);
      }
      try {
        const url = new URL(endpoint, window.location.origin);
        Object.entries(params || {}).forEach(([k, v]) => {
          if (v !== undefined && v !== null && v !== "") {
            url.searchParams.set(k, v);
          }
        });
        const res = await fetch(url, { headers: { Accept: "application/json" } });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const data = (await res.json()) || [];
        optionCache.set(key, data);
        return data;
      } catch (err) {
        console.error("Seçenek listesi alınamadı", endpoint, err);
        optionCache.set(key, []);
        return [];
      }
    }

    function findExactMatch(options, text) {
      const target = (text || "").trim().toLowerCase();
      if (!target) return null;
      return (
        options.find(
          (row) => (row.text || "").trim().toLowerCase() === target
        ) || null
      );
    }

    async function resolveOption(endpoint, text, params = {}, fallback) {
      if (!text) return null;
      const base = await fetchOptions(endpoint, params);
      let match = findExactMatch(base, text);
      if (match) return match;
      if (!("q" in params)) {
        const withQuery = await fetchOptions(endpoint, {
          ...params,
          q: text,
        });
        match = findExactMatch(withQuery, text);
      }
      if (!match && fallback && fallback.endpoint) {
        const fallbackOptions = await fetchOptions(
          fallback.endpoint,
          fallback.params || {},
        );
        match = findExactMatch(fallbackOptions, text);
      }
      return match || null;
    }

    const pickerFields = [
      {
        entity: "fabrika",
        hiddenId: "edit_fabrika_id",
        displayId: "edit_fabrika_display",
        currentKey: "fabrika",
        endpoint: "/api/picker/fabrika",
      },
      {
        entity: "departman",
        hiddenId: "edit_departman_id",
        displayId: "edit_departman_display",
        currentKey: "departman",
        endpoint: "/api/picker/kullanim_alani",
        fallbackEndpoint: "/inventory/assign/sources?type=departman",
      },
      {
        entity: "donanim_tipi",
        hiddenId: "edit_donanim_id",
        displayId: "edit_donanim_display",
        currentKey: "donanim",
        endpoint: "/api/picker/donanim_tipi",
      },
      {
        entity: "sorumlu_personel",
        hiddenId: "edit_sorumlu_id",
        displayId: "edit_sorumlu_display",
        currentKey: "sorumlu",
        endpoint: "/api/picker/kullanici",
      },
      {
        entity: "kullanim_alani",
        hiddenId: "edit_kullanim_id",
        displayId: "edit_kullanim_display",
        currentKey: "kullanim",
        endpoint: "/api/picker/kullanim_alani",
      },
    ];

    async function prefillPickerField(field) {
      const display = document.getElementById(field.displayId);
      const hidden = document.getElementById(field.hiddenId);
      if (display) {
        display.value = current[field.currentKey] || "";
      }
      if (!hidden) return null;
      hidden.value = "";
      hidden.dataset.id = "";
      hidden.dataset.text = "";
      const textValue = current[field.currentKey];
      if (!textValue) {
        return null;
      }
      const match = await resolveOption(
        field.endpoint,
        textValue,
        field.params,
        field.fallbackEndpoint
          ? { endpoint: field.fallbackEndpoint, params: field.fallbackParams }
          : null,
      );
      if (match) {
        hidden.value = match.id;
        hidden.dataset.id = match.id;
        hidden.dataset.text = match.text;
        return match.id;
      }
      return null;
    }

    for (const field of pickerFields) {
      await prefillPickerField(field);
    }

    const markaField = {
      entity: "marka",
      hiddenId: "edit_marka_id",
      displayId: "edit_marka_display",
      currentKey: "marka",
      endpoint: "/api/picker/marka",
    };
    await prefillPickerField(markaField);

    const markaHidden = document.getElementById(markaField.hiddenId);
    const markaDisplay = document.getElementById(markaField.displayId);
    let currentBrandId = markaHidden
      ? markaHidden.dataset.id || markaHidden.value
      : "";

    const modelField = {
      entity: "model",
      hiddenId: "edit_model_id",
      displayId: "edit_model_display",
      currentKey: "model",
      endpoint: "/api/picker/model",
      parentHiddenId: markaField.hiddenId,
    };

    async function fillModelForBrand(brandId, modelText) {
      const modelHidden = document.getElementById(modelField.hiddenId);
      const modelDisplay = document.getElementById(modelField.displayId);
      if (modelDisplay) {
        modelDisplay.value = modelText || "";
      }
      if (!modelHidden) return;
      modelHidden.value = "";
      modelHidden.dataset.id = "";
      modelHidden.dataset.text = "";
      if (!brandId || !modelText) {
        return;
      }
      const match = await resolveOption(modelField.endpoint, modelText, {
        marka_id: brandId,
      });
      if (match) {
        modelHidden.value = match.id;
        modelHidden.dataset.id = match.id;
        modelHidden.dataset.text = match.text;
      }
    }

    await fillModelForBrand(currentBrandId, current.model);

    function updateModelAvailability() {
      const modelButton = document.querySelector(
        '.inventory-edit-modal .pick-btn[data-entity="model"]'
      );
      const modelInput = document.getElementById(modelField.displayId);
      const enabled = Boolean(currentBrandId);
      if (modelButton) {
        modelButton.disabled = !enabled;
      }
      if (modelInput) {
        modelInput.placeholder = enabled
          ? "Seçiniz..."
          : "Önce marka seçiniz...";
      }
    }

    function clearModelSelection() {
      const modelHidden = document.getElementById(modelField.hiddenId);
      const modelDisplay = document.getElementById(modelField.displayId);
      if (modelHidden) {
        modelHidden.value = "";
        modelHidden.dataset.id = "";
        modelHidden.dataset.text = "";
      }
      if (modelDisplay) {
        modelDisplay.value = "";
      }
      current.model = "";
    }

    updateModelAvailability();

    function attachPickerSync(field) {
      const hidden = document.getElementById(field.hiddenId);
      const display = document.getElementById(field.displayId);
      if (!hidden) return;
      hidden.addEventListener("picker:change", (event) => {
        const detail = event.detail || {};
        const text = detail.text || "";
        current[field.currentKey] = text;
        if (display && display.value !== text) {
          display.value = text;
        }
        hidden.dataset.id = detail.id || hidden.value || "";
        hidden.dataset.text = text;
      });
    }

    for (const field of [...pickerFields, markaField, modelField]) {
      attachPickerSync(field);
    }

    if (markaHidden) {
      markaHidden.addEventListener("picker:change", (event) => {
        const detail = event.detail || {};
        const newBrandId =
          detail.id ||
          markaHidden.dataset.id ||
          markaHidden.value ||
          "";
        currentBrandId = newBrandId;
        const brandText =
          detail.text || markaHidden.dataset.text || markaHidden.value || "";
        current.marka = brandText;
        if (markaDisplay && markaDisplay.value !== brandText) {
          markaDisplay.value = brandText;
        }
        clearModelSelection();
        updateModelAvailability();
      });
    }

  });
</script>
{% endblock %}
