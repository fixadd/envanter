{% extends "base.html" %}
{% from "partials/inventory_form_fields.html" import inventory_form_fields %}
{% block title %}Envanter Düzenle{% endblock %}
{% block content %}
<div
  class="modal fade show inventory-edit-modal"
  id="inventoryEditModal"
  tabindex="-1"
  role="dialog"
  aria-modal="true"
  aria-labelledby="inventory-edit-title"
  style="display: block"
  data-bs-backdrop="static"
>
  <div
    class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"
  >
    <form
      method="post"
      action="{{ '?modal=1' if modal else '' }}"
      id="inventory-edit-form"
      class="modal-content needs-validation"
      autocomplete="off"
      novalidate
      tabindex="-1"
    >
      <div class="modal-header align-items-start">
        <div>
          <span class="eyebrow text-primary d-block mb-1"
            >Envanter Yönetimi</span
          >
          <h5 class="modal-title" id="inventory-edit-title">
            Envanter Bilgilerini Düzenleyin
          </h5>
          <p class="modal-subtitle mb-0">
            Bilgileri güncel tutarak ekipmanlarınızın durumunu daha kolay takip
            edin.
          </p>
        </div>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          data-inventory-edit-close
          aria-label="Pencereyi kapat"
        ></button>
      </div>

      <div class="modal-body">
        {{ inventory_form_fields(mode='edit', item=item) }}
      </div>

      <div class="modal-footer">
        <div class="row g-3 align-items-center w-100">
          <div class="col-lg d-flex align-items-start gap-2 text-muted small">
            <i class="bi bi-info-circle-fill" aria-hidden="true"></i>
            <span>Kaydettiğiniz bilgiler envanter geçmişine işlenecektir.</span>
          </div>
          <div class="col-lg-auto ms-lg-auto">
            <div class="d-flex gap-2 justify-content-end">
              {% if not modal %}
              <a
                href="{{ url_for('inventory.list') }}"
                class="btn btn-secondary"
              >
                İptal
              </a>
              {% endif %}
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save me-1" aria-hidden="true"></i>
                Kaydet
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>
<div class="modal-backdrop fade show"></div>

<script src="{{ url_for('static', path='js/inventory-form.js') }}"></script>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const applyModalOpen = () => document.body.classList.add("modal-open");
    const removeModalOpen = () => document.body.classList.remove("modal-open");
    const isEmbedded = window.self !== window.top;

    applyModalOpen();
    window.addEventListener("beforeunload", removeModalOpen);

    const dialogContent = document.querySelector(
      ".inventory-edit-modal .modal-content"
    );
    if (dialogContent) {
      try {
        dialogContent.focus({ preventScroll: true });
      } catch (err) {
        dialogContent.focus();
      }
    }

    const fallbackUrl = "{{ url_for('inventory.list') }}";
    const hasUsableHistory = () => {
      if (!document.referrer) return false;
      try {
        const ref = new URL(document.referrer);
        return ref.origin === window.location.origin;
      } catch (err) {
        return false;
      }
    };
    let closing = false;
    const closeDialog = (event) => {
      if (closing) return;
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }
      closing = true;
      removeModalOpen();

      if (isEmbedded) {
        try {
          window.parent.postMessage("modal-close", "*");
        } catch (err) {}
        return;
      }

      if (window.history.length > 1 && hasUsableHistory()) {
        window.history.back();
        window.setTimeout(() => {
          if (!document.hidden) {
            window.location.href = fallbackUrl;
          }
        }, 300);
      } else {
        window.location.href = fallbackUrl;
      }
    };

    document
      .querySelectorAll("[data-inventory-edit-close]")
      .forEach((trigger) => {
        trigger.addEventListener("click", closeDialog);
      });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        closeDialog(event);
      }
    });

    if (window.inventoryForm && window.inventoryForm.initializeInventoryForm) {
      await window.inventoryForm.initializeInventoryForm({
        mode: "edit",
        values: {
          fabrika: {{ (item.fabrika or '') | tojson }},
          departman: {{ (item.departman or '') | tojson }},
          donanim_tipi: {{ (item.donanim_tipi or '') | tojson }},
          sorumlu_personel: {{ (item.sorumlu_personel or '') | tojson }},
          marka: {{ (item.marka or '') | tojson }},
          model: {{ (item.model or '') | tojson }},
          kullanim_alani: {{ (item.kullanim_alani or '') | tojson }},
        },
      });
    }
  });
</script>
{% endblock %}
