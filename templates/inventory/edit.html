{% extends "base.html" %}{% block title %}Envanter Düzenle{% endblock %} {%
block content %}
<section
  class="inventory-edit"
  role="dialog"
  aria-modal="true"
  aria-labelledby="inventory-edit-title"
>
  <div class="inventory-edit__dialog" role="document">
    <div class="inventory-edit__card" tabindex="-1">
      <button
        type="button"
        class="inventory-edit__close"
        data-inventory-edit-close
      >
        <span class="visually-hidden">Pencereyi kapat</span>
        <i class="bi bi-x-lg" aria-hidden="true"></i>
      </button>

      <header class="inventory-edit__header">
        <span class="inventory-edit__eyebrow">Envanter Yönetimi</span>
        <h1 class="inventory-edit__title" id="inventory-edit-title">
          Envanter Bilgilerini Düzenleyin
        </h1>
        <p class="inventory-edit__subtitle">
          Bilgileri güncel tutarak ekipmanlarınızın durumunu daha kolay takip
          edin.
        </p>
      </header>

      <form
        method="post"
        action="{{ '?modal=1' if modal else '' }}"
        id="inventory-edit-form"
        class="inventory-edit__form needs-validation"
        autocomplete="off"
        novalidate
      >
        <div class="row g-3" id="inventory-edit-grid">
          <div class="col-md-6">
            <label class="form-label" for="inventoryNo">Envanter No</label>
            <input
              id="inventoryNo"
              type="text"
              class="form-control"
              value="{{ item.no }}"
              readonly
            />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="inventoryName">Bilgisayar Adı</label>
            <input
              id="inventoryName"
              name="bilgisayar_adi"
              type="text"
              class="form-control"
              value="{{ item.bilgisayar_adi or '' }}"
              placeholder="Örn. BT-WS-01"
            />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="edit_fabrika">Fabrika</label>
            <select
              id="edit_fabrika"
              name="fabrika"
              class="form-select"
            ></select>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="edit_departman">Departman</label>
            <select
              id="edit_departman"
              name="departman"
              class="form-select"
            ></select>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="edit_donanim">Donanım Tipi</label>
            <select
              id="edit_donanim"
              name="donanim_tipi"
              class="form-select"
            ></select>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="edit_sorumlu"
              >Sorumlu Personel</label
            >
            <select
              id="edit_sorumlu"
              name="sorumlu_personel"
              class="form-select"
            ></select>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="edit_marka">Marka</label>
            <select id="edit_marka" name="marka" class="form-select"></select>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="edit_model">Model</label>
            <select id="edit_model" name="model" class="form-select" disabled>
              <option value="">Önce marka seçiniz...</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="inventorySerial">Seri No</label>
            <input
              id="inventorySerial"
              name="seri_no"
              type="text"
              class="form-control"
              value="{{ item.seri_no or '' }}"
              placeholder="Seri numarası"
            />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="edit_kullanim">Kullanım Alanı</label>
            <select
              id="edit_kullanim"
              name="kullanim_alani"
              class="form-select"
            ></select>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="inventoryIfs">IFS No</label>
            <input
              id="inventoryIfs"
              name="ifs_no"
              type="text"
              class="form-control"
              value="{{ item.ifs_no or '' }}"
              placeholder="IFS referansı"
            />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="inventoryLinked"
              >Bağlı Envanter No</label
            >
            <input
              id="inventoryLinked"
              name="bagli_envanter_no"
              type="text"
              class="form-control"
              value="{{ item.bagli_envanter_no or '' }}"
              placeholder="Varsa bağlı envanter"
            />
          </div>
          <div class="col-12">
            <label class="form-label" for="inventoryNote">Not</label>
            <textarea
              id="inventoryNote"
              name="not"
              class="form-control"
              rows="3"
              placeholder="Envanterle ilgili önemli notları girin"
            >
{{ item.not_ or '' }}</textarea
            >
          </div>
        </div>

        <div class="inventory-edit__footer">
          <div class="inventory-edit__hint">
            <i class="bi bi-info-circle-fill" aria-hidden="true"></i>
            <span>Kaydettiğiniz bilgiler envanter geçmişine işlenecektir.</span>
          </div>
          <div class="inventory-edit__actions">
            {% if not modal %}
            <a
              href="{{ url_for('inventory.list') }}"
              class="btn btn-outline-secondary"
            >
              İptal
            </a>
            {% endif %}
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-save me-1" aria-hidden="true"></i>
              Kaydet
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    document.body.classList.add("inventory-edit--modal-open");
    const cleanup = () =>
      document.body.classList.remove("inventory-edit--modal-open");
    window.addEventListener("beforeunload", cleanup);

    const dialogCard = document.querySelector(".inventory-edit__card");
    if (dialogCard) {
      try {
        dialogCard.focus({ preventScroll: true });
      } catch (err) {
        dialogCard.focus();
      }
    }

    const fallbackUrl = "{{ url_for('inventory.list') }}";
    const hasUsableHistory = () => {
      if (!document.referrer) return false;
      try {
        const ref = new URL(document.referrer);
        return ref.origin === window.location.origin;
      } catch (err) {
        return false;
      }
    };
    let closing = false;
    const closeDialog = (event) => {
      if (closing) return;
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }
      closing = true;
      cleanup();

      if (window.history.length > 1 && hasUsableHistory()) {
        window.history.back();
        window.setTimeout(() => {
          if (!document.hidden) {
            window.location.href = fallbackUrl;
          }
        }, 300);
      } else {
        window.location.href = fallbackUrl;
      }
    };

    document
      .querySelectorAll("[data-inventory-edit-close]")
      .forEach((trigger) => {
        trigger.addEventListener("click", closeDialog);
      });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        closeDialog(event);
      }
    });

    const current = {{ {
      "bilgisayar_adi": item.bilgisayar_adi or "",
      "fabrika": item.fabrika or "",
      "departman": item.departman or "",
      "donanim": item.donanim_tipi or "",
      "sorumlu": item.sorumlu_personel or "",
      "marka": item.marka or "",
      "model": item.model or "",
      "seri_no": item.seri_no or "",
      "kullanim": item.kullanim_alani or "",
      "ifs_no": item.ifs_no or "",
      "bagli": item.bagli_envanter_no or "",
      "not": item.not_ or "",
    } | tojson }};

    function setInputValue(name, value) {
      const el = document.querySelector(`[name="${name}"]`);
      if (el) el.value = value || "";
    }

    setInputValue("bilgisayar_adi", current.bilgisayar_adi);
    setInputValue("seri_no", current.seri_no);
    setInputValue("ifs_no", current.ifs_no);
    setInputValue("bagli_envanter_no", current.bagli);
    setInputValue("not", current.not);

    async function loadOptions(selectEl, url, selectedValue) {
      if (!selectEl) return;
      let data = [];
      try {
        const res = await fetch(url);
        if (res.ok) {
          data = (await res.json()) || [];
        }
      } catch (err) {
        console.error("Seçenekler yüklenemedi", err);
      }
      selectEl.innerHTML =
        '<option value="">Seçiniz...</option>' +
        data
          .map(
            (o) =>
              `<option value="${o.text}" data-id="${o.id}">${o.text}</option>`
          )
          .join("");
      setSelectValue(selectEl, selectedValue);
    }

    function setSelectValue(selectEl, value) {
      if (!selectEl) return;
      const val = value || "";
      if (val && !Array.from(selectEl.options).some((opt) => opt.value === val)) {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        selectEl.appendChild(opt);
      }
      selectEl.value = val;
    }

    const fabrikaSel = document.getElementById("edit_fabrika");
    const departmanSel = document.getElementById("edit_departman");
    const donanimSel = document.getElementById("edit_donanim");
    const sorumluSel = document.getElementById("edit_sorumlu");
    const markaSel = document.getElementById("edit_marka");
    const modelSel = document.getElementById("edit_model");
    const kullanimSel = document.getElementById("edit_kullanim");

    await loadOptions(fabrikaSel, "/api/picker/fabrika", current.fabrika);
    await loadOptions(departmanSel, "/api/picker/kullanim_alani", current.departman);
    await loadOptions(donanimSel, "/api/picker/donanim_tipi", current.donanim);
    await loadOptions(kullanimSel, "/api/picker/kullanim_alani", current.kullanim);

    await loadOptions(sorumluSel, "/api/picker/kullanici", current.sorumlu);

    let brands = [];
    try {
      const brandRes = await fetch("/api/picker/marka");
      if (brandRes.ok) {
        brands = (await brandRes.json()) || [];
      }
    } catch (err) {
      console.error("Marka listesi alınamadı", err);
    }
    markaSel.innerHTML =
      '<option value="">Seçiniz...</option>' +
      brands
        .map(
          (b) =>
            `<option value="${b.text}" data-id="${b.id}">${b.text}</option>`
        )
        .join("");
    setSelectValue(markaSel, current.marka);

    async function populateModels(selectedBrandValue, selectedModelValue) {
      if (!modelSel) return;
      const opt = Array.from(markaSel.options).find(
        (option) => option.value === (selectedBrandValue || "")
      );
      const brandId = opt && opt.dataset.id;
      modelSel.innerHTML = '<option value="">Seçiniz...</option>';
      modelSel.disabled = !brandId;
      if (!brandId) {
        setSelectValue(modelSel, selectedModelValue);
        return;
      }
      let models = [];
      try {
        const res = await fetch(`/api/picker/model?marka_id=${brandId}`);
        if (res.ok) {
          models = (await res.json()) || [];
        }
      } catch (err) {
        console.error("Model listesi alınamadı", err);
      }
      modelSel.innerHTML += models
        .map((m) => `<option value="${m.text}">${m.text}</option>`)
        .join("");
      setSelectValue(modelSel, selectedModelValue);
    }

    await populateModels(current.marka, current.model);

    markaSel.addEventListener("change", async () => {
      await populateModels(markaSel.value, "");
    });
  });
</script>
{% endblock %}
