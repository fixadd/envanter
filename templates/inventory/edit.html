{% extends "base.html" %}{% block title %}Envanter Düzenle{% endblock %} {%
block content %}
<div
  class="modal fade show inventory-edit-modal"
  id="inventoryEditModal"
  tabindex="-1"
  role="dialog"
  aria-modal="true"
  aria-labelledby="inventory-edit-title"
  style="display: block;"
  data-bs-backdrop="static"
>
  <div
    class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"
  >
    <form
      method="post"
      action="{{ '?modal=1' if modal else '' }}"
      id="inventory-edit-form"
      class="modal-content needs-validation"
      autocomplete="off"
      novalidate
      tabindex="-1"
    >
      <div class="modal-header align-items-start">
        <div>
          <span class="eyebrow text-primary d-block mb-1"
            >Envanter Yönetimi</span
          >
          <h5 class="modal-title" id="inventory-edit-title">
            Envanter Bilgilerini Düzenleyin
          </h5>
          <p class="modal-subtitle mb-0">
            Bilgileri güncel tutarak ekipmanlarınızın durumunu daha kolay takip
            edin.
          </p>
        </div>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          data-inventory-edit-close
          aria-label="Pencereyi kapat"
        ></button>
      </div>

      <div class="modal-body">
        <div class="env-grid" id="inventory-edit-grid">
          <div class="field">
            <label for="inventoryNo">Envanter No</label>
            <input
              id="inventoryNo"
              type="text"
              class="ctrl"
              value="{{ item.no }}"
              readonly
            />
          </div>
          <div class="field">
            <label for="inventoryName">Bilgisayar Adı</label>
            <input
              id="inventoryName"
              name="bilgisayar_adi"
              type="text"
              class="ctrl"
              value="{{ item.bilgisayar_adi or '' }}"
              placeholder="Örn. BT-WS-01"
            />
          </div>
          <div class="field">
            <label for="edit_fabrika">Fabrika</label>
            <select id="edit_fabrika" name="fabrika" class="ctrl"></select>
          </div>
          <div class="field">
            <label for="edit_departman">Departman</label>
            <select id="edit_departman" name="departman" class="ctrl"></select>
          </div>
          <div class="field">
            <label for="edit_donanim">Donanım Tipi</label>
            <select id="edit_donanim" name="donanim_tipi" class="ctrl"></select>
          </div>
          <div class="field">
            <label for="edit_sorumlu">Sorumlu Personel</label>
            <select
              id="edit_sorumlu"
              name="sorumlu_personel"
              class="ctrl"
            ></select>
          </div>
          <div class="field">
            <label for="edit_marka">Marka</label>
            <select id="edit_marka" name="marka" class="ctrl"></select>
          </div>
          <div class="field">
            <label for="edit_model">Model</label>
            <select id="edit_model" name="model" class="ctrl" disabled>
              <option value="">Önce marka seçiniz...</option>
            </select>
          </div>
          <div class="field">
            <label for="inventorySerial">Seri No</label>
            <input
              id="inventorySerial"
              name="seri_no"
              type="text"
              class="ctrl"
              value="{{ item.seri_no or '' }}"
              placeholder="Seri numarası"
            />
          </div>
          <div class="field">
            <label for="edit_kullanim">Kullanım Alanı</label>
            <select
              id="edit_kullanim"
              name="kullanim_alani"
              class="ctrl"
            ></select>
          </div>
          <div class="field">
            <label for="inventoryIfs">IFS No</label>
            <input
              id="inventoryIfs"
              name="ifs_no"
              type="text"
              class="ctrl"
              value="{{ item.ifs_no or '' }}"
              placeholder="IFS referansı"
            />
          </div>
          <div class="field">
            <label for="inventoryLinked">Bağlı Envanter No</label>
            <input
              id="inventoryLinked"
              name="bagli_envanter_no"
              type="text"
              class="ctrl"
              value="{{ item.bagli_envanter_no or '' }}"
              placeholder="Varsa bağlı envanter"
            />
          </div>
          <div class="field span-2">
            <label for="inventoryNote">Not</label>
            <textarea
              id="inventoryNote"
              name="not"
              class="ctrl"
              rows="3"
              placeholder="Envanterle ilgili önemli notları girin"
            >
{{ item.not_ or '' }}</textarea
            >
          </div>
        </div>
      </div>

      <div
        class="modal-footer flex-column flex-lg-row gap-3 align-items-stretch align-items-lg-center"
      >
        <div class="d-flex align-items-start gap-2 text-muted small w-100">
          <i class="bi bi-info-circle-fill" aria-hidden="true"></i>
          <span>Kaydettiğiniz bilgiler envanter geçmişine işlenecektir.</span>
        </div>
        <div
          class="d-flex gap-2 w-100 justify-content-end ms-lg-auto justify-content-lg-end"
        >
          {% if not modal %}
          <a
            href="{{ url_for('inventory.list') }}"
            class="btn btn-outline-secondary"
          >
            İptal
          </a>
          {% endif %}
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-save me-1" aria-hidden="true"></i>
            Kaydet
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
<div class="modal-backdrop fade show"></div>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const applyModalOpen = () => document.body.classList.add("modal-open");
    const removeModalOpen = () => document.body.classList.remove("modal-open");

    applyModalOpen();
    window.addEventListener("beforeunload", removeModalOpen);

    const dialogContent = document.querySelector(
      ".inventory-edit-modal .modal-content"
    );
    if (dialogContent) {
      try {
        dialogContent.focus({ preventScroll: true });
      } catch (err) {
        dialogContent.focus();
      }
    }

    const fallbackUrl = "{{ url_for('inventory.list') }}";
    const hasUsableHistory = () => {
      if (!document.referrer) return false;
      try {
        const ref = new URL(document.referrer);
        return ref.origin === window.location.origin;
      } catch (err) {
        return false;
      }
    };
    let closing = false;
    const closeDialog = (event) => {
      if (closing) return;
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }
      closing = true;
      removeModalOpen();

      if (window.history.length > 1 && hasUsableHistory()) {
        window.history.back();
        window.setTimeout(() => {
          if (!document.hidden) {
            window.location.href = fallbackUrl;
          }
        }, 300);
      } else {
        window.location.href = fallbackUrl;
      }
    };

    document
      .querySelectorAll("[data-inventory-edit-close]")
      .forEach((trigger) => {
        trigger.addEventListener("click", closeDialog);
      });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        closeDialog(event);
      }
    });

    const current = {{ {
      "bilgisayar_adi": item.bilgisayar_adi or "",
      "fabrika": item.fabrika or "",
      "departman": item.departman or "",
      "donanim": item.donanim_tipi or "",
      "sorumlu": item.sorumlu_personel or "",
      "marka": item.marka or "",
      "model": item.model or "",
      "seri_no": item.seri_no or "",
      "kullanim": item.kullanim_alani or "",
      "ifs_no": item.ifs_no or "",
      "bagli": item.bagli_envanter_no or "",
      "not": item.not_ or "",
    } | tojson }};

    function setInputValue(name, value) {
      const el = document.querySelector(`[name="${name}"]`);
      if (el) el.value = value || "";
    }

    setInputValue("bilgisayar_adi", current.bilgisayar_adi);
    setInputValue("seri_no", current.seri_no);
    setInputValue("ifs_no", current.ifs_no);
    setInputValue("bagli_envanter_no", current.bagli);
    setInputValue("not", current.not);

    async function loadOptions(selectEl, url, selectedValue) {
      if (!selectEl) return;
      let data = [];
      try {
        const res = await fetch(url);
        if (res.ok) {
          data = (await res.json()) || [];
        }
      } catch (err) {
        console.error("Seçenekler yüklenemedi", err);
      }
      selectEl.innerHTML =
        '<option value="">Seçiniz...</option>' +
        data
          .map(
            (o) =>
              `<option value="${o.text}" data-id="${o.id}">${o.text}</option>`
          )
          .join("");
      setSelectValue(selectEl, selectedValue);
    }

    function setSelectValue(selectEl, value) {
      if (!selectEl) return;
      const val = value || "";
      if (val && !Array.from(selectEl.options).some((opt) => opt.value === val)) {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        selectEl.appendChild(opt);
      }
      selectEl.value = val;
    }

    const fabrikaSel = document.getElementById("edit_fabrika");
    const departmanSel = document.getElementById("edit_departman");
    const donanimSel = document.getElementById("edit_donanim");
    const sorumluSel = document.getElementById("edit_sorumlu");
    const markaSel = document.getElementById("edit_marka");
    const modelSel = document.getElementById("edit_model");
    const kullanimSel = document.getElementById("edit_kullanim");

    await loadOptions(fabrikaSel, "/api/picker/fabrika", current.fabrika);
    await loadOptions(departmanSel, "/api/picker/kullanim_alani", current.departman);
    await loadOptions(donanimSel, "/api/picker/donanim_tipi", current.donanim);
    await loadOptions(kullanimSel, "/api/picker/kullanim_alani", current.kullanim);

    await loadOptions(sorumluSel, "/api/picker/kullanici", current.sorumlu);

    let brands = [];
    try {
      const brandRes = await fetch("/api/picker/marka");
      if (brandRes.ok) {
        brands = (await brandRes.json()) || [];
      }
    } catch (err) {
      console.error("Marka listesi alınamadı", err);
    }
    markaSel.innerHTML =
      '<option value="">Seçiniz...</option>' +
      brands
        .map(
          (b) =>
            `<option value="${b.text}" data-id="${b.id}">${b.text}</option>`
        )
        .join("");
    setSelectValue(markaSel, current.marka);

    async function populateModels(selectedBrandValue, selectedModelValue) {
      if (!modelSel) return;
      const opt = Array.from(markaSel.options).find(
        (option) => option.value === (selectedBrandValue || "")
      );
      const brandId = opt && opt.dataset.id;
      modelSel.innerHTML = '<option value="">Seçiniz...</option>';
      modelSel.disabled = !brandId;
      if (!brandId) {
        setSelectValue(modelSel, selectedModelValue);
        return;
      }
      let models = [];
      try {
        const res = await fetch(`/api/picker/model?marka_id=${brandId}`);
        if (res.ok) {
          models = (await res.json()) || [];
        }
      } catch (err) {
        console.error("Model listesi alınamadı", err);
      }
      modelSel.innerHTML += models
        .map((m) => `<option value="${m.text}">${m.text}</option>`)
        .join("");
      setSelectValue(modelSel, selectedModelValue);
    }

    await populateModels(current.marka, current.model);

    markaSel.addEventListener("change", async () => {
      await populateModels(markaSel.value, "");
    });
  });
</script>
{% endblock %}
