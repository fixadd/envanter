{% extends "base.html" %} {% block title %}Lisans {{ 'Düzenle' if license else
'Ekle' }}{% endblock %} {% block content %} {% if license %}
<div
  class="modal fade show license-edit-modal"
  id="licenseEditModal"
  tabindex="-1"
  role="dialog"
  aria-modal="true"
  aria-labelledby="license-edit-title"
  style="display: block"
  data-bs-backdrop="static"
>
  <div
    class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"
  >
    <form
      method="post"
      action="{{ form_action }}{{ '?modal=1' if modal else '' }}"
      id="license-edit-form"
      class="modal-content needs-validation"
      autocomplete="off"
      novalidate
      tabindex="-1"
    >
      <div class="modal-header align-items-start">
        <div>
          <span class="eyebrow text-primary d-block mb-1">Lisans Yönetimi</span>
          <h5 class="modal-title" id="license-edit-title">
            Lisans Bilgilerini Güncelleyin
          </h5>
          <p class="modal-subtitle mb-0">
            Lisans kayıtlarını güncel tutarak kullanım ve atama geçmişini
            netleştirin.
          </p>
        </div>
        <button
          type="button"
          class="btn-close"
          data-license-edit-close
          aria-label="Pencereyi kapat"
        ></button>
      </div>

      <div class="modal-body">
        {% set license_form_config = { "ids": { "license_name": "licenseAdi",
        "license_key": "licenseKey", "responsible": "licenseSorumlu",
        "inventory": "selBagliEnvanter", "ifs": "licenseIfs", "email":
        "licenseMail", }, "names": { "license_name": "adi", "license_key":
        "anahtar", "responsible": "sorumlu_personel", "inventory":
        "inventory_id", "ifs": "ifs_no", "email": "mail_adresi", }, "values": {
        "license_name": license.lisans_adi if license else "", "license_key":
        license.anahtar if license else "", "responsible":
        license.sorumlu_personel if license else "", "inventory":
        license.inventory_id if license else "", "ifs": license.ifs_no if
        license else "", "email": license.mail_adresi if license else "", },
        "required": ["license_name"], "labels": { "inventory": "Bağlı Olduğu
        Envanter", }, "license_placeholder": "Seçiniz...",
        "inventory_empty_label": "Seçimsiz", } %} {% include
        "partials/license_form_fields.html" %}
      </div>

      <div
        class="modal-footer flex-column flex-lg-row gap-3 align-items-stretch align-items-lg-center"
      >
        <div class="d-flex align-items-start gap-2 text-muted small w-100">
          <i class="bi bi-info-circle-fill" aria-hidden="true"></i>
          <span>Değişiklikler lisans geçmişine kaydedilecektir.</span>
        </div>
        <div
          class="d-flex gap-2 w-100 justify-content-end ms-lg-auto justify-content-lg-end"
        >
          {% if not modal %}
          <a href="/lisans/{{ license.id }}" class="btn btn-outline-secondary">
            İptal
          </a>
          {% endif %}
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-save me-1" aria-hidden="true"></i>
            Kaydet
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
<div class="modal-backdrop fade show"></div>
{% else %}
<div class="container-fluid p-3 content">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <span class="eyebrow text-primary d-block mb-1">Lisans Yönetimi</span>
      <h4 class="mb-0">Lisans {{ 'Düzenle' if license else 'Ekle' }}</h4>
      <p class="text-muted mb-0">
        Yeni lisans kayıtları oluşturun veya mevcut bir lisansı güncelleyin.
      </p>
    </div>
    {% if not modal %}
    <a class="btn btn-light" href="{{ url_for('license_list') }}"
      >← Listeye Dön</a
    >
    {% endif %}
  </div>

  <div class="soft-card shadow-sm p-3">
    <form
      method="post"
      action="{{ form_action }}{{ '?modal=1' if modal else '' }}"
      class="needs-validation"
      novalidate
    >
      {% set license_form_config = { "ids": { "license_name": "licenseAdi",
      "license_key": "licenseKey", "responsible": "licenseSorumlu", "inventory":
      "selBagliEnvanter", "ifs": "licenseIfs", "email": "licenseMail", },
      "names": { "license_name": "adi", "license_key": "anahtar", "responsible":
      "sorumlu_personel", "inventory": "inventory_id", "ifs": "ifs_no", "email":
      "mail_adresi", }, "values": { "license_name": license.lisans_adi if
      license else "", "license_key": license.anahtar if license else "",
      "responsible": license.sorumlu_personel if license else "", "inventory":
      license.inventory_id if license else "", "ifs": license.ifs_no if license
      else "", "email": license.mail_adresi if license else "", }, "required":
      ["license_name"], "labels": { "inventory": "Bağlı Olduğu Envanter No", },
      "license_placeholder": "Seçiniz...", "inventory_empty_label":
      "(Seçimsiz)", } %} {% include "partials/license_form_fields.html" %}

      <div class="row g-3 mt-1">
        <div class="col-12 d-flex justify-content-end gap-2">
          <button class="btn btn-primary" type="submit">Kaydet</button>
          {% if not modal %}
          <a
            class="btn btn-outline-secondary"
            href="{{ url_for('license_list') }}"
            >İptal</a
          >
          {% endif %}
        </div>
      </div>
    </form>
  </div>
</div>
{% endif %} {% endblock %} {% block scripts %} {{ super() }}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    if (window.Choices) {
      new Choices("#selBagliEnvanter", {
        searchEnabled: true,
        itemSelectText: "",
      });
    }
  });

  const licenseModalEl = document.querySelector(".license-edit-modal");
  if (licenseModalEl) {
    const applyModalOpen = () => document.body.classList.add("modal-open");
    const removeModalOpen = () => document.body.classList.remove("modal-open");
    const isEmbedded = window.self !== window.top;

    applyModalOpen();
    window.addEventListener("beforeunload", removeModalOpen);

    const dialogContent = licenseModalEl.querySelector(".modal-content");
    if (dialogContent) {
      try {
        dialogContent.focus({ preventScroll: true });
      } catch (err) {
        dialogContent.focus();
      }
    }

    const fallbackUrl = "/lisans/{{ license.id if license else '' }}";
    const hasUsableHistory = () => {
      if (!document.referrer) return false;
      try {
        const ref = new URL(document.referrer);
        return ref.origin === window.location.origin;
      } catch (err) {
        return false;
      }
    };

    let closing = false;
    const closeDialog = (event) => {
      if (closing) return;
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }
      closing = true;
      removeModalOpen();

      if (isEmbedded) {
        try {
          window.parent.postMessage("modal-close", "*");
        } catch (err) {}
        return;
      }

      if (window.history.length > 1 && hasUsableHistory()) {
        window.history.back();
        window.setTimeout(() => {
          if (!document.hidden && fallbackUrl) {
            window.location.href = fallbackUrl;
          }
        }, 300);
      } else if (fallbackUrl) {
        window.location.href = fallbackUrl;
      }
    };

    licenseModalEl
      .querySelectorAll("[data-license-edit-close]")
      .forEach((trigger) => {
        trigger.addEventListener("click", closeDialog);
      });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        closeDialog(event);
      }
    });
  }
</script>
{% endblock %}
