<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="{{ url_for('static', path='css/custom.css') }}" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet">
  <title>{% block title %}{% endblock %}</title>
</head>
<body class="bg-app">
  <nav class="navbar navbar-light bg-transparent p-3 pb-0">
    <div class="container-fluid">
      <a class="navbar-brand fw-semibold"></a>
      {% if request.session.get('user_id') %}
      <div class="d-flex align-items-center gap-2">
        <span class="small text-muted d-none d-md-inline">{{ request.session.get('user_name') }}</span>
        <a class="btn btn-outline-dark btn-sm" href="/logout">Çıkış</a>
      </div>
      {% endif %}
    </div>
  </nav>

    <div class="container-fluid p-3">
      <div class="row g-3">
        {% if request.session.get('user_id') %}
        <!-- Sol bloklar -->
        <aside class="col-12 col-lg-2">
          <div class="side-group soft-card p-3 mb-3">
            <a class="side-link" href="/">Ana Sayfa</a>
          </div>
          <div class="side-group soft-card p-3 mb-3">
            <div class="side-title">ENVANTER</div>
            <a class="side-link" href="/inventory">Envanter Takip</a>
            <a class="side-link" href="/lisans">Lisans Takip</a>
            <a class="side-link" href="/printers">Yazıcı Takip</a>
            <a class="side-link" href="/stock">Stok Takip</a>
        </div>
        <div class="side-group soft-card p-3 mb-3">
          <div class="side-title">İŞLEMLER</div>
          <a class="side-link" href="/requests">Talep Takip</a>
          <a class="side-link" href="{{ url_for('inventory.hurdalar') }}">Hurdalar</a>
        </div>
        <div class="side-group soft-card p-3">
          <div class="side-title">AYARLAR</div>
          <a class="side-link" href="/profile">Profil</a>
          {% if request.session.get('user_role') == 'admin' %}
          <a class="side-link" href="/admin">Admin Paneli</a>
          <a class="side-link" href="/logs">Kayıtlar</a>
          {% endif %}
        </div>
      </aside>
      <main class="col-12 col-lg-10">
      {% else %}
      <main class="col-12">
      {% endif %}
        {% block content %}{% endblock %}
      </main>
      </div>
    </div>

    <!-- picker modal -->
    <div id="pickerModal" class="modal" tabindex="-1" style="display:none;">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="pickerTitle" class="modal-title"></h5>
            <button type="button" class="btn-close" data-close></button>
          </div>
          <div class="modal-body">
            <input id="pickerSearch" class="form-control mb-2" placeholder="Ara...">
            <div id="pickerList" class="list-group"></div>
          </div>
          <div class="modal-footer">
            <input id="pickerNewName" class="form-control" placeholder="Yeni ad...">
            <button id="pickerAddBtn" class="btn btn-success">Yeni ekle</button>
            <button class="btn btn-secondary" data-close>Kapat</button>
          </div>
        </div>
      </div>
    </div>

    <!-- iframe modal -->
    <div class="modal fade" id="iframeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="iframeModalTitle"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body p-0">
            <iframe id="iframeModalFrame" style="width:100%;height:70vh;border:0;"></iframe>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="{{ url_for('static', path='js/picker.js') }}"></script>
    <script defer src="/static/js/selects.js"></script>
    <script src="{{ url_for('static', path='js/actions.js') }}"></script>
  {% block scripts %}
  <script>
document.addEventListener("DOMContentLoaded", () => {
  if (window.self !== window.top) {
    const aside = document.querySelector("aside");
    const main = document.querySelector("main");
    if (aside) aside.remove();
    if (main) main.classList.remove("col-lg-10");
  }

  // Event delegation: works for dynamically added rows
  document.body.addEventListener("click", (e) => {
    const row = e.target.closest("tr[data-href]");
    if (!row) return;

    // Prevent navigation when clicking on interactive elements
    const interactive = e.target.closest("a, button, input, label, select, textarea");
    if (interactive) return;

    const url = row.dataset.href;
    if (!url) return;

    // Ctrl/Cmd open in new tab
    if (e.metaKey || e.ctrlKey) {
      window.open(url, "_blank");
    } else {
      window.location.href = url;
    }
  });

  // Keyboard accessibility
  document.querySelectorAll("tr[data-href]").forEach(tr => {
    tr.tabIndex = 0;
    tr.setAttribute("role", "link");
    tr.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        const url = tr.dataset.href;
        if (!url) return;
        if (e.ctrlKey || e.metaKey) {
          window.open(url, "_blank");
        } else {
          window.location.href = url;
        }
      }
    });
  });
});

// Use this for interactive elements inside rows
function stopRowClick(e) { e.stopPropagation(); }

function openModal(url, title="") {
  const frame = document.getElementById("iframeModalFrame");
  frame.src = url;
  document.getElementById("iframeModalTitle").textContent = title;
  const modal = new bootstrap.Modal(document.getElementById("iframeModal"));
  modal.show();
}
window.openModal = openModal;

document.addEventListener("click", (e) => {
  const link = e.target.closest("[data-modal-url]");
  if (!link) return;
  e.preventDefault();
  openModal(link.dataset.modalUrl, link.dataset.modalTitle || "");
});

window.addEventListener("message", (e) => {
  if (e.data === "modal-close") {
    const modalEl = document.getElementById("iframeModal");
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();
    window.location.reload();
  }
});
    </script>

    <style>
    tr[data-href] { cursor: pointer; }
    tr[data-href]:hover { background-color: #f8f9fa; }
    @media (hover:hover) {
      tr[data-href]:hover > td { transition: background-color .12s ease-in-out; }
    }
    </style>
    {% endblock %}
  </body>
  </html>
