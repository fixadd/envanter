<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="api-root" content="/api">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="{{ url_for('static', path='css/custom.css') }}" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet">
  <style>
    html, body {
      height:100%;
    }
    body {
      margin: 0;
    }
    nav.navbar, .container-fluid { position:relative; }
    nav.navbar { z-index:1; }
  </style>
  <title>{% block title %}{% endblock %}</title>
  <style>
/* SEKME + TABLO BİRLEŞTİRME — ÇAKIŞMA KESİN DÜZELTME */
.tabs-wrap .nav.nav-tabs,
.tabs-wrap .nav.nav-pills { border-bottom: 0 !important; gap: .25rem; }

/* Tüm sekmeler (tabs/pills) aynı görünüm */
.tabs-wrap .nav .nav-link{
  border: 1px solid #dee2e6 !important;
  border-bottom: 0 !important;
  background: #f3f4f6 !important;
  color: #444 !important;
  text-decoration: none !important;
  border-radius: .9rem .9rem 0 0 !important; /* pill değil, sekme */
  padding: .5rem .9rem !important;
  margin-bottom: 0 !important;
  line-height: 1.2 !important;
}
.tabs-wrap .nav .nav-link:hover{ background:#e9ecef !important; color:#222 !important; }

/* Aktif sekme: alt sınırı kes ve üstte kalsın */
.tabs-wrap .nav .nav-link.active{
  background:#fff !important; color:#111 !important;
  position: relative !important; z-index: 2 !important;
  border-color:#dee2e6 #dee2e6 #fff !important;
}

/* Sekme altı kutu */
.page-section{
  background:#fff !important; border:1px solid #dee2e6 !important;
  border-radius:0 .9rem .9rem .9rem !important;
  padding:1rem !important; margin-top:-1px !important;
}

/* Bootstrap tablo iyileştirme */
.page-section .table{ margin-bottom:0 !important; }
.page-section .table td, .page-section .table th{ vertical-align:middle !important; }
.page-section .table thead th{ white-space:nowrap !important; }
.page-section .table-responsive{ overflow-x:auto !important; overflow-y:visible !important; }

/* Olası global pill stili/tema müdahalesini sıfırla */
.tabs-wrap .nav .nav-link{ box-shadow:none !important; }
  </style>
</head>
<body class="theme-{{ request.session.get('user_theme', 'default') }} anim-{{ request.session.get('user_anim', 'none') }}">
  <nav class="navbar navbar-light bg-transparent p-3 pb-0">
    <div class="container-fluid">
      <a class="navbar-brand fw-semibold"></a>
      {% if request.session.get('user_id') %}
      <div class="d-flex align-items-center gap-2">
        <span class="small text-muted d-none d-md-inline">{{ request.session.get('user_name') }}</span>
        <a class="btn btn-outline-dark btn-sm" href="/logout">Çıkış</a>
      </div>
      {% endif %}
    </div>
  </nav>

    <div class="container-fluid p-3">
      {% if request.session.get('user_id') %}
      <div class="app-shell">
        <aside class="app-sidebar stack-sm">
          <div class="side-group soft-card p-3 stack-sm">
            <a class="side-link" href="/dashboard">
              <i class="bi bi-speedometer2"></i>
              <span>Ana Sayfa</span>
            </a>
          </div>
          <div class="side-group soft-card p-3 stack-sm">
            <div class="side-title">ENVANTER</div>
            <a class="side-link" href="/inventory">
              <i class="bi bi-hdd-stack"></i>
              <span>Envanter Takip</span>
            </a>
            <a class="side-link" href="/lisans">
              <i class="bi bi-key"></i>
              <span>Lisans Takip</span>
            </a>
            <a class="side-link" href="/printers">
              <i class="bi bi-printer"></i>
              <span>Yazıcı Takip</span>
            </a>
            <a class="side-link" href="/stock">
              <i class="bi bi-box-seam"></i>
              <span>Stok Takip</span>
            </a>
          </div>
          <div class="side-group soft-card p-3 stack-sm">
            <div class="side-title">İŞLEMLER</div>
            <a class="side-link" href="/talepler">
              <i class="bi bi-inboxes"></i>
              <span>Talep Takip</span>
            </a>
            <a class="side-link" href="{{ url_for('inventory.hurdalar') }}">
              <i class="bi bi-recycle"></i>
              <span>Hurdalar</span>
            </a>
          </div>
          <div class="side-group soft-card p-3 stack-sm">
            <div class="side-title">AYARLAR</div>
            <a class="side-link" href="/profile">
              <i class="bi bi-person-circle"></i>
              <span>Profil</span>
            </a>
            {% if request.session.get('user_role') == 'admin' %}
            <a class="side-link" href="/admin">
              <i class="bi bi-gear-wide-connected"></i>
              <span>Admin Paneli</span>
            </a>
            <a class="side-link" href="/logs">
              <i class="bi bi-clock-history"></i>
              <span>Kayıtlar</span>
            </a>
            {% endif %}
          </div>
        </aside>
        <main class="app-main">
      {% else %}
        <main class="app-main">
      {% endif %}
          {% block content %}{% endblock %}
        </main>
      {% if request.session.get('user_id') %}
      </div>
      {% endif %}
    </div>

    <!-- picker modal -->
    <div id="pickerModal" class="modal" tabindex="-1" style="display:none;">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="pickerTitle" class="modal-title"></h5>
            <button type="button" class="btn-close" data-close></button>
          </div>
          <div class="modal-body">
            <input id="pickerSearch" class="form-control mb-2" placeholder="Ara...">
            <div id="pickerList" class="list-group"></div>
          </div>
          <div class="modal-footer">
            <input id="pickerNewName" class="form-control" placeholder="Yeni ad...">
            <button id="pickerAddBtn" class="btn btn-success">Yeni ekle</button>
            <button class="btn btn-secondary" data-close>Kapat</button>
          </div>
        </div>
      </div>
    </div>

    <!-- iframe modal -->
    <div class="modal fade" id="iframeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="iframeModalTitle"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body p-0">
            <iframe id="iframeModalFrame" style="width:100%;height:70vh;border:0;"></iframe>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="{{ url_for('static', path='js/picker.js') }}"></script>
    <script defer src="/static/js/selects.js"></script>
    <script src="{{ url_for('static', path='js/actions.js') }}"></script>
  {% block scripts %}
  <script>
document.addEventListener("DOMContentLoaded", () => {
  if (window.self !== window.top) {
    const aside = document.querySelector("aside");
    const main = document.querySelector("main");
    const nav = document.querySelector("nav.navbar");
    if (aside) aside.remove();
    if (nav) nav.remove();
    if (main) main.classList.remove("col-lg-10");
  }

  // Event delegation: works for dynamically added rows
  document.body.addEventListener("click", (e) => {
    const row = e.target.closest("tr[data-href]");
    if (!row) return;

    // Prevent navigation when clicking on interactive elements
    const interactive = e.target.closest("a, button, input, label, select, textarea");
    if (interactive) return;

    const url = row.dataset.href;
    if (!url) return;

    // Ctrl/Cmd open in new tab
    if (e.metaKey || e.ctrlKey) {
      window.open(url, "_blank");
    } else {
      window.location.href = url;
    }
  });

  // Keyboard accessibility
  document.querySelectorAll("tr[data-href]").forEach(tr => {
    tr.tabIndex = 0;
    tr.setAttribute("role", "link");
    tr.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        const url = tr.dataset.href;
        if (!url) return;
        if (e.ctrlKey || e.metaKey) {
          window.open(url, "_blank");
        } else {
          window.location.href = url;
        }
      }
    });
  });
});

// Use this for interactive elements inside rows
function stopRowClick(e) { e.stopPropagation(); }

function openModal(url, title="") {
  const frame = document.getElementById("iframeModalFrame");
  frame.src = url;
  document.getElementById("iframeModalTitle").textContent = title;
  const modal = new bootstrap.Modal(document.getElementById("iframeModal"));
  modal.show();
}
window.openModal = openModal;

document.addEventListener("click", (e) => {
  const link = e.target.closest("[data-modal-url]");
  if (!link) return;
  e.preventDefault();
  openModal(link.dataset.modalUrl, link.dataset.modalTitle || "");
});

window.addEventListener("message", (e) => {
  if (e.data === "modal-close") {
    const modalEl = document.getElementById("iframeModal");
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();
    window.location.reload();
  }
});
    </script>

    <style>
    tr[data-href] { cursor: pointer; }
    tr[data-href]:hover { background-color: #f8f9fa; }
    @media (hover:hover) {
      tr[data-href]:hover > td { transition: background-color .12s ease-in-out; }
    }
    </style>
    {% endblock %}
    <canvas id="bg"></canvas>

    <style>
      body { margin:0; }
      body.theme-default {
        background: linear-gradient(180deg,#dbeafe,#bfdbfe);
      }
      body.theme-dark {
        background:#1f1f1f;
        color:#f8f9fa;
      }
      body.theme-dark .soft-card,
      body.theme-dark .card { background:#2c2c2c; }
      body.theme-dark .side-link { color:#f8f9fa; }
      body.theme-dark .side-link:hover { background:#3a3a3a; }
      body.theme-green {
        background: linear-gradient(180deg,#e8f5e9,#a5d6a7);
      }
      body.theme-red {
        background: linear-gradient(180deg,#ffebee,#ffcdd2);
      }
      body.theme-purple {
        background: linear-gradient(180deg,#f3e5f5,#d1c4e9);
      }
      body.anim-gradient {
        background-size:400% 400%;
        animation: gradientMove 15s ease infinite;
      }
      @keyframes gradientMove {
        0% {background-position:0% 50%;}
        50% {background-position:100% 50%;}
        100% {background-position:0% 50%;}
      }
      body:not(.anim-particles) #bg { display:none; }
      #bg {
        position:fixed;
        inset:0;
        z-index:-1;
        pointer-events:none;
      }
    </style>

    <script>
    if (document.body.classList.contains("anim-particles")) {
      const canvas=document.getElementById("bg"),ctx=canvas.getContext("2d");
      let w,h;
      function resize(){
        w=canvas.width=innerWidth;
        h=canvas.height=innerHeight;
      }
      window.addEventListener("resize",resize);
      resize();

      // parçacıklar
      let particles=[];
      for(let i=0;i<80;i++){ // nokta sayısı
        particles.push({
          x:Math.random()*w,
          y:Math.random()*h,
          vx:(Math.random()-.5)*0.3,  // x hızı
          vy:(Math.random()-.5)*0.3   // y hızı
        });
      }

      function draw(){
        ctx.clearRect(0,0,w,h);

        // noktalar
        for(let p of particles){
          p.x+=p.vx; p.y+=p.vy;
          if(p.x<0||p.x>w) p.vx*=-1;
          if(p.y<0||p.y>h) p.vy*=-1;

          ctx.beginPath();
          ctx.arc(p.x,p.y,2,0,Math.PI*2);
          ctx.fillStyle="rgba(0,120,255,0.7)";
          ctx.fill();
        }

        // çizgiler
        for(let i=0;i<particles.length;i++){
          for(let j=i+1;j<particles.length;j++){
            let dx=particles[i].x-particles[j].x;
            let dy=particles[i].y-particles[j].y;
            let dist=Math.sqrt(dx*dx+dy*dy);
            if(dist<140){ // mesafe limit
              ctx.strokeStyle="rgba(0,120,255,"+(1-dist/140)*0.4+")";
              ctx.beginPath();
              ctx.moveTo(particles[i].x,particles[i].y);
              ctx.lineTo(particles[j].x,particles[j].y);
              ctx.stroke();
            }
          }
        }

        requestAnimationFrame(draw);
      }
      draw();
    }
    </script>
    <script>
(function () {
  // ---- API kökünü tespit et (meta varsa onu kullan, yoksa mantıklı varsayılan) ----
  const META_API = document.querySelector('meta[name="api-root"]')?.content;
  const API_ROOT = (META_API && META_API.replace(/\/$/, '')) || '/api';

  // ---- Lookup cache + güvenli fetch ----
  const Cache = new Map();
  async function fetchLookup(entity, params = {}) {
    const key = entity + '::' + JSON.stringify(params);
    if (Cache.has(key)) return Cache.get(key);

    const url = new URL(`${API_ROOT}/lookup/${encodeURIComponent(entity)}`, window.location.origin);
    Object.entries(params).forEach(([k, v]) => (v != null && v !== '') && url.searchParams.set(k, v));

    const res = await fetch(url.toString(), { credentials: 'same-origin' });
    const ct = res.headers.get('content-type') || '';
    // Login'e yönlendirme / HTML dönerse yakala
    if (!res.ok || !ct.includes('application/json')) {
      console.error('[lookup] Hatalı cevap:', res.status, ct);
      const text = await res.text().catch(() => '');
      if (text.includes('<form') && text.toLowerCase().includes('login')) {
        console.warn('[lookup] Muhtemel oturum/redirect. Sayfada giriş/çerez kontrol et.');
      }
      Cache.set(key, []); return [];
    }
    const data = await res.json().catch(() => []);
    Cache.set(key, Array.isArray(data) ? data : []);
    return Cache.get(key);
  }

  // ---- Select eklentileri için evrensel doldurucu ----
  function fillSelect(el, items) {
    if (!el) return;

    // Native temizle
    el.innerHTML = '';
    const first = document.createElement('option');
    first.value = ''; first.textContent = 'Seçiniz…';
    el.appendChild(first);

    const list = (items || []).map(v => {
      if (v && typeof v === 'object') {
        return { id: v.id ?? '', text: v.name ?? v.ad ?? v.text ?? v.value ?? '' };
      }
      return { id: '', text: v };
    });

    for (const v of list) {
      const opt = document.createElement('option');
      opt.value = v.text;
      opt.textContent = v.text;
      if (v.id) opt.dataset.id = v.id;
      el.appendChild(opt);
    }

    // jQuery + Bootstrap-select
    if (window.jQuery) {
      const $el = jQuery(el);
      if ($el.hasClass('selectpicker') && jQuery.fn.selectpicker) $el.selectpicker('refresh');

      // Select2
      if (jQuery.fn.select2) {
        if ($el.data('select2')) { $el.trigger('change.select2'); }
        else { $el.select2({ width: '100%', language: { noResults: ()=>'Seçenek yok', searching:()=> 'Aranıyor…' } }); }
      }
    }

    // TomSelect
    if (el.tomselect) {
      el.tomselect.clearOptions();
      el.tomselect.addOptions(list.map(v => ({ value: v.text, text: v.text })));
    }

    // Choices.js
    if (window.Choices && el.classList.contains('choices')) {
      if (el._choices && el._choices.destroy) el._choices.destroy();
      el._choices = new Choices(el, { searchEnabled: true, itemSelectText: '' });
      el._choices.setChoices(list.map(v => ({ value: v.text, label: v.text })), 'value', 'label', true);
    }
  }

  // ---- Tek satırı initialize et ----
  async function initRow(container, rowEl) {
    const donanim = rowEl.querySelector('select[data-lookup="donanim_tipi"]');
    const marka   = rowEl.querySelector('select[data-lookup="marka"]');
    const model   = rowEl.querySelector('select[data-lookup="model"]');

    if (donanim) fillSelect(donanim, await fetchLookup('donanim_tipi'));
    if (marka)   fillSelect(marka,   await fetchLookup('marka'));

    // model marka'ya bağımlıysa
    if (model) {
      const depSel = model.getAttribute('data-depends');
      const depEl  = depSel ? (rowEl.querySelector(depSel) || container.querySelector(depSel) || document.querySelector(depSel)) : marka;
      fillSelect(model, []); // başta boş
      if (depEl) {
        depEl.addEventListener('change', async () => {
          const m = depEl.value || '';
          const list = await fetchLookup('model', m ? { marka: m } : {});
          fillSelect(model, list);
        }, { passive: true });
      } else {
        // Bağımlı yoksa tüm modeller
        fillSelect(model, await fetchLookup('model'));
      }
    }
  }

  // ---- Bir konteyner içindeki tüm satırları kur ----
  async function initContainer(container) {
    const rows = container.querySelectorAll('.talep-row, .stok-row');
    if (rows.length) {
      for (const r of rows) await initRow(container, r);
      return;
    }
    // Eğer tek satırlık formsa
    await initRow(container, container);
  }

  // ---- Modal açıldığında doldur ----
  document.addEventListener('shown.bs.modal', (ev) => {
    const modal = ev.target;
    initContainer(modal);
  });

  // ---- Sonradan eklenen satırları yakala ----
  const mo = new MutationObserver((muts) => {
    for (const m of muts) {
      m.addedNodes.forEach(n => {
        if (n.nodeType !== 1) return;
        if (n.matches?.('.talep-row, .stok-row, .modal')) initContainer(n);
        const inner = n.querySelector?.('select[data-lookup]');
        if (inner) initContainer(n.closest('.modal') || document);
      });
    }
  });
  mo.observe(document.body, { childList: true, subtree: true });
})();
    </script>
  </body>
  </html>
