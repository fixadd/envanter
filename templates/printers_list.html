{% extends "base.html" %} {% block title %}Yazıcı Takip{% endblock %} {% block
content %}
<div class="container-fluid py-4">
  <div class="page-shell">
    <header class="page-header">
      <div class="page-header__heading">
        <span class="eyebrow text-primary">YAZICI TAKİP</span>
        <h1 class="page-header__title">Yazıcılar</h1>
        <p class="page-header__subtitle">
          Yazıcı envanterini görüntüleyin ve yönetin.
        </p>
      </div>
      <div class="page-header__actions page-actions">
        <div class="page-actions__group">
          <a
            href="#"
            class="btn btn-success btn-sm"
            title="Yeni Ekle"
            data-bs-toggle="modal"
            data-bs-target="#addModal"
          >
            <i class="bi bi-plus-lg"></i>
            <span>Ekle</span>
          </a>
          {% with fault_entity='printer', fault_prefix='printer',
          fault_label='Yazıcı Arızalı Durum' %} {% include
          'partials/_fault_controls.html' %} {% endwith %}
          <div class="dropdown">
            <button
              class="btn btn-outline-primary btn-sm dropdown-toggle"
              type="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              Excel
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <a class="dropdown-item" href="/printers/export">Dışa Aktar</a>
              </li>
              <li>
                <form
                  action="/printers/import"
                  method="post"
                  enctype="multipart/form-data"
                >
                  <input
                    type="file"
                    name="file"
                    id="printerExcel"
                    class="d-none"
                    onchange="this.form.submit()"
                  />
                  <label for="printerExcel" class="dropdown-item mb-0"
                    >İçe Aktar</label
                  >
                </form>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </header>

    <div class="filter-search-bar">
      <div class="filter-search-bar__row">
        <div class="filter-search-bar__main">
          <div class="search-wrapper">
            <i class="bi bi-search"></i>
            <input
              type="text"
              id="searchInput"
              class="form-control form-control-sm"
              placeholder="Yazıcı ara..."
            />
          </div>
          <div class="filter-group">
            <label for="markaFilter">Marka:</label>
            <select id="markaFilter" class="form-select form-select-sm">
              <option value="">Tümü</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="fabrikaFilter">Fabrika:</label>
            <select id="fabrikaFilter" class="form-select form-select-sm">
              <option value="">Tümü</option>
            </select>
          </div>
        </div>
        <div class="filter-search-bar__actions">
          <button class="btn btn-primary btn-sm" id="filterBtn">
            <i class="bi bi-funnel"></i>
            Filtrele
          </button>
          <button
            class="btn btn-outline-secondary btn-sm d-none"
            id="clearFilterBtn"
          >
            <i class="bi bi-x-circle"></i>
            Temizle
          </button>
        </div>
      </div>
      <div class="active-filters-section d-none" id="activeFiltersSection">
        <div class="active-filters">
          <span class="active-filters__label">Aktif Filtreler:</span>
          <div id="activeFilterBadges"></div>
        </div>
      </div>
    </div>

    <div class="page-card">
      <div class="table-responsive">
        <table
          id="printersTable"
          class="table table-sm table-hover table-rounded align-middle mb-0"
        >
          <thead>
            <tr>
              <th data-field="id">ID</th>
              <th data-field="marka">Marka</th>
              <th data-field="model">Model</th>
              <th data-field="seri_no">Seri No</th>
              <th data-field="fabrika">Fabrika</th>
              <th data-field="kullanim_alani">Kullanım Alanı</th>
              <th data-field="sorumlu_personel">Sorumlu</th>
              <th data-field="bagli_envanter_no">Bağlı Env.</th>
              <th data-field="durum">Durum</th>
              <th style="width: 220px">İşlemler</th>
            </tr>
          </thead>
          <tbody>
            {% for p in printers %}
            <tr
              data-id="{{ p.id }}"
              data-label="{{ p.hostname or p.envanter_no or ('Yazıcı #' ~ p.id) }}"
              data-fabrika="{{ p.fabrika or '' }}"
              data-kullanim="{{ p.kullanim_alani or '' }}"
              data-personel="{{ p.sorumlu_personel or '' }}"
              data-bagli="{{ p.bagli_envanter_no or '' }}"
              {% if p.durum == 'arızalı' %}class="table-warning"{% endif %}
            >
              <td>#{{ p.id }}</td>
              <td>{{ p.marka or '-' }}</td>
              <td>{{ p.model or '-' }}</td>
              <td>{{ p.seri_no or '-' }}</td>
              <td>{{ p.fabrika or '-' }}</td>
              <td>{{ p.kullanim_alani or '-' }}</td>
              <td>{{ p.sorumlu_personel or '-' }}</td>
              <td>{{ p.bagli_envanter_no or '-' }}</td>
              <td>
                {% if p.durum == 'hurda' %}
                <span class="badge text-bg-secondary">Hurda</span>
                {% elif p.durum == 'arızalı' %}
                <span class="badge text-bg-warning text-dark">Arızalı</span>
                {% else %}
                <span class="badge text-bg-success">Aktif</span>
                {% endif %}
              </td>
              <td class="text-nowrap">
                {% set entity = 'printers' %} {% set row_id = p.id %} {% set
                fault_mode = True %} {% set fault_device = p.envanter_no or
                ('Yazıcı #' ~ p.id) %} {% set fault_title = (p.marka ~ ' ' ~
                p.model)|trim %} {% set fault_entity_key = p.envanter_no or p.id
                %} {% set fault_status = p.durum %} {% with edit_modal_size='md'
                %} {% include 'partials/_actions_menu.html' %} {% endwith %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Yeni Ekle Modal -->
<div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
  <div
    class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"
  >
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Yazıcı Ekle</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Kapat"
        ></button>
      </div>

      <div class="modal-body">
        <form
          method="post"
          action="/printers/create"
          id="printerAddForm"
          novalidate
        >
          <div class="env-grid" id="printer-ekle">
            <div class="field">
              <label for="printerEnvanter">Envanter No</label>
              <input
                id="printerEnvanter"
                name="envanter_no"
                type="text"
                class="ctrl"
                required
                placeholder="ENV-000123"
              />
            </div>

            <div class="field">
              <label for="selYaziciMarka">Yazıcı Markası</label>
              <select
                id="selYaziciMarka"
                name="yazici_markasi"
                class="ctrl"
                required
              >
                <option value="">Seçiniz...</option>
                {% for m in marka_list %}
                <option value="{{ m.name }}">{{ m.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="field">
              <label for="selYaziciModel">Yazıcı Modeli</label>
              <select
                id="selYaziciModel"
                name="yazici_modeli"
                class="ctrl"
                required
                disabled
              >
                <option value="">Önce marka seçiniz...</option>
              </select>
              <small class="help-text"
                >Not: Model listesi seçilen markaya göre filtrelenir.</small
              >
            </div>

            <div class="field">
              <label for="printerUsage">Kullanım Alanı</label>
              <select
                id="printerUsage"
                name="kullanim_alani"
                class="ctrl"
                required
              >
                <option value="">Seçiniz...</option>
                {% for k in kullanim_alanlari %}
                <option value="{{ k.name }}">{{ k.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="field">
              <label for="printerIp">IP Adresi</label>
              <input
                id="printerIp"
                name="ip_adresi"
                type="text"
                class="ctrl"
                required
                placeholder="10.0.0.10"
              />
            </div>

            <div class="field">
              <label for="printerMac">MAC</label>
              <input
                id="printerMac"
                name="mac"
                type="text"
                class="ctrl"
                required
                placeholder="AA:BB:CC:DD:EE:FF"
              />
            </div>

            <div class="field">
              <label for="printerHostname">Hostname</label>
              <input
                id="printerHostname"
                name="hostname"
                type="text"
                class="ctrl"
                required
                placeholder="PRN-OFIS-01"
              />
            </div>

            <div class="field">
              <label for="printerIfs">
                IFS No <span class="help-text">(opsiyonel)</span>
              </label>
              <input
                id="printerIfs"
                name="ifs_no"
                type="text"
                class="ctrl"
                placeholder="IFS numarası"
              />
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          İptal
        </button>
        <button type="submit" form="printerAddForm" class="btn btn-primary">
          Kaydet
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  window.SKIP_SELECT_ENHANCE = true;
</script>

<!-- ATAMA MODAL -->
<div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <form class="modal-content border-0 bg-transparent p-0" id="assignForm">
      <div class="modal-shell">
        <div class="modal-shell__header">
          <div class="modal-shell__heading">
            <h5 class="modal-shell__title">
              Yazıcıyı Ata — <span id="assignPrinterLabel"></span>
            </h5>
            <p class="modal-shell__subtitle">
              Yazıcı için fabrika, kullanım alanı ve sorumlu bilgilerini
              güncelleyin.
            </p>
          </div>
          <div class="modal-shell__header-actions">
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Kapat"
            ></button>
          </div>
        </div>

        <div class="modal-shell__body">
          <input type="hidden" id="assignPrinterId" name="printer_id" />

          <div class="row g-3">
            <div class="col-md-6">
              <label for="selFabrika" class="form-label">Fabrika</label>
              <select id="selFabrika" name="fabrika" class="form-select">
                <option value="">Seçiniz</option>
                {% for f in factories %}
                <option value="{{ f }}">{{ f }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label for="selKullanim" class="form-label">Kullanım Alanı</label>
              <select id="selKullanim" name="kullanim_alani" class="form-select">
                <option value="">Seçiniz</option>
                {% for a in areas %}
                <option value="{{ a }}">{{ a }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label for="selPersonel" class="form-label">Sorumlu Personel</label>
              <select id="selPersonel" name="sorumlu_personel" class="form-select">
                <option value="">Seçiniz</option>
                {% for u in users %}
                <option value="{{ u }}">{{ u }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label for="selBagliEnv" class="form-label">Bağlı Olduğu Envanter</label>
              <select id="selBagliEnv" name="bagli_envanter_no" class="form-select">
                <option value="">Seçiniz</option>
                {% for inv in inventory_nos %}
                <option value="{{ inv }}">{{ inv }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>

        <div class="modal-shell__footer">
          <div class="modal-shell__actions">
            <button
              class="btn btn-outline-secondary"
              type="button"
              data-bs-dismiss="modal"
            >
              İptal
            </button>
            <button class="btn btn-success" type="submit">
              Atamayı Kaydet
            </button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- HURDA MODAL -->
<div class="modal fade" id="scrapModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="scrapForm" class="modal-content border-0 bg-transparent p-0">
      <div class="modal-shell">
        <div class="modal-shell__header">
          <div class="modal-shell__heading">
            <h5 class="modal-shell__title">Hurdaya Ayır</h5>
            <p class="modal-shell__subtitle">
              Yazıcı hurdaya ayrılmadan önce kısa bir açıklama ekleyin.
            </p>
          </div>
          <div class="modal-shell__header-actions">
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Kapat"
            ></button>
          </div>
        </div>

        <div class="modal-shell__body">
          <input type="hidden" id="scrapPrinterId" />
          <p class="mb-2">Bu envanter hurdaya ayrılacak. Onaylıyor musunuz?</p>
          <div class="modal-form-grid">
            <div class="modal-form-grid--full mb-3">
              <label class="form-label" for="scrapReason"
                >Açıklama (opsiyonel)</label
              >
              <textarea
                id="scrapReason"
                name="reason"
                class="form-control"
                rows="3"
                placeholder="Hurda sebebi / not"
              ></textarea>
            </div>
          </div>
        </div>

        <div class="modal-shell__footer">
          <div class="modal-shell__actions">
            <button
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
              type="button"
            >
              Vazgeç
            </button>
            <button class="btn btn-danger" type="submit">Hurdaya Ayır</button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %} {% block scripts %} {{ super() }}
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", async () => {
    await populateDistinctValues("markaFilter", "printer", "marka");
    await populateDistinctValues("fabrikaFilter", "printer", "fabrika");

    const filterSystem = new UnifiedFilterSystem({
      tableSelector: "#printersTable",
      searchInputId: "searchInput",
      filters: [
        { id: "markaFilter", label: "Marka", columnField: "marka" },
        { id: "fabrikaFilter", label: "Fabrika", columnField: "fabrika" },
      ],
    });
    window.filterSystem = filterSystem;

    const markaSel = document.getElementById("selYaziciMarka");
    const modelSel = document.getElementById("selYaziciModel");
    if (markaSel && modelSel) {
      if (window.Choices) {
        new Choices(markaSel, { searchEnabled: true, shouldSort: false });
        new Choices(modelSel, { searchEnabled: true, shouldSort: false });
      }
      const loadModels = async () => {
        const marka = markaSel.value;
        modelSel.innerHTML = '<option value="">Seçiniz...</option>';
        modelSel.disabled = !marka;
        if (!marka) return;
        try {
          const resp = await fetch(
            `/api/printers/models?brand=${encodeURIComponent(marka)}`,
          );
          if (resp.ok) {
            const data = await resp.json();
            data.forEach((m) => {
              const opt = document.createElement("option");
              opt.value = m;
              opt.textContent = m;
              modelSel.appendChild(opt);
            });
          }
        } catch (e) {
          console.error(e);
        }
      };
      markaSel.addEventListener("change", loadModels);
      loadModels();
    }

    // Atama/Hurda işlemleri
    const assignModalEl = document.getElementById("assignModal");
    const assignModal = assignModalEl
      ? bootstrap.Modal.getOrCreateInstance(assignModalEl)
      : null;
    const assignForm = document.getElementById("assignForm");
    const scrapModalEl = document.getElementById("scrapModal");
    const scrapModal = scrapModalEl
      ? bootstrap.Modal.getOrCreateInstance(scrapModalEl)
      : null;
    const scrapForm = document.getElementById("scrapForm");
    const selFabrika = document.getElementById("selFabrika");
    const selKullanim = document.getElementById("selKullanim");
    const selPersonel = document.getElementById("selPersonel");
    const selBagliEnv = document.getElementById("selBagliEnv");

    let fabrikaChoices;
    let kullanimChoices;
    let personelChoices;
    let bagliEnvChoices;

    document.querySelectorAll(".action-select").forEach((sel) => {
      sel.addEventListener("change", (e) => {
        const val = e.target.value;
        if (!val) return;
        const tr = e.target.closest("tr");
        const printerId = tr?.dataset.id;
        if (!printerId) return;

        if (val === "assign") {
          e.stopImmediatePropagation();
          document.getElementById("assignPrinterId").value = printerId;
          document.getElementById("assignPrinterLabel").textContent =
            tr.dataset.label || `#${printerId}`;
          setSelectValue(selFabrika, tr.dataset.fabrika, fabrikaChoices);
          setSelectValue(selKullanim, tr.dataset.kullanim, kullanimChoices);
          setSelectValue(selPersonel, tr.dataset.personel, personelChoices);
          setSelectValue(selBagliEnv, tr.dataset.bagli, bagliEnvChoices);
          assignModal.show();
          e.target.value = "";
          return;
        }

        if (val === "fault") {
          if (window.Faults) {
            e.stopImmediatePropagation();
            window.Faults.openMarkModal("printer", {
              entityId: Number(printerId),
              entityKey: e.target.dataset.entityKey || printerId,
              deviceNo: e.target.dataset.device || "",
              title: e.target.dataset.title || "",
            });
          }
          e.target.value = "";
          return;
        }

        if (val === "repair") {
          if (window.Faults) {
            e.stopImmediatePropagation();
            window.Faults.openRepairModal("printer", {
              entityId: Number(printerId),
              entityKey: e.target.dataset.entityKey || printerId,
              deviceNo: e.target.dataset.device || "",
            });
          }
          e.target.value = "";
          return;
        }

        if (val === "scrap") {
          e.stopImmediatePropagation();
          document.getElementById("scrapPrinterId").value = printerId;
          scrapModal.show();
          e.target.value = "";
        }
      });
    });

    function setSelectValue(selectEl, value, choicesInstance) {
      if (!selectEl) return;
      const val = value || "";
      if (
        val &&
        !Array.from(selectEl.options).some((opt) => opt.value === val)
      ) {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        selectEl.appendChild(opt);
        if (choicesInstance) {
          choicesInstance.setChoices(
            [{ value: val, label: val }],
            "value",
            "label",
            false,
          );
        }
      }
      if (choicesInstance) {
        choicesInstance.removeActiveItems();
        if (val) {
          choicesInstance.setChoiceByValue(val);
        }
      }
      selectEl.value = val;
    }

    scrapForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const pid = document.getElementById("scrapPrinterId").value;
      const formData = new FormData(scrapForm);
      fetch(`/printers/${pid}/scrap`, { method: "POST", body: formData })
        .then((r) => r.json())
        .then((j) => {
          if (j.ok) {
            scrapModal.hide();
            window.location.href = "/printers/scrap";
          } else {
            alert("Hurdaya ayırma başarısız");
          }
        })
        .catch(() => alert("Sunucu hatası"));
    });

    assignForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const pid = document.getElementById("assignPrinterId").value;
      const formData = new FormData(assignForm);
      fetch(`/printers/assign/${pid}`, { method: "POST", body: formData })
        .then((r) => r.json())
        .then((j) => {
          if (j.ok) {
            assignModal.hide();
            location.reload();
          } else {
            alert("Atama kaydedilemedi.");
          }
        })
        .catch(() => alert("Sunucu hatası"));
    });

    if (window.Choices) {
      const options = {
        removeItemButton: true,
        searchEnabled: true,
        shouldSort: false,
      };

      fabrikaChoices = selFabrika ? new Choices(selFabrika, options) : null;
      kullanimChoices = selKullanim ? new Choices(selKullanim, options) : null;
      personelChoices = selPersonel ? new Choices(selPersonel, options) : null;
      bagliEnvChoices = selBagliEnv ? new Choices(selBagliEnv, options) : null;
    }
  });
</script>
{% endblock %}
