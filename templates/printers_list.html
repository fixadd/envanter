{% extends "base.html" %} {% block title %}Yazıcı Takip{% endblock %} {% block
content %}
<div class="container-fluid py-4">
  <div class="page-shell">
    <header class="page-header">
      <div class="page-header__heading">
        <span class="eyebrow text-primary">Yazıcı Takip</span>
        <h1 class="page-header__title">Yazıcılar</h1>
        <p class="page-header__subtitle">
          Tüm yazıcı envanterini görüntüleyin, durumlarını yönetin ve hızlıca
          aksiyon alın.
        </p>
      </div>
      <div class="page-header__actions page-actions">
        <div class="page-actions__group">
          <a
            href="#"
            class="btn btn-success btn-sm d-flex align-items-center gap-1"
            title="Yeni Ekle"
            data-bs-toggle="modal"
            data-bs-target="#addModal"
          >
            <i class="bi bi-plus-lg"></i>
            <span>Ekle</span>
          </a>
          {% with fault_entity='printer', fault_prefix='printer',
          fault_label='Yazıcı Arızalı Durum' %} {% include
          'partials/_fault_controls.html' %} {% endwith %}
          <div class="dropdown">
            <button
              class="btn btn-outline-primary btn-sm dropdown-toggle"
              type="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              Excel
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <a class="dropdown-item" href="/printers/export">Dışa Aktar</a>
              </li>
              <li>
                <form
                  action="/printers/import"
                  method="post"
                  enctype="multipart/form-data"
                >
                  <input
                    type="file"
                    name="file"
                    id="printerExcel"
                    class="d-none"
                    onchange="this.form.submit()"
                  />
                  <label for="printerExcel" class="dropdown-item mb-0"
                    >İçe Aktar</label
                  >
                </form>
              </li>
            </ul>
          </div>
          <button class="btn btn-outline-secondary btn-sm" id="filterBtn">
            Filtre
          </button>
          <button
            class="btn btn-outline-secondary btn-sm d-none"
            id="clearFilterBtn"
          >
            Temizle
          </button>
        </div>
        <div class="page-actions__group page-actions__group--grow">
          <label for="searchInput" class="visually-hidden">Ara</label>
          <input
            type="text"
            id="searchInput"
            class="form-control form-control-sm"
            placeholder="Ara..."
          />
        </div>
      </div>
    </header>

    <div class="page-card soft-card">
      <div class="table-responsive">
        <table class="table table-sm align-middle table-rounded">
          <thead class="table-light">
            <tr>
              <th data-field="id">ID</th>
              <th data-field="marka">Marka</th>
              <th data-field="model">Model</th>
              <th data-field="seri_no">Seri No</th>
              <th data-field="fabrika">Fabrika</th>
              <th data-field="kullanim_alani">Kullanım Alanı</th>
              <th data-field="sorumlu_personel">Sorumlu</th>
              <th data-field="bagli_envanter_no">Bağlı Env.</th>
              <th data-field="durum">Durum</th>
              <th style="width: 220px">İşlemler</th>
            </tr>
          </thead>
          <tbody>
            {% for p in printers %}
            <tr
              data-id="{{ p.id }}"
              data-label="{{ p.hostname or p.envanter_no or ('Yazıcı #' ~ p.id) }}"
              data-fabrika="{{ p.fabrika or '' }}"
              data-kullanim="{{ p.kullanim_alani or '' }}"
              data-personel="{{ p.sorumlu_personel or '' }}"
              data-bagli="{{ p.bagli_envanter_no or '' }}"
              {%
              if
              p.durum=""
              ="arızalı"
              %}class="table-warning"
              {%
              endif
              %}
            >
              <td>#{{ p.id }}</td>
              <td>{{ p.marka or '-' }}</td>
              <td>{{ p.model or '-' }}</td>
              <td>{{ p.seri_no or '-' }}</td>
              <td>{{ p.fabrika or '-' }}</td>
              <td>{{ p.kullanim_alani or '-' }}</td>
              <td>{{ p.sorumlu_personel or '-' }}</td>
              <td>{{ p.bagli_envanter_no or '-' }}</td>
              <td>
                {% if p.durum == 'hurda' %}
                <span class="badge text-bg-secondary">Hurda</span>
                {% elif p.durum == 'arızalı' %}
                <span class="badge text-bg-warning text-dark">Arızalı</span>
                {% else %}
                <span class="badge text-bg-success">Aktif</span>
                {% endif %}
              </td>
              <td class="text-nowrap">
                {% set entity = 'printers' %} {% set row_id = p.id %} {% set
                fault_mode = True %} {% set fault_device = p.envanter_no or
                ('Yazıcı #' ~ p.id) %} {% set fault_title = (p.marka ~ ' ' ~
                p.model)|trim %} {% set fault_entity_key = p.envanter_no or p.id
                %} {% set fault_status = p.durum %} {% with edit_modal_size='md'
                %} {% include 'partials/_actions_menu.html' %} {% endwith %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Yeni Ekle Modal -->
<div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
  <div
    class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"
  >
    <form
      method="post"
      action="/printers/create"
      class="modal-content border-0 bg-transparent p-0 needs-validation"
      novalidate
    >
      <div class="modal-shell">
        <div class="modal-shell__header">
          <div class="modal-shell__heading">
            <h5 class="modal-shell__title">Yazıcı Ekle</h5>
            <p class="modal-shell__subtitle">
              Yeni bir yazıcıyı envantere ekleyin ve temel yapılandırmasını
              belirleyin.
            </p>
          </div>
          <div class="modal-shell__header-actions">
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Kapat"
            ></button>
          </div>
        </div>

        <div class="modal-shell__body">
          <div class="modal-form-grid">
            <div class="form-group">
              <label class="form-label" for="printerEnvanter"
                >Envanter No</label
              >
              <input
                id="printerEnvanter"
                name="envanter_no"
                type="text"
                class="form-control"
                required
                placeholder="ENV-000123"
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="selYaziciMarka"
                >Yazıcı Markası</label
              >
              <select
                name="yazici_markasi"
                class="form-select"
                required
                id="selYaziciMarka"
              >
                <option value="">Seçiniz...</option>
                {% for m in marka_list %}
                <option value="{{ m.name }}">{{ m.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="selYaziciModel"
                >Yazıcı Modeli</label
              >
              <select
                name="yazici_modeli"
                class="form-select"
                required
                id="selYaziciModel"
                disabled
              >
                <option value="">Önce marka seçiniz...</option>
              </select>
              <small class="text-muted"
                >Not: Model listesi seçilen markaya göre filtrelenir.</small
              >
            </div>

            <div class="form-group">
              <label class="form-label" for="printerUsage"
                >Kullanım Alanı</label
              >
              <select
                id="printerUsage"
                name="kullanim_alani"
                class="form-select"
                required
              >
                <option value="">Seçiniz...</option>
                {% for k in kullanim_alanlari %}
                <option value="{{ k.name }}">{{ k.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="printerIp">IP Adresi</label>
              <input
                id="printerIp"
                name="ip_adresi"
                type="text"
                class="form-control"
                required
                placeholder="10.0.0.10"
              />
            </div>
            <div class="form-group">
              <label class="form-label" for="printerMac">MAC</label>
              <input
                id="printerMac"
                name="mac"
                type="text"
                class="form-control"
                required
                placeholder="AA:BB:CC:DD:EE:FF"
              />
            </div>
            <div class="form-group">
              <label class="form-label" for="printerHostname">Hostname</label>
              <input
                id="printerHostname"
                name="hostname"
                type="text"
                class="form-control"
                required
                placeholder="PRN-OFIS-01"
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="printerIfs">
                IFS No <small class="text-muted">(opsiyonel)</small>
              </label>
              <input
                id="printerIfs"
                name="ifs_no"
                type="text"
                class="form-control"
                placeholder="IFS numarası"
              />
            </div>
          </div>
        </div>

        <div class="modal-shell__footer">
          <div class="modal-shell__actions">
            <button
              type="button"
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
            >
              İptal
            </button>
            <button type="submit" class="btn btn-primary">Kaydet</button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  window.SKIP_SELECT_ENHANCE = true;
</script>

<!-- Filtre Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <form id="filterForm" class="modal-content border-0 bg-transparent p-0">
      <div class="modal-shell">
        <div class="modal-shell__header">
          <div class="modal-shell__heading">
            <h5 class="modal-shell__title">Yazıcıları Filtrele</h5>
            <p class="modal-shell__subtitle">
              Marka, model veya sorumlu gibi kriterlerle listeyi daraltın.
            </p>
          </div>
          <div class="modal-shell__header-actions">
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Kapat"
            ></button>
          </div>
        </div>

        <div class="modal-shell__body">
          <div id="filterRows" class="stack-sm"></div>
        </div>

        <div class="modal-shell__footer">
          <div class="modal-shell__actions">
            <button
              type="button"
              class="btn btn-outline-secondary btn-sm"
              data-bs-dismiss="modal"
            >
              Vazgeç
            </button>
            <button type="submit" class="btn btn-primary btn-sm">Uygula</button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- ATAMA MODAL -->
<div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <form class="modal-content border-0 bg-transparent p-0" id="assignForm">
      <div class="modal-shell">
        <div class="modal-shell__header">
          <div class="modal-shell__heading">
            <h5 class="modal-shell__title">
              Yazıcıyı Ata — <span id="assignPrinterLabel"></span>
            </h5>
            <p class="modal-shell__subtitle">
              Yazıcı için fabrika, kullanım alanı ve sorumlu bilgilerini
              güncelleyin.
            </p>
          </div>
          <div class="modal-shell__header-actions">
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Kapat"
            ></button>
          </div>
        </div>

        <div class="modal-shell__body">
          <input type="hidden" id="assignPrinterId" name="printer_id" />

          <div class="modal-form-grid">
            <div class="form-group">
              <label class="form-label" for="selFabrika">Fabrika</label>
              <select id="selFabrika" name="fabrika" class="form-select">
                <option value="">Seçiniz</option>
                {% for f in factories %}
                <option value="{{ f }}">{{ f }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="selKullanim">Kullanım Alanı</label>
              <select
                id="selKullanim"
                name="kullanim_alani"
                class="form-select"
              >
                <option value="">Seçiniz</option>
                {% for a in areas %}
                <option value="{{ a }}">{{ a }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="selPersonel"
                >Sorumlu Personel</label
              >
              <select
                id="selPersonel"
                name="sorumlu_personel"
                class="form-select"
              >
                <option value="">Seçiniz</option>
                {% for u in users %}
                <option value="{{ u }}">{{ u }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="selBagliEnv"
                >Bağlı Olduğu Envanter</label
              >
              <select
                id="selBagliEnv"
                name="bagli_envanter_no"
                class="form-select"
              >
                <option value="">Seçiniz</option>
                {% for inv in inventory_nos %}
                <option value="{{ inv }}">{{ inv }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>

        <div class="modal-shell__footer">
          <div class="modal-shell__actions">
            <button
              class="btn btn-outline-secondary"
              type="button"
              data-bs-dismiss="modal"
            >
              İptal
            </button>
            <button class="btn btn-success" type="submit">
              Atamayı Kaydet
            </button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- HURDA MODAL -->
<div class="modal fade" id="scrapModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="scrapForm" class="modal-content border-0 bg-transparent p-0">
      <div class="modal-shell">
        <div class="modal-shell__header">
          <div class="modal-shell__heading">
            <h5 class="modal-shell__title">Hurdaya Ayır</h5>
            <p class="modal-shell__subtitle">
              Yazıcı hurdaya ayrılmadan önce kısa bir açıklama ekleyin.
            </p>
          </div>
          <div class="modal-shell__header-actions">
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Kapat"
            ></button>
          </div>
        </div>

        <div class="modal-shell__body">
          <input type="hidden" id="scrapPrinterId" />
          <p class="mb-2">Bu envanter hurdaya ayrılacak. Onaylıyor musunuz?</p>
          <div class="modal-form-grid">
            <div class="form-group modal-form-grid--full">
              <label class="form-label" for="scrapReason"
                >Açıklama (opsiyonel)</label
              >
              <textarea
                id="scrapReason"
                name="reason"
                class="form-control"
                rows="3"
                placeholder="Hurda sebebi / not"
              ></textarea>
            </div>
          </div>
        </div>

        <div class="modal-shell__footer">
          <div class="modal-shell__actions">
            <button
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
              type="button"
            >
              Vazgeç
            </button>
            <button class="btn btn-danger" type="submit">Hurdaya Ayır</button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %} {% block scripts %} {{ super() }}
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const filterModal = new bootstrap.Modal(
      document.getElementById("filterModal"),
    );
    const searchInput = document.getElementById("searchInput");
    const filterForm = document.getElementById("filterForm");
    const clearBtn = document.getElementById("clearFilterBtn");
    const filterRowsDiv = document.getElementById("filterRows");
    const distinctUrl =
      "{{ url_for('lookup.distinct', entity='printer', column='__COL__') }}";
    let activeFilters = [];
    const columns = Array.from(document.querySelectorAll("table thead th"))
      .map((th, idx) => ({
        idx,
        name: th.textContent.trim(),
        field: th.dataset.field,
      }))
      .filter((c) => c.field);

    const markaSel = document.getElementById("selYaziciMarka");
    const modelSel = document.getElementById("selYaziciModel");
    if (markaSel && modelSel) {
      if (window.Choices) {
        new Choices(markaSel, { searchEnabled: true, shouldSort: false });
        new Choices(modelSel, { searchEnabled: true, shouldSort: false });
      }
      const loadModels = async () => {
        const marka = markaSel.value;
        modelSel.innerHTML = '<option value="">Seçiniz...</option>';
        modelSel.disabled = !marka;
        if (!marka) return;
        try {
          const resp = await fetch(
            `/api/printers/models?brand=${encodeURIComponent(marka)}`,
          );
          if (resp.ok) {
            const data = await resp.json();
            data.forEach((m) => {
              const opt = document.createElement("option");
              opt.value = m;
              opt.textContent = m;
              modelSel.appendChild(opt);
            });
          }
        } catch (e) {
          console.error(e);
        }
      };
      markaSel.addEventListener("change", loadModels);
      loadModels();
    }

    // Modal tetikleyici attribute ile handle ediliyor; ek JS gerekmez.

    document.getElementById("filterBtn").addEventListener("click", () => {
      filterForm.reset();
      filterRowsDiv.innerHTML = "";
      createFilterRow();
      filterModal.show();
    });

    clearBtn.addEventListener("click", () => {
      activeFilters = [];
      filterRows();
      clearBtn.classList.add("d-none");
    });

    searchInput.addEventListener("input", filterRows);

    function createFilterRow() {
      const row = document.createElement("div");
      row.className = "row g-2 align-items-center mb-2 filter-row";
      row.innerHTML = `
      <div class="col-5">
        <select class="form-select form-select-sm column-select">
          ${columns.map((c) => `<option value="${c.idx}">${c.name}</option>`).join("")}
        </select>
      </div>
      <div class="col-5">
        <select class="form-select form-select-sm value-select"></select>
      </div>
      <div class="col-2 d-flex gap-1">
        <button type="button" class="btn btn-success btn-sm add-row">+</button>
        <button type="button" class="btn btn-danger btn-sm remove-row">-</button>
      </div>`;
      filterRowsDiv.appendChild(row);
      const colSel = row.querySelector(".column-select");
      const valSel = row.querySelector(".value-select");
      loadValues(colSel, valSel);
      colSel.addEventListener("change", () => loadValues(colSel, valSel));
      updateRemoveButtons();
    }

    async function loadValues(colSelect, valSelect) {
      const col = columns.find((c) => c.idx == colSelect.value);
      const res = await fetch(distinctUrl.replace("__COL__", col.field));
      const data = await res.json();
      valSelect.innerHTML =
        '<option value="">Seçiniz</option>' +
        data.map((v) => `<option value="${v}">${v}</option>`).join("");
    }

    function updateRemoveButtons() {
      const rows = filterRowsDiv.querySelectorAll(".filter-row");
      rows.forEach((r) =>
        r
          .querySelector(".remove-row")
          .classList.toggle("d-none", rows.length === 1),
      );
    }

    filterForm.addEventListener("click", (e) => {
      if (e.target.classList.contains("add-row")) {
        createFilterRow();
      } else if (e.target.classList.contains("remove-row")) {
        e.target.closest(".filter-row").remove();
        updateRemoveButtons();
      }
    });

    filterForm.addEventListener("submit", (e) => {
      e.preventDefault();
      activeFilters = [];
      filterRowsDiv.querySelectorAll(".filter-row").forEach((row) => {
        const col = parseInt(row.querySelector(".column-select").value, 10);
        const val = row
          .querySelector(".value-select")
          .value.trim()
          .toLowerCase();
        if (val) activeFilters.push({ col, val });
      });
      filterModal.hide();
      clearBtn.classList.toggle("d-none", activeFilters.length === 0);
      filterRows();
    });

    function filterRows() {
      const q = searchInput.value.toLowerCase();
      document.querySelectorAll("tbody tr").forEach((tr) => {
        const cells = tr.querySelectorAll("td");
        const texts = Array.from(cells).map((td) =>
          td.textContent.toLowerCase(),
        );
        let match = texts.some((t) => t.includes(q));
        if (activeFilters.length) {
          match =
            match &&
            activeFilters.every(
              (f) => texts[f.col] && texts[f.col].includes(f.val),
            );
        }
        tr.classList.toggle("d-none", !match);
      });
    }

    // Atama/Hurda işlemleri
    const assignModalEl = document.getElementById("assignModal");
    const assignModal = new bootstrap.Modal(assignModalEl);
    const assignForm = document.getElementById("assignForm");
    const scrapModalEl = document.getElementById("scrapModal");
    const scrapModal = new bootstrap.Modal(scrapModalEl);
    const scrapForm = document.getElementById("scrapForm");

    document.querySelectorAll(".action-select").forEach((sel) => {
      sel.addEventListener("change", (e) => {
        const val = e.target.value;
        if (!val) return;
        const tr = e.target.closest("tr");
        const printerId = tr?.dataset.id;
        if (!printerId) return;

        if (val === "assign") {
          e.stopImmediatePropagation();
          document.getElementById("assignPrinterId").value = printerId;
          document.getElementById("assignPrinterLabel").textContent =
            tr.dataset.label || `#${printerId}`;
          setSelectValue("selFabrika", tr.dataset.fabrika);
          setSelectValue("selKullanim", tr.dataset.kullanim);
          setSelectValue("selPersonel", tr.dataset.personel);
          setSelectValue("selBagliEnv", tr.dataset.bagli);
          assignModal.show();
          e.target.value = "";
          return;
        }

        if (val === "fault") {
          if (window.Faults) {
            e.stopImmediatePropagation();
            window.Faults.openMarkModal("printer", {
              entityId: Number(printerId),
              entityKey: e.target.dataset.entityKey || printerId,
              deviceNo: e.target.dataset.device || "",
              title: e.target.dataset.title || "",
            });
          }
          e.target.value = "";
          return;
        }

        if (val === "repair") {
          if (window.Faults) {
            e.stopImmediatePropagation();
            window.Faults.openRepairModal("printer", {
              entityId: Number(printerId),
              entityKey: e.target.dataset.entityKey || printerId,
              deviceNo: e.target.dataset.device || "",
            });
          }
          e.target.value = "";
          return;
        }

        if (val === "scrap") {
          e.stopImmediatePropagation();
          document.getElementById("scrapPrinterId").value = printerId;
          scrapModal.show();
          e.target.value = "";
        }
      });
    });

    function setSelectValue(selectId, value) {
      const el = document.getElementById(selectId);
      if (!el) return;
      const val = value || "";
      if (val && !Array.from(el.options).some((opt) => opt.value === val)) {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        el.appendChild(opt);
      }
      el.value = val;
    }

    scrapForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const pid = document.getElementById("scrapPrinterId").value;
      const formData = new FormData(scrapForm);
      fetch(`/printers/${pid}/scrap`, { method: "POST", body: formData })
        .then((r) => r.json())
        .then((j) => {
          if (j.ok) {
            scrapModal.hide();
            window.location.href = "/printers/scrap";
          } else {
            alert("Hurdaya ayırma başarısız");
          }
        })
        .catch(() => alert("Sunucu hatası"));
    });

    assignForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const pid = document.getElementById("assignPrinterId").value;
      const formData = new FormData(assignForm);
      fetch(`/printers/assign/${pid}`, { method: "POST", body: formData })
        .then((r) => r.json())
        .then((j) => {
          if (j.ok) {
            assignModal.hide();
            location.reload();
          } else {
            alert("Atama kaydedilemedi.");
          }
        })
        .catch(() => alert("Sunucu hatası"));
    });

    ["selFabrika", "selKullanim", "selPersonel", "selBagliEnv"].forEach(
      (id) => {
        const el = document.getElementById(id);
        if (el) {
          new Choices(el, {
            removeItemButton: true,
            searchEnabled: true,
            shouldSort: false,
          });
        }
      },
    );
  });
</script>
{% endblock %}
