{% extends "base.html" %}{% block title %}Kayıtlar{% endblock %}
{% from "components/tabs.html" import tabs %}
{% set active_key = request.query_params.get("tab") or "kullanici" %}
{% block content %}
<div class="container-fluid p-3">
  {% set islem_map = {
  "assign": "Atama",
  "edit": "Düzenleme",
  "scrap": "Hurdaya Ayır"
} %}
  <div class="tabs-wrap">
  {{ tabs(
    items=[
      {"label":"Kullanıcı Kayıtları","href": url_for('logs_page') ~ "?tab=kullanici","key":"kullanici"},
      {"label":"Envanter Kayıtları","href": url_for('logs_page') ~ "?tab=envanter","key":"envanter"},
    ],
    active_key=active_key
  ) }}
  </div>
  <div class="page-section">
{% if active_key == "kullanici" %}
  <div class="card p-0">
    <div class="p-2 d-flex justify-content-end gap-2">
      <select id="filterUserName" class="form-select form-select-sm" style="max-width:160px;">
        <option value="">Kullanıcı...</option>
        {% for u in users %}
        <option value="{{ u }}">{{ u }}</option>
        {% endfor %}
      </select>
      <input type="text" id="searchUserLogs" class="form-control form-control-sm py-0" placeholder="Ara..." style="max-width:200px;height: 40px">
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm align-middle mb-0">
        <thead>
          <tr>
            <th>Kullanıcı</th>
            <th>İşlem</th>
            <th>Envanter No</th>
            <th>Tarih</th>
          </tr>
        </thead>
        <tbody>
        {% for log, inv_no in user_logs %}
          <tr>
            <td data-user="{{ log.actor }}">{{ log.actor }}</td>
            <td data-action="{{ log.action }}">{{ islem_map.get(log.action, log.action) }}</td>
            <td>{{ inv_no }}</td>
            <td>{{ log.created_at.strftime("%d.%m.%Y %H:%M:%S") }}</td>
          </tr>
        {% else %}
          <tr><td colspan="4" class="text-muted">Kayıt yok</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% else %}
  <div class="card p-0">
    <div class="p-2 d-flex justify-content-end gap-2">
      <select id="filterInventoryNo" class="form-select form-select-sm" style="max-width:160px;">
        <option value="">Envanter No...</option>
        {% for no in inventory_numbers %}
        <option value="{{ no }}">{{ no }}</option>
        {% endfor %}
      </select>
      <input type="text" id="searchInventoryLogs" class="form-control form-control-sm py-0" placeholder="Ara..." style="max-width:200px;height: 40px">
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm align-middle mb-0">
        <thead>
          <tr>
            <th>Envanter No</th>
            <th>İşlem</th>
            <th>Önce</th>
            <th>Sonra</th>
            <th>Kullanıcı</th>
            <th>Tarih</th>
          </tr>
        </thead>
        <tbody>
        {% for log, inv_no in inventory_logs %}
          <tr>
            <td data-inv="{{ inv_no }}">{{ inv_no }}</td>
            <td data-action="{{ log.action }}">{{ islem_map.get(log.action, log.action) }}</td>
            <td>
              {% if log.before_json %}
                {% for k, v in log.before_json.items() %}
                  <div><strong>{{ k|replace("_"," ")|capitalize }}:</strong> {{ v }}</div>
                {% endfor %}
              {% else %}
                Yok
              {% endif %}
            </td>
            <td>
              {% if log.after_json %}
                {% for k, v in log.after_json.items() %}
                  <div><strong>{{ k|replace("_"," ")|capitalize }}:</strong> {{ v }}</div>
                {% endfor %}
              {% else %}
                Yok
              {% endif %}
            </td>
            <td>{{ log.actor }}</td>
            <td>{{ log.created_at.strftime("%d.%m.%Y %H:%M:%S") }}</td>
          </tr>
        {% else %}
          <tr><td colspan="6" class="text-muted">Kayıt yok</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endif %}
</div>
{% endblock %}
