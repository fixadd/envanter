{% extends "base.html" %}
{% block title %}Talep Takip{% endblock %}
{% block content %}
<div class="container-fluid p-3">
  <div class="d-flex justify-content-end mb-2 gap-2">
    <a href="{{ url_for('talep_export_excel') }}" class="btn btn-outline-secondary btn-sm">Excel</a>
    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#talepModal">Talep Aç</button>
  </div>

  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th style="width:180px">IFS No</th>
          <th>Donanım Tipi</th>
          <th>Marka</th>
          <th>Model</th>
          <th style="width:90px">Miktar</th>
          <th>Açıklama</th>
        </tr>
      </thead>
      <tbody id="talepBody"></tbody>
    </table>
  </div>
</div>

<script>
(async () => {
  const res = await fetch('/api/talep/list-grouped');
  const data = await res.json();

  const tbody = document.getElementById('talepBody');
  const frag = document.createDocumentFragment();

  data.forEach(group => {
    const trHead = document.createElement('tr');
    trHead.className = 'table-active';
    const td = document.createElement('td');
    td.colSpan = 6;
    td.innerHTML = `<strong>IFS:</strong> ${group.ifs_no}`;
    trHead.appendChild(td);
    frag.appendChild(trHead);

    (group.items || []).forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td></td>
        <td>${item.donanim_tipi ?? ''}</td>
        <td>${item.marka ?? ''}</td>
        <td>${item.model ?? ''}</td>
        <td>${item.miktar ?? ''}</td>
        <td>${item.aciklama ?? ''}</td>
      `;
      frag.appendChild(tr);
    });
  });

  tbody.innerHTML = '';
  tbody.appendChild(frag);
})();
</script>

<!-- Talep Aç Modal -->
<div class="modal fade" id="talepModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Talep Aç</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>

      <form id="talepForm" autocomplete="off">
        <div class="modal-body">

          <!-- IFS -->
          <div class="mb-3">
            <label class="form-label">IFS No</label>
            <input id="ifs_no" name="ifs_no" class="form-control" placeholder="IFS No">
          </div>

          <!-- Kalemler tablosu -->
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label m-0">Kalemler</label>
            <button type="button" id="btnAddRow" class="btn btn-outline-secondary btn-sm">Satır Ekle</button>
          </div>

          <div class="table-responsive">
            <table class="table table-sm align-middle" id="rowsTable">
              <thead>
                <tr>
                  <th style="width:20%">Donanım Tipi</th>
                  <th style="width:8%">Miktar</th>
                  <th style="width:18%">Marka</th>
                  <th style="width:18%">Model</th>
                  <th style="width:28%">Açıklama</th>
                  <th style="width:8%"></th>
                </tr>
              </thead>
              <tbody><!-- JS dolduracak --></tbody>
            </table>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
          <button type="submit" class="btn btn-primary">Gönder</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Talep Kapat Modal -->
<div class="modal fade" id="talepKapatModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="talepKapatForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Stok Girişi</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="tkTalepId">
        <div class="mb-3">
          <label class="form-label">Miktar</label>
          <input type="number" id="tkAdet" class="form-control" min="1" value="1">
        </div>
        <div class="mb-3">
          <label class="form-label">Marka</label>
          <select id="tkMarka" class="form-select"></select>
        </div>
        <div class="mb-3">
          <label class="form-label">Model</label>
          <select id="tkModel" class="form-select"></select>
        </div>
        <div class="mb-3">
          <label class="form-label">Not (opsiyonel)</label>
          <input type="text" id="tkAciklama" class="form-control">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
        <button type="submit" class="btn btn-primary">Kaydet</button>
      </div>
    </form>
  </div>
</div>

<!-- JS dosyan (sayfanın EN ALTINA koy) -->
<script src="/static/js/talep.js"></script>
{% endblock %}
