{% extends "base.html" %} {% from "components/tabs.html" import tabs %} {% from
"components/modal.html" import modal %} {% set active_key =
request.query_params.get("durum") or "acik" %} {% block title %}Talep Takip{%
endblock %} {% block content %}
<div class="container-fluid py-4">
  <div class="page-shell">
    <header class="page-header">
      <div class="page-header__heading">
        <span class="eyebrow text-primary">Talep Takip</span>
        <h1 class="page-header__title">Talepler</h1>
        <p class="page-header__subtitle">
          Açık, tamamlanan ve iptal edilen tüm talepleri tek noktadan yönetin.
        </p>
      </div>
      <div class="page-header__actions page-actions">
        <div class="page-actions__group">
          <a
            href="{{ url_for('talep_export_excel') }}"
            class="btn btn-outline-secondary btn-sm"
          >
            Excel
          </a>
          <button
            class="btn btn-primary btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#talepModal"
          >
            Talep Aç
          </button>
        </div>
      </div>
    </header>

    <div class="page-card soft-card stack-md">
      <div class="tabs-wrap">
        {{ tabs( items=[ {"label":"Açık","href": url_for('talep_list') ~
        "?durum=acik", "key":"acik"}, {"label":"Tamamlandı","href":
        url_for('talep_list') ~ "?durum=tamamlandi","key":"tamamlandi"},
        {"label":"İptal","href": url_for('talep_list') ~
        "?durum=iptal","key":"iptal"}, ], active_key=active_key ) }}
      </div>

      {% macro render_table(rows, empty_msg, show_actions=False) %}
      <div class="table-responsive">
        <table class="table table-striped table-hover table-sm align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>Donanım Tipi</th>
              <th>Marka</th>
              <th>Model</th>
              <th>İstenen</th>
              <th>Karşılanan</th>
              <th>Kalan</th>
              <th>Açıklama</th>
              <th>Tarih</th>
              {% if show_actions %}
              <th>İşlem</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for t in rows %} {% set current_ifs = t.ifs_no or '-' %} {% if
            loop.changed(current_ifs) %}
            <tr class="table-light">
              <td colspan="{{ 10 if show_actions else 9 }}">
                IFS No: {{ current_ifs }}
              </td>
            </tr>
            {% endif %}
            <tr data-tur="{{ t.tur.value if t.tur else '' }}">
              <td>{{ t.id }}</td>
              <td>{{ t.donanim_tipi or '-' }}</td>
              <td>{{ t.marka or '-' }}</td>
              <td>{{ t.model or '-' }}</td>
              <td>{{ t.miktar or '-' }}</td>
              <td>{{ t.karsilanan_miktar or '-' }}</td>
              <td>{{ t.kalan_miktar or '-' }}</td>
              <td>{{ t.aciklama or '-' }}</td>
              <td>
                {{ t.olusturma_tarihi.strftime('%Y-%m-%d %H:%M') }} {% if
                t.durum != 'acik' and t.kapanma_tarihi %}
                <br />
                <small class="text-muted">
                  {{ 'Kapanma: ' if t.durum == 'tamamlandi' else 'İptal: ' }}{{
                  t.kapanma_tarihi.strftime('%Y-%m-%d %H:%M') }}
                </small>
                {% endif %}
              </td>
              {% if show_actions %}
              <td>
                <div class="btn-group">
                  <button
                    class="btn btn-sm btn-outline-secondary dropdown-toggle"
                    data-bs-toggle="dropdown"
                  >
                    İşlem
                  </button>
                  <ul class="dropdown-menu">
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="talepIptal({{ t.id }}, {{ t.kalan_miktar }}); return false;"
                        >İptal Et</a
                      >
                    </li>
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="talepKapat({{ t.id }}, {{ t.kalan_miktar }}); return false;"
                        >Stok Gir</a
                      >
                    </li>
                  </ul>
                </div>
              </td>
              {% endif %}
            </tr>
            {% endfor %} {% if rows|length == 0 %}
            <tr>
              <td
                colspan="{{ 10 if show_actions else 9 }}"
                class="text-center text-muted"
              >
                {{ empty_msg }}
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      {% endmacro %} {% set msg_map = {'acik':'Açık talep
      bulunamadı.','tamamlandi':'Tamamlanan talep bulunamadı.','iptal':'İptal
      talep bulunamadı.'} %}
      <div class="page-section">
        {{ render_table(rows, msg_map.get(active_key), active_key == 'acik') }}
      </div>
    </div>
  </div>
</div>

<!-- Talep Aç Modal -->
{% set talep_modal_footer %}
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
  Kapat
</button>
<button type="submit" class="btn btn-primary">Gönder</button>
{% endset %} {% call modal( "talepModal", "Talep Aç", dialog_class="modal-xl",
form_attrs={"id": "talepForm", "autocomplete": "off"},
footer=talep_modal_footer, ) %}
<!-- IFS -->
<div class="env-grid" id="talep-ekle-grid">
  <div class="field span-2">
    <label for="ifs_no">IFS No <span class="muted">(opsiyonel)</span></label>
    <input id="ifs_no" name="ifs_no" class="ctrl" placeholder="IFS-0001" />
  </div>
</div>

<!-- Kalemler tablosu -->
<div class="d-flex justify-content-between align-items-center mb-2">
  <label class="form-label m-0">Kalemler</label>
  <button type="button" id="btnAddRow" class="btn btn-outline-secondary btn-sm">
    Satır Ekle
  </button>
</div>

<div class="table-responsive">
  <table class="table table-sm align-middle table-rounded" id="rowsTable">
    <thead>
      <tr>
        <th style="width: 20%">Donanım Tipi</th>
        <th style="width: 8%">Miktar</th>
        <th style="width: 18%">Marka</th>
        <th style="width: 18%">Model</th>
        <th style="width: 28%">Açıklama</th>
        <th style="width: 8%"></th>
      </tr>
    </thead>
    <tbody>
      <!-- JS dolduracak -->
    </tbody>
  </table>
</div>
{% endcall %}

<!-- Talep Kapat Modal -->
{% set talep_kapat_footer %}
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
  İptal
</button>
<button type="submit" class="btn btn-primary">Kaydet</button>
{% endset %} {% call modal( "talepKapatModal", "Stok Girişi", form_attrs={"id":
"talepKapatForm"}, footer=talep_kapat_footer, ) %}
<input type="hidden" id="tkTalepId" />
<div class="env-grid" id="talep-kapat-grid">
  <div class="field">
    <label for="tkAdet">Miktar</label>
    <input type="number" id="tkAdet" class="ctrl" min="1" value="1" required />
  </div>
  <div class="field">
    <label for="tkTur">Ürün Türü</label>
    <select id="tkTur" class="ctrl">
      <option value="envanter">Envanter</option>
      <option value="yazici">Yazıcı</option>
      <option value="lisans">Lisans</option>
    </select>
  </div>
  <div class="field">
    <label for="tkMarka">Marka</label>
    <select id="tkMarka" class="ctrl"></select>
  </div>
  <div class="field">
    <label for="tkModel">Model</label>
    <select id="tkModel" class="ctrl"></select>
  </div>
  <div class="field span-2">
    <label for="tkAciklama">Not <span class="muted">(opsiyonel)</span></label>
    <input type="text" id="tkAciklama" class="ctrl" placeholder="Ek bilgi" />
  </div>
</div>
{% endcall %} {% endblock %} {% block scripts %} {{ super() }}
<script src="/static/js/talep.js"></script>
{% endblock %}
