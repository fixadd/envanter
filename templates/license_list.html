{% extends "base.html" %} {% block title %}Lisans Takip{% endblock %} {% block
content %}
<div id="licenses-list" class="container-fluid py-4">
  <div class="page-shell">
    <header class="page-header">
      <div class="page-header__heading">
        <span class="eyebrow text-primary">LİSANS TAKİP</span>
        <h1 class="page-header__title">Lisanslar</h1>
        <p class="page-header__subtitle">
          Yazılım lisanslarını görüntüleyin ve yönetin.
        </p>
      </div>
      <div class="page-header__actions page-actions">
        <div class="page-actions__group">
          <a
            href="#"
            class="btn btn-success btn-sm"
            title="Yeni Ekle"
            data-bs-toggle="modal"
            data-bs-target="#addModal"
          >
            <i class="bi bi-plus-lg"></i>
            <span>Ekle</span>
          </a>
          <div class="dropdown">
            <button
              class="btn btn-outline-primary btn-sm dropdown-toggle"
              type="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              Excel
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <a class="dropdown-item" href="/lisans/export">Dışa Aktar</a>
              </li>
              <li>
                <form
                  action="/lisans/import"
                  method="post"
                  enctype="multipart/form-data"
                >
                  <input
                    type="file"
                    name="file"
                    id="licExcel"
                    class="d-none"
                    onchange="this.form.submit()"
                  />
                  <label for="licExcel" class="dropdown-item mb-0"
                    >İçe Aktar</label
                  >
                </form>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </header>

    <div class="filter-search-bar">
      <div class="filter-search-bar__row">
        <div class="filter-search-bar__main">
          <div class="search-wrapper">
            <i class="bi bi-search"></i>
            <input
              type="text"
              id="searchInput"
              class="form-control form-control-sm"
              placeholder="Lisans ara..."
            />
          </div>
          <div class="filter-group">
            <label for="durumFilter">Durum:</label>
            <select id="durumFilter" class="form-select form-select-sm">
              <option value="">Tümü</option>
              <option value="aktif">Aktif</option>
              <option value="bos">Boş</option>
            </select>
          </div>
        </div>
        <div class="filter-search-bar__actions">
          <button class="btn btn-primary btn-sm" id="filterBtn">
            <i class="bi bi-funnel"></i>
            Filtrele
          </button>
          <button
            class="btn btn-outline-secondary btn-sm d-none"
            id="clearFilterBtn"
          >
            <i class="bi bi-x-circle"></i>
            Temizle
          </button>
        </div>
      </div>
      <div class="active-filters-section d-none" id="activeFiltersSection">
        <div class="active-filters">
          <span class="active-filters__label">Aktif Filtreler:</span>
          <div id="activeFilterBadges"></div>
        </div>
      </div>
    </div>

    <div class="page-card">
      <div class="table-responsive">
        <table
          id="licensesTable"
          class="table table-sm table-hover table-rounded align-middle mb-0"
        >
          <thead>
            <tr>
              <th data-field="no">No</th>
              <th data-field="lisans_adi">Lisans Adı</th>
              <th data-field="lisans_anahtari">Key</th>
              <th data-field="sorumlu_personel">Sorumlu</th>
              <th data-field="bagli_envanter_no">Bağlı Envanter</th>
              <th data-field="mail_adresi">E-posta</th>
              <th data-field="durum">Durum</th>
              <th class="actions text-start">İşlemler</th>
            </tr>
          </thead>
          <tbody>
            {% for row in items %}
            <tr
              data-id="{{ row.id }}"
              data-personel="{{ row.sorumlu_personel or '' }}"
              data-bagli="{{ row.bagli_envanter_no or '' }}"
              data-durum="{{ row.durum or '' }}"
            >
              <td>{{ row.id }}</td>
              <td>{{ row.lisans_adi }}</td>
              <td class="text-truncate" style="max-width: 180px">
                {{ row.lisans_key }}
              </td>
              <td>{{ row.sorumlu_personel or '-' }}</td>
              <td>{{ row.bagli_envanter_no or '-' }}</td>
              <td>{{ row.mail_adresi or '-' }}</td>
              <td>
                {% if row.durum == 'hurda' %}
                <span class="badge bg-secondary">Hurda</span>
                {% elif row.durum == 'arızalı' %}
                <span class="badge text-bg-warning text-dark">Arızalı</span>
                {% else %}
                <span class="badge bg-success">Aktif</span>
                {% endif %}
              </td>
              <td class="actions">
                {% set entity = 'lisans' %} {% set row_id = row.id %} {% set
                fault_status = row.durum %} {% include
                'partials/_actions_menu.html' %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  window.SKIP_SELECT_ENHANCE = true;
</script>

<!-- Yeni Ekle Modal -->
<div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
  <div
    class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"
  >
    <form
      method="post"
      action="/lisans/create"
      class="modal-content border-0 bg-transparent p-0 needs-validation"
      novalidate
    >
      <div class="modal-shell">
        <div class="modal-shell__header">
          <div class="modal-shell__heading">
            <h5 class="modal-shell__title">Lisans Ekle</h5>
            <p class="modal-shell__subtitle">
              Yeni bir lisans kaydı oluşturarak stokunuzu güncel tutun.
            </p>
          </div>
          <div class="modal-shell__header-actions">
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Kapat"
            ></button>
          </div>
        </div>

        <div class="modal-shell__body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="selLisansAdi" class="form-label">Lisans Adı</label>
              <select id="selLisansAdi" name="lisans_adi" class="form-select" required>
                <option value="">Seçiniz</option>
                {% for ln in license_names %}
                <option value="{{ ln.name }}">{{ ln.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label for="lisansAnahtari" class="form-label">Lisans Anahtarı</label>
              <input
                id="lisansAnahtari"
                name="lisans_anahtari"
                type="text"
                class="form-control"
                required
                placeholder="XXXX-XXXX-XXXX-XXXX"
              />
            </div>

            <div class="col-md-6">
              <label for="selPersonelAdd" class="form-label">Sorumlu Personel</label>
              <select id="selPersonelAdd" name="sorumlu_personel" class="form-select">
                <option value="">Seçiniz</option>
                {% for u in users %}
                <option value="{{ u }}">{{ u }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label for="bagliEnvanter" class="form-label">Bağlı Olduğu Envanter No</label>
              <select
                id="bagliEnvanter"
                name="bagli_envanter_no"
                class="form-select"
                required
              >
                <option value="">Seçiniz...</option>
                {% for inv in envanterler %}
                <option value="{{ inv.no }}">{{ inv.no }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label for="ifsNo" class="form-label">
                IFS No <span class="muted">(opsiyonel)</span>
              </label>
              <input
                id="ifsNo"
                name="ifs_no"
                type="text"
                class="form-control"
                placeholder="IFS numarası"
              />
            </div>

            <div class="col-md-6">
              <label for="lisansEmail" class="form-label"
                >E-posta <span class="muted">(opsiyonel)</span></label
              >
              <input
                id="lisansEmail"
                name="mail_adresi"
                type="email"
                class="form-control"
                placeholder="ornek@firma.com"
              />
            </div>
          </div>
        </div>

        <div class="modal-shell__footer">
          <div class="modal-shell__actions">
            <button
              type="button"
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
            >
              İptal
            </button>
            <button type="submit" class="btn btn-primary">Kaydet</button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- ATAMA MODALI -->
<div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <form
      method="post"
      id="assignForm"
      class="modal-content border-0 bg-transparent p-0"
    >
      <div class="modal-shell">
        <div class="modal-shell__header">
          <div class="modal-shell__heading">
            <h5 class="modal-shell__title">Lisansı Ata</h5>
            <p class="modal-shell__subtitle">
              Lisansı bir personele veya envanter kaydına bağlayın.
            </p>
          </div>
          <div class="modal-shell__header-actions">
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Kapat"
            ></button>
          </div>
        </div>

        <div class="modal-shell__body">
          <input
            type="hidden"
            name="islem_yapan"
            value="{{ current_user.full_name if current_user else 'system' }}"
          />
          <div class="row g-3">
            <div class="col-md-6">
              <label for="selPersonel" class="form-label">Sorumlu Personel</label>
              <select name="sorumlu_personel" class="form-select" id="selPersonel">
                <option value="">Seçiniz</option>
                {% for u in users %}
                <option value="{{ u }}">{{ u }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label for="selBagli" class="form-label">Bağlı Olduğu Envanter No</label>
              <select name="bagli_envanter_no" class="form-select" id="selBagli">
                <option value="">Seçiniz</option>
                {% for inv in envanterler %}
                <option value="{{ inv.no }}">
                  {{ inv.no }} - {{ inv.bilgisayar_adi or inv.marka }}
                </option>
                {% endfor %}
              </select>
            </div>
          </div>
          <small class="text-muted"
            >Bu işlem lisansın geçmiş kayıtlarına eklenecek.</small
          >
        </div>

        <div class="modal-shell__footer">
          <div class="modal-shell__actions">
            <button
              class="btn btn-outline-secondary"
              type="button"
              data-bs-dismiss="modal"
            >
              İptal
            </button>
            <button class="btn btn-primary" type="submit">Kaydet</button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- HURDA MODALI -->
<div class="modal fade" id="scrapModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="scrapForm" class="modal-content border-0 bg-transparent p-0">
      <div class="modal-shell">
        <div class="modal-shell__header">
          <div class="modal-shell__heading">
            <h5 class="modal-shell__title">Hurdaya Ayır</h5>
            <p class="modal-shell__subtitle">
              Lisansı hurdaya ayırmadan önce kısa bir not ekleyebilirsiniz.
            </p>
          </div>
          <div class="modal-shell__header-actions">
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Kapat"
            ></button>
          </div>
        </div>

        <div class="modal-shell__body">
          <p class="mb-2">Bu lisans hurdaya ayrılacak. Onaylıyor musunuz?</p>
          <div class="row g-3">
            <div class="col-12">
              <label for="scrapNote" class="form-label"
                >Açıklama <span class="muted">(opsiyonel)</span></label
              >
              <textarea
                id="scrapNote"
                name="aciklama"
                class="form-control"
                rows="3"
                placeholder="Hurda sebebi / not"
              ></textarea>
            </div>
          </div>
          <input
            type="hidden"
            name="islem_yapan"
            value="{{ current_user.full_name if current_user else 'system' }}"
          />
        </div>

        <div class="modal-shell__footer">
          <div class="modal-shell__actions">
            <button
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
              type="button"
            >
              Vazgeç
            </button>
            <button class="btn btn-danger" type="submit">Hurdaya Ayır</button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    window.filterSystem = new UnifiedFilterSystem({
      tableSelector: "#licensesTable",
      searchInputId: "searchInput",
      filters: [{ id: "durumFilter", label: "Durum", columnField: "durum" }],
    });

    // Mevcut atama/hurda işlemleri
    const assignModal = new bootstrap.Modal(
      document.getElementById("assignModal"),
    );
    const assignForm = document.getElementById("assignForm");
    const selAssignPersonel = document.getElementById("selPersonel");
    const selAssignBagli = document.getElementById("selBagli");
    const scrapModal = new bootstrap.Modal(
      document.getElementById("scrapModal"),
    );
    const scrapForm = document.getElementById("scrapForm");
    let scrapId = null;
    let personelChoices = null;
    let bagliChoices = null;

    document
      .querySelectorAll("#licensesTable .action-select")
      .forEach((sel) => {
        sel.addEventListener("change", (e) => {
          const val = e.target.value;
          if (!val) return;
          const id = e.target.dataset.id;
          if (!id) return;

          if (val === "assign") {
            e.stopImmediatePropagation();
            assignForm.setAttribute("action", `/lisans/${id}/assign`);
            const tr = e.target.closest("tr");
            if (tr) {
              setSelectValue(
                selAssignPersonel,
                tr.dataset.personel,
                personelChoices,
              );
              setSelectValue(selAssignBagli, tr.dataset.bagli, bagliChoices);
            }
            assignModal.show();
            e.target.value = "";
            return;
          }

          if (val === "fault") {
            if (window.Faults) {
              e.stopImmediatePropagation();
              window.Faults.openMarkModal("license", {
                entityId: Number(id),
                entityKey: e.target.dataset.entityKey || id,
                deviceNo: e.target.dataset.device || "",
                title: e.target.dataset.title || "",
              });
            }
            e.target.value = "";
            return;
          }

          if (val === "repair") {
            if (window.Faults) {
              e.stopImmediatePropagation();
              window.Faults.openRepairModal("license", {
                entityId: Number(id),
                entityKey: e.target.dataset.entityKey || id,
                deviceNo: e.target.dataset.device || "",
              });
            }
            e.target.value = "";
            return;
          }

          if (val === "scrap") {
            e.stopImmediatePropagation();
            scrapId = id;
            scrapModal.show();
            e.target.value = "";
          }
        });
      });

    assignForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const actionUrl = assignForm.getAttribute("action");
      if (!actionUrl) return;
      const fd = new FormData(assignForm);
      const res = await fetch(actionUrl, { method: "POST", body: fd });
      if (res.ok) {
        assignModal.hide();
        location.reload();
      } else {
        alert("Atama kaydedilemedi");
      }
    });

    scrapForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(scrapForm);
      const res = await fetch(`/lisans/${scrapId}/scrap`, {
        method: "POST",
        body: fd,
      });
      if (res.ok) {
        scrapModal.hide();
        window.location.href = `{{ url_for('license_scrap_list') }}`;
      } else {
        alert("Hurdaya ayırma başarısız");
      }
    });

    function setSelectValue(selectEl, value, choicesInstance) {
      if (!selectEl) return;
      const val = value || "";
      if (
        val &&
        !Array.from(selectEl.options).some((opt) => opt.value === val)
      ) {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        selectEl.appendChild(opt);
        if (choicesInstance) {
          choicesInstance.setChoices(
            [{ value: val, label: val }],
            "value",
            "label",
            false,
          );
        }
      }
      if (choicesInstance) {
        choicesInstance.removeActiveItems();
        if (val) {
          choicesInstance.setChoiceByValue(val);
        }
      }
      selectEl.value = val;
    }

    if (window.Choices) {
      new Choices("#selLisansAdi", { searchEnabled: true, shouldSort: false });
      new Choices("#selPersonelAdd", {
        searchEnabled: true,
        shouldSort: false,
      });
      personelChoices = new Choices("#selPersonel", {
        searchEnabled: true,
        shouldSort: false,
      });
      bagliChoices = new Choices("#selBagli", {
        searchEnabled: true,
        shouldSort: false,
      });
    }
  });
</script>

<style>
  #licenses-list .table-responsive {
    overflow: visible;
  }
  #licensesTable th.actions,
  #licensesTable td.actions {
    white-space: nowrap;
    width: 220px;
  }

  #licensesTable td.actions .action-select {
    min-width: 160px;
    display: inline-block;
  }
  #licensesTable td.actions .choices {
    min-width: 160px;
  }
  #licensesTable td.actions .choices__inner {
    min-height: 32px;
    padding: 2px 30px 2px 8px;
  }
  #licensesTable td.actions .choices__list--dropdown.is-active {
    z-index: 1080;
    min-width: 180px;
  }
</style>
{% endblock %}
