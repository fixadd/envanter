{% from "partials/inventory_form_fields.html" import inventory_form_fields %}

<form
  method="post"
  action="/inventory/create"
  class="needs-validation"
  novalidate
>
  {{ inventory_form_fields(mode='create') }}

  <div class="mt-3 d-flex gap-2">
    <button type="submit" class="btn btn-primary">Kaydet</button>
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
      İptal
    </button>
  </div>
</form>

<script>
  (async function () {
    function normalisePickerItems(data) {
      if (!Array.isArray(data)) return [];
      return data
        .map((item) => {
          if (typeof item === "string") {
            const value = item.trim();
            if (!value) return null;
            return { id: value, text: value };
          }
          if (!item || typeof item !== "object") return null;
          const text =
            item.text ||
            item.name ||
            item.label ||
            item.value ||
            item.ad ||
            item.adi ||
            "";
          const id = item.id ?? text;
          if (!text) return null;
          return { id, text };
        })
        .filter(Boolean);
    }

    async function fetchPickerItems(url) {
      try {
        const res = await fetch(url, { headers: { Accept: "application/json" } });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const payload = await res.json();
        return normalisePickerItems(payload);
      } catch (error) {
        console.warn("fetchPickerItems failed", { url, error });
        return [];
      }
    }

    async function loadOptions(sel, url, options = {}) {
      if (!sel) return [];
      const { placeholder = "Seçiniz...", fallbackUrl } = options;
      let items = await fetchPickerItems(url);
      if (!items.length && fallbackUrl) {
        items = await fetchPickerItems(fallbackUrl);
      }
      sel.innerHTML =
        `<option value="">${placeholder}</option>` +
        items
          .map((o) => {
            const dataId =
              o.id !== undefined && o.id !== null ? ` data-id="${o.id}"` : "";
            return `<option value="${o.text}"${dataId}>${o.text}</option>`;
          })
          .join("");
      return items;
    }

    const fabrikaSel = document.getElementById("fabrika");
    const departmanSel = document.getElementById("departman");
    const donanimSel = document.getElementById("donanim_tipi");
    const personelSel = document.getElementById("sorumlu_personel");
    const markaSel = document.getElementById("marka");
    const modelSel = document.getElementById("model");

    await loadOptions(fabrikaSel, "/api/picker/fabrika");
    await loadOptions(departmanSel, "/api/picker/kullanim_alani", {
      fallbackUrl: "/inventory/assign/sources?type=departman",
    });
    await loadOptions(donanimSel, "/api/picker/donanim_tipi");
    if (window._selects) {
      await _selects.fillChoices({
        endpoint: "/api/picker/kullanici",
        selectId: "sorumlu_personel",
        mapFn: (r) => ({ value: r.text, label: r.text }),
      });
      _selects.enableRemoteSearch(
        "sorumlu_personel",
        "/api/picker/kullanici",
        () => ({}),
        (r) => ({ value: r.text, label: r.text }),
      );
    } else {
      await loadOptions(personelSel, "/api/picker/kullanici");
    }

    const brands = await fetchPickerItems("/api/picker/marka");
    markaSel.innerHTML =
      '<option value="">Seçiniz...</option>' +
      brands
        .map((b) => {
          const dataId =
            b.id !== undefined && b.id !== null ? ` data-id="${b.id}"` : "";
          return `<option value="${b.text}"${dataId}>${b.text}</option>`;
        })
        .join("");

    markaSel.addEventListener("change", async () => {
      const opt = markaSel.options[markaSel.selectedIndex];
      const brandId = opt && opt.dataset.id;
      modelSel.innerHTML = '<option value="">Seçiniz...</option>';
      modelSel.disabled = !brandId;
      if (!brandId) return;
      const res = await fetch(`/api/picker/model?marka_id=${brandId}`);
      const models = await res.json();
      modelSel.innerHTML += models
        .map((m) => `<option value="${m.text}">${m.text}</option>`)
        .join("");
    });
  })();
</script>
