<form method="post" action="/inventory/create" class="needs-validation" novalidate>
  <div class="row g-3" id="envanter-ekle">

    <!-- Envanter No -->
    <div class="col-md-6">
      <label class="form-label">Envanter No</label>
      <input name="envanter_no" type="text" class="form-control" required placeholder="ENV-000123">
    </div>

    <!-- Fabrika -->
    <div class="col-md-6">
      <label class="form-label">Fabrika</label>
      <div class="input-group lookup-group">
        <button type="button" class="btn btn-outline-secondary lookup-btn" data-entity="fabrika">&#9776;</button>
        <input id="fabrika_display" type="text" class="form-control bg-body-tertiary" value="Seçilmedi" readonly>
        <input type="hidden" id="fabrika" name="fabrika" required>
        <div class="invalid-feedback">Fabrika zorunlu.</div>
      </div>
    </div>

    <!-- Departman -->
    <div class="col-md-6">
      <label class="form-label">Departman</label>
      <div class="input-group lookup-group">
        <button type="button" class="btn btn-outline-secondary lookup-btn" data-entity="departman">&#9776;</button>
        <input id="departman_display" type="text" class="form-control bg-body-tertiary" value="Seçilmedi" readonly>
        <input type="hidden" id="departman" name="departman" required>
        <div class="invalid-feedback">Departman zorunlu.</div>
      </div>
    </div>

    <!-- Donanım Tipi -->
    <div class="col-md-6">
      <label class="form-label">Donanım Tipi</label>
      <div class="input-group lookup-group">
        <button type="button" class="btn btn-outline-secondary lookup-btn" data-entity="donanim_tipi">&#9776;</button>
        <input id="donanim_tipi_display" type="text" class="form-control bg-body-tertiary" value="Seçilmedi" readonly>
        <input type="hidden" id="donanim_tipi" name="donanim_tipi" required>
        <div class="invalid-feedback">Donanım tipi zorunlu.</div>
      </div>
    </div>

    <!-- Bilgisayar Adı -->
    <div class="col-md-6">
      <label class="form-label">Bilgisayar Adı</label>
      <input name="bilgisayar_adi" type="text" class="form-control" required placeholder="PC-OFIS-01">
    </div>

    <!-- Marka -->
    <div class="col-md-6">
      <label class="form-label">Marka</label>
      <div class="input-group lookup-group">
        <button type="button" class="btn btn-outline-secondary lookup-btn" data-entity="marka">&#9776;</button>
        <input id="marka_display" type="text" class="form-control bg-body-tertiary" value="Seçilmedi" readonly>
        <input type="hidden" id="marka" name="marka" required>
        <div class="invalid-feedback">Marka zorunlu.</div>
      </div>
    </div>

    <!-- Model -->
    <div class="col-md-6">
      <label class="form-label">Model</label>
      <div class="input-group lookup-group">
        <button type="button" class="btn btn-outline-secondary lookup-btn" data-entity="model">&#9776;</button>
        <input id="model_display" type="text" class="form-control bg-body-tertiary" value="Seçilmedi" readonly>
        <input type="hidden" id="model" name="model" required>
        <div class="invalid-feedback">Model zorunlu.</div>
      </div>
    </div>

    <!-- Seri No -->
    <div class="col-md-6">
      <label class="form-label">Seri No</label>
      <input name="seri_no" type="text" class="form-control" required placeholder="SN123456789">
    </div>

    <!-- Sorumlu Personel -->
    <div class="col-md-6">
      <label class="form-label">Sorumlu Personel</label>
      <div class="input-group lookup-group">
        <button type="button" class="btn btn-outline-secondary lookup-btn" data-entity="sorumlu_personel">&#9776;</button>
        <input id="sorumlu_personel_display" type="text" class="form-control bg-body-tertiary" value="Seçilmedi" readonly>
        <input type="hidden" id="sorumlu_personel" name="sorumlu_personel" required>
        <div class="invalid-feedback">Sorumlu personel zorunlu.</div>
      </div>
    </div>

    <!-- Opsiyoneller -->
    <div class="col-md-6">
      <label class="form-label">Bağlı Makina No <small class="text-muted">(opsiyonel)</small></label>
      <input name="bagli_envanter_no" type="text" class="form-control" placeholder="Makina No">
    </div>
    <div class="col-md-6">
      <label class="form-label">IFS No <small class="text-muted">(opsiyonel)</small></label>
      <input name="ifs_no" type="text" class="form-control" placeholder="IFS-...">
    </div>
    <div class="col-12">
      <label class="form-label">Not <small class="text-muted">(opsiyonel)</small></label>
      <textarea name="notlar" class="form-control" rows="2" placeholder="Açıklama / notlar"></textarea>
    </div>
  </div>

  <div class="mt-3 d-flex gap-2">
    <button type="submit" class="btn btn-primary">Kaydet</button>
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
  </div>
</form>

<style>
  /* Sadece bu modal */
  #envanter-ekle .lookup-group .form-control[readonly]{cursor:pointer}
  #envanter-ekle .lookup-selected{ color: var(--bs-body-color)!important; }
</style>

<script>window.SKIP_SELECT_ENHANCE = true;</script>
<script>
(function(){
  // Şimdilik seçim penceresini prompt ile simüle ediyoruz.
  function openPicker(entity, current){
    const v = prompt(entity.toUpperCase() + " seçin:", current || "");
    return (v && v.trim()) ? { id:v.trim(), text:v.trim() } : null;
  }

  // ≡ butonu ve yanındaki display input tıklanınca aynı davranış
  document.querySelectorAll('#envanter-ekle .lookup-btn').forEach(btn=>{
    btn.addEventListener('click', ()=> handlePick(btn.dataset.entity));
  });
  document.querySelectorAll('#envanter-ekle .lookup-group .form-control[readonly]').forEach(view=>{
    const entity = view.id.replace('_display','');
    view.addEventListener('click', ()=> handlePick(entity));
  });

  function handlePick(entity){
    const hidden  = document.getElementById(entity);
    const display = document.getElementById(entity + '_display');
    const picked  = openPicker(entity, hidden?.value);
    if(!picked) return;

    hidden.value = picked.id;
    if(display){
      display.value = picked.text;
      display.classList.add('lookup-selected');
    }
    // Validasyon için (hidden boşsa invalid yap)
    hidden.setCustomValidity('');
  }

  // Submit öncesi: required hidden alanları kontrol et
  document.querySelector('form').addEventListener('submit', function(e){
    let ok = true;
    document.querySelectorAll('#envanter-ekle input[type="hidden"][required]').forEach(h=>{
      const display = document.getElementById(h.id + '_display');
      if(!h.value){
        ok = false;
        if(display){ display.classList.add('is-invalid'); }
      }else{
        if(display){ display.classList.remove('is-invalid'); }
      }
    });
    if(!ok){ e.preventDefault(); e.stopPropagation(); }
  });
})();
</script>
