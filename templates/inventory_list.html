{% extends "base.html" %} {% block title %}Envanter Listesi{% endblock %} {%
block content %}
<div id="inventory-list-root" class="stack-md">
  <div class="page-header">
    <div>
      <h1 class="page-title mb-0">Envanter</h1>
    </div>
    <div class="page-actions">
      <a
        href="#"
        id="addBtn"
        class="btn btn-success btn-sm d-flex align-items-center gap-1"
        title="Yeni Ekle"
      >
        <i class="bi bi-plus-lg"></i>
        <span>Ekle</span>
      </a>
      {% with fault_entity='inventory', fault_prefix='inventory',
      fault_label='Envanter Arızalı Durum' %} {% include
      'partials/_fault_controls.html' %} {% endwith %}
      <div class="dropdown">
        <button
          class="btn btn-outline-primary btn-sm dropdown-toggle"
          type="button"
          data-bs-toggle="dropdown"
          aria-expanded="false"
        >
          Excel
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li>
            <a class="dropdown-item" href="/inventory/export">Dışa Aktar</a>
          </li>
          <li>
            <form
              action="/inventory/import"
              method="post"
              enctype="multipart/form-data"
            >
              <input
                type="file"
                name="file"
                id="invExcel"
                class="d-none"
                onchange="this.form.submit()"
              />
              <label for="invExcel" class="dropdown-item mb-0">İçe Aktar</label>
            </form>
          </li>
        </ul>
      </div>
      <button class="btn btn-outline-secondary btn-sm" id="filterBtn">
        Filtre
      </button>
      <button
        class="btn btn-outline-secondary btn-sm d-none"
        id="clearFilterBtn"
      >
        Temizle
      </button>
      <input
        type="text"
        id="searchInput"
        class="form-control form-control-sm"
        placeholder="Ara..."
      />
    </div>
  </div>

  <div class="soft-card p-0">
    <div class="table-responsive">
      <table class="table table-sm table-striped align-middle table-rounded mb-0">
        <thead>
          <tr>
            <th data-field="no">Envanter No</th>
            <th data-field="fabrika">Fabrika</th>
            <th data-field="departman">Departman</th>
            <th data-field="sorumlu_personel">Sorumlu</th>
            <th data-field="marka">Marka/Model</th>
            <th style="width: 180px">İşlemler</th>
          </tr>
        </thead>
        <tbody>
          {% for row in items %}
          <tr
            data-id="{{ row.id }}"
            data-fabrika="{{ row.fabrika or '' }}"
            data-departman="{{ row.departman or '' }}"
            data-sorumlu="{{ row.sorumlu_personel or '' }}"
            data-bagli="{{ row.bagli_envanter_no or '' }}"
            class="inv-row{% if row.durum == 'arızalı' %} table-warning{% endif %}"
          >
            <td>
              {{ row.no }} {% if row.durum == 'arızalı' %}
              <span class="badge text-bg-warning text-dark ms-1">Arızalı</span>
              {% endif %}
            </td>
            <td>{{ row.fabrika }}</td>
            <td>{{ row.departman }}</td>
            <td>{{ row.sorumlu_personel }}</td>
            <td>{{ row.marka }} {{ row.model }}</td>
            <td class="text-nowrap">
              {% set entity = 'inventory' %} {% set row_id = row.id %} {% set
              fault_mode = True %} {% set fault_device = row.no %} {% set
              fault_title = (row.marka ~ ' ' ~ row.model)|trim %} {% set
              fault_entity_key = row.no %} {% set fault_status = row.durum %} {%
              include 'partials/_actions_menu.html' %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
  /* Satırın tamamı tıklanmasın */
  tr.inv-row {
    cursor: default;
  }
  tr.inv-row a,
  tr.inv-row button,
  tr.inv-row select {
    cursor: pointer;
  }
</style>

<!-- Envanter Ekle Modal -->
<div
  class="modal fade modal-elevated"
  id="inventoryCreateModal"
  tabindex="-1"
  aria-hidden="true"
>
  <div
    class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"
  >
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Envanter Ekle</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Kapat"
        ></button>
      </div>

      <div class="modal-body">
        <form
          method="post"
          action="/inventory/create"
          id="envanter-form"
          class="stack-md"
          novalidate
        >
          <div class="form-grid form-grid-2" id="envanter-ekle">
            <div class="form-field">
              <label>Envanter No</label>
              <input
                name="envanter_no"
                type="text"
                class="form-control"
                required
                placeholder="ENV-000123"
              />
            </div>
            <div class="form-field">
              <label>Bilgisayar Adı</label>
              <input
                name="bilgisayar_adi"
                type="text"
                class="form-control"
                required
                placeholder="PC-OFIS-01"
              />
            </div>
            <div class="form-field">
              <label>Fabrika</label>
              <select
                name="fabrika"
                id="fabrika"
                class="form-select"
                required
              ></select>
            </div>
            <div class="form-field">
              <label>Departman</label>
              <select
                name="departman"
                id="departman"
                class="form-select"
                required
              ></select>
            </div>
            <div class="form-field">
              <label>Donanım Tipi</label>
              <select
                name="donanim_tipi"
                id="donanim_tipi"
                class="form-select"
                required
              ></select>
            </div>
            <div class="form-field">
              <label>Sorumlu Personel</label>
              <select
                name="sorumlu_personel"
                id="sorumlu_personel"
                class="form-select"
                required
              ></select>
            </div>
            <div class="form-field">
              <label>Marka</label>
              <select
                name="marka"
                id="marka"
                class="form-select"
                required
              ></select>
            </div>
            <div class="form-field">
              <label>Model</label>
              <select
                name="model"
                id="model"
                class="form-select"
                required
                disabled
              >
                <option value="">Önce marka seçiniz...</option>
              </select>
            </div>
            <div class="form-field">
              <label>Seri No</label>
              <input
                name="seri_no"
                type="text"
                class="form-control"
                required
                placeholder="SN123456789"
              />
            </div>
            <div class="form-field">
              <label>Kullanım Alanı</label>
              <select
                name="kullanim_alani"
                id="kullanim_alani"
                class="form-select"
                required
              ></select>
            </div>
            <div class="form-field">
              <label>IFS No <span class="form-hint">(zorunlu değil)</span></label>
              <input
                name="ifs_no"
                type="text"
                class="form-control"
                placeholder="IFS-..."
              />
            </div>
            <div class="form-field">
              <label>Bağlı Makina No <span class="form-hint">(zorunlu değil)</span></label>
              <input
                name="bagli_makina_no"
                type="text"
                class="form-control"
                placeholder="Makina No"
              />
            </div>
            <div class="form-field form-span-2">
              <label>Not <span class="form-hint">(zorunlu değil)</span></label>
              <textarea
                name="notlar"
                class="form-control"
                rows="2"
                placeholder="Açıklama / notlar"
              ></textarea>
            </div>
          </div>

          <div class="d-flex flex-wrap justify-content-end gap-2">
            <button type="submit" class="btn btn-primary">Kaydet</button>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              İptal
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Atama Modal -->
<div class="modal fade modal-elevated" id="assignModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <form id="assignForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Envanter Atama</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="item_id" id="assign_item_id" />
        <div class="form-grid form-grid-auto">
          <div class="form-field">
            <label>Fabrika</label>
            <select name="fabrika" id="selFabrika" class="form-select"></select>
          </div>
          <div class="form-field">
            <label>Departman</label>
            <select
              name="departman"
              id="selDepartman"
              class="form-select"
            ></select>
          </div>
          <div class="form-field">
            <label>Sorumlu Personel</label>
            <select
              name="sorumlu_personel"
              id="selPersonel"
              class="form-select"
            ></select>
          </div>
          <div class="form-field">
            <label>Bağlı Olduğu Envanter</label>
            <select
              name="bagli_envanter_no"
              id="selBagli"
              class="form-select"
            ></select>
          </div>
        </div>
      </div>
      <div class="modal-footer justify-content-end gap-2">
        <button class="btn btn-primary" type="submit">Atamayı Kaydet</button>
      </div>
    </form>
  </div>
</div>

<!-- Hurdaya Ayır Modal -->
<div class="modal fade modal-elevated" id="scrapModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="scrapForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Hurdaya Ayır</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="item_id" id="scrap_item_id" />
        <p>Bu envanter hurdaya ayrılacak. Onaylıyor musunuz?</p>
        <div class="mb-2">
          <label class="form-label">Açıklama (opsiyonel)</label>
          <textarea
            name="aciklama"
            class="form-control"
            rows="3"
            placeholder="Hurda sebebi / not"
          ></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">
          Vazgeç
        </button>
        <button class="btn btn-danger" type="submit">Hurdaya Ayır</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const assignModal = new bootstrap.Modal(
      document.getElementById("assignModal"),
    );
    const scrapModal = new bootstrap.Modal(
      document.getElementById("scrapModal"),
    );
    const addModal = new bootstrap.Modal(
      document.getElementById("inventoryCreateModal"),
    );
    const filterModal = new bootstrap.Modal(
      document.getElementById("filterModal"),
    );

    const searchInput = document.getElementById("searchInput");
    const filterForm = document.getElementById("filterForm");
    const clearBtn = document.getElementById("clearFilterBtn");
    const filterRowsDiv = document.getElementById("filterRows");
    const distinctUrl =
      "{{ url_for('lookup.distinct', entity='inventory', column='__COL__') }}";
    let activeFilters = [];
    const columns = Array.from(document.querySelectorAll("table thead th"))
      .map((th, idx) => ({
        idx,
        name: th.textContent.trim(),
        field: th.dataset.field,
      }))
      .filter((c) => c.field);

    // Envanter ekleme formundaki dropdown'ları doldur
    (async function () {
      async function loadOptions(sel, url) {
        const res = await fetch(url);
        const data = await res.json();
        sel.innerHTML =
          '<option value="">Seçiniz...</option>' +
          data
            .map(
              (o) =>
                `<option value="${o.text}" data-id="${o.id}">${o.text}</option>`,
            )
            .join("");
      }

      const fabrikaSel = document.getElementById("fabrika");
      const departmanSel = document.getElementById("departman");
      const donanimSel = document.getElementById("donanim_tipi");
      const personelSel = document.getElementById("sorumlu_personel");
      const markaSel = document.getElementById("marka");
      const modelSel = document.getElementById("model");

      await loadOptions(fabrikaSel, "/api/picker/fabrika");
      await loadOptions(departmanSel, "/api/picker/kullanim_alani");
      await loadOptions(donanimSel, "/api/picker/donanim_tipi");
      await _selects.fillChoices({
        endpoint: "/api/picker/kullanici",
        selectId: "sorumlu_personel",
        mapFn: (r) => ({ value: r.text, label: r.text }),
      });
      _selects.enableRemoteSearch(
        "sorumlu_personel",
        "/api/picker/kullanici",
        () => ({}),
        (r) => ({ value: r.text, label: r.text }),
      );

      const brandRes = await fetch("/api/picker/marka");
      const brands = await brandRes.json();
      markaSel.innerHTML =
        '<option value="">Seçiniz...</option>' +
        brands
          .map(
            (b) =>
              `<option value="${b.text}" data-id="${b.id}">${b.text}</option>`,
          )
          .join("");

      markaSel.addEventListener("change", async () => {
        const opt = markaSel.options[markaSel.selectedIndex];
        const brandId = opt && opt.dataset.id;
        modelSel.innerHTML = '<option value="">Seçiniz...</option>';
        modelSel.disabled = !brandId;
        if (!brandId) return;
        const res = await fetch(`/api/picker/model?marka_id=${brandId}`);
        const models = await res.json();
        modelSel.innerHTML += models
          .map((m) => `<option value="${m.text}">${m.text}</option>`)
          .join("");
      });
    })();

    document.getElementById("addBtn").addEventListener("click", () => {
      addModal.show();
    });

    document.getElementById("filterBtn").addEventListener("click", () => {
      filterForm.reset();
      filterRowsDiv.innerHTML = "";
      createFilterRow();
      filterModal.show();
    });

    clearBtn.addEventListener("click", () => {
      activeFilters = [];
      filterRows();
      clearBtn.classList.add("d-none");
    });

    searchInput.addEventListener("input", filterRows);

    function createFilterRow() {
      const row = document.createElement("div");
      row.className = "row g-2 align-items-center mb-2 filter-row";
      row.innerHTML = `
      <div class="col-5">
        <select class="form-select form-select-sm column-select">
          ${columns.map((c) => `<option value="${c.idx}">${c.name}</option>`).join("")}
        </select>
      </div>
      <div class="col-5">
        <select class="form-select form-select-sm value-select"></select>
      </div>
      <div class="col-2 d-flex gap-1">
        <button type="button" class="btn btn-success btn-sm add-row">+</button>
        <button type="button" class="btn btn-danger btn-sm remove-row">-</button>
      </div>`;
      filterRowsDiv.appendChild(row);
      const colSel = row.querySelector(".column-select");
      const valSel = row.querySelector(".value-select");
      loadValues(colSel, valSel);
      colSel.addEventListener("change", () => loadValues(colSel, valSel));
      updateRemoveButtons();
    }

    async function loadValues(colSelect, valSelect) {
      const col = columns.find((c) => c.idx == colSelect.value);
      const res = await fetch(distinctUrl.replace("__COL__", col.field));
      const data = await res.json();
      valSelect.innerHTML =
        '<option value="">Seçiniz</option>' +
        data.map((v) => `<option value="${v}">${v}</option>`).join("");
    }

    function updateRemoveButtons() {
      const rows = filterRowsDiv.querySelectorAll(".filter-row");
      rows.forEach((r) =>
        r
          .querySelector(".remove-row")
          .classList.toggle("d-none", rows.length === 1),
      );
    }

    filterForm.addEventListener("click", (e) => {
      if (e.target.classList.contains("add-row")) {
        createFilterRow();
      } else if (e.target.classList.contains("remove-row")) {
        e.target.closest(".filter-row").remove();
        updateRemoveButtons();
      }
    });

    filterForm.addEventListener("submit", (e) => {
      e.preventDefault();
      activeFilters = [];
      filterRowsDiv.querySelectorAll(".filter-row").forEach((row) => {
        const col = parseInt(row.querySelector(".column-select").value, 10);
        const val = row
          .querySelector(".value-select")
          .value.trim()
          .toLowerCase();
        if (val) activeFilters.push({ col, val });
      });
      filterModal.hide();
      clearBtn.classList.toggle("d-none", activeFilters.length === 0);
      filterRows();
    });

    function filterRows() {
      const q = searchInput.value.toLowerCase();
      document.querySelectorAll("tbody tr").forEach((tr) => {
        const cells = tr.querySelectorAll("td");
        const texts = Array.from(cells).map((td) =>
          td.textContent.toLowerCase(),
        );
        let match = texts.some((t) => t.includes(q));
        if (activeFilters.length) {
          match =
            match &&
            activeFilters.every(
              (f) => texts[f.col] && texts[f.col].includes(f.val),
            );
        }
        tr.classList.toggle("d-none", !match);
      });
    }

    // İşlem seçimi
    document.querySelectorAll(".action-select").forEach((sel) => {
      sel.addEventListener("change", async (e) => {
        const val = e.target.value;
        if (!val) return;
        const id = e.target.dataset.id;
        if (!id) return;

        if (val === "assign") {
          e.stopImmediatePropagation();
          const tr = e.target.closest("tr");
          document.getElementById("assign_item_id").value = id;
          await preloadAssignDropdowns(id);
          if (tr) {
            setSelectValue("selFabrika", tr.dataset.fabrika);
            setSelectValue("selDepartman", tr.dataset.departman);
            setSelectValue("selPersonel", tr.dataset.sorumlu);
            setSelectValue("selBagli", tr.dataset.bagli);
          }
          assignModal.show();
          e.target.value = "";
          return;
        }

        if (val === "fault") {
          if (window.Faults) {
            e.stopImmediatePropagation();
            window.Faults.openMarkModal("inventory", {
              entityId: Number(id),
              entityKey:
                e.target.dataset.entityKey || e.target.dataset.device || id,
              deviceNo: e.target.dataset.device || "",
              title: e.target.dataset.title || "",
            });
          }
          e.target.value = "";
          return;
        }

        if (val === "repair") {
          if (window.Faults) {
            e.stopImmediatePropagation();
            window.Faults.openRepairModal("inventory", {
              entityId: Number(id),
              entityKey:
                e.target.dataset.entityKey || e.target.dataset.device || id,
              deviceNo: e.target.dataset.device || "",
            });
          }
          e.target.value = "";
          return;
        }

        if (val === "scrap") {
          e.stopImmediatePropagation();
          document.getElementById("scrap_item_id").value = id;
          scrapModal.show();
          e.target.value = "";
        }
      });
    });

    async function preloadAssignDropdowns(itemId) {
      const [fabr, dept, users, invs] = await Promise.all([
        fetch(`{{ url_for('inventory.assign_sources') }}?type=fabrika`).then(
          (r) => r.json(),
        ),
        fetch(`{{ url_for('inventory.assign_sources') }}?type=departman`).then(
          (r) => r.json(),
        ),
        fetch(`{{ url_for('inventory.assign_sources') }}?type=users`).then(
          (r) => r.json(),
        ),
        fetch(
          `{{ url_for('inventory.assign_sources') }}?type=envanter&exclude_id=` +
            itemId,
        ).then((r) => r.json()),
      ]);
      fillSelect("selFabrika", fabr);
      fillSelect("selDepartman", dept);
      fillSelect("selPersonel", users);
      fillSelect("selBagli", invs);
    }
    function fillSelect(id, arr) {
      const el = document.getElementById(id);
      el.innerHTML =
        '<option value="">Seçiniz</option>' +
        arr.map((x) => `<option value="${x.id}">${x.text}</option>`).join("");
    }

    function setSelectValue(selectId, value) {
      const el = document.getElementById(selectId);
      if (!el) return;
      const val = value || "";
      if (val && !Array.from(el.options).some((opt) => opt.value === val)) {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        el.appendChild(opt);
      }
      el.value = val;
    }

    // Atama submit
    document
      .getElementById("assignForm")
      .addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const res = await fetch(`{{ url_for('inventory.assign') }}`, {
          method: "POST",
          body: fd,
        });
        if (res.ok) location.reload();
        else alert("Atama kaydedilemedi");
      });

    // Hurda submit
    document
      .getElementById("scrapForm")
      .addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const res = await fetch(`{{ url_for('inventory.scrap') }}`, {
          method: "POST",
          body: fd,
        });
        if (res.ok)
          window.location.href = `{{ url_for('inventory.hurdalar') }}`;
        else alert("Hurdaya ayırma başarısız");
      });
  });
</script>
{% endblock %}
