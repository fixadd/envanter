{% extends "base.html" %}
{% block title %}Envanter Listesi{% endblock %}
{% block content %}
<div class="container-fluid p-2">
  <h5 class="mb-3">Envanter</h5>

  <table class="table table-sm table-striped align-middle">
    <thead>
      <tr>
        <th style="width:42px;"></th> <!-- göz ikonu -->
        <!-- Örnek kolon başlıkları -->
        <th>Envanter No</th>
        <th>Fabrika</th>
        <th>Departman</th>
        <th>Sorumlu</th>
        <th>Marka/Model</th>
        <th style="width:180px;">İşlemler</th>
      </tr>
    </thead>
    <tbody>
      {% for row in items %}
      <tr data-id="{{ row.id }}" class="inv-row">
        <td class="text-center">
          <a class="btn btn-sm btn-outline-secondary"
             href="{{ url_for('inventory.detail', item_id=row.id) }}"
             title="Görüntüle">
            <i class="bi bi-eye"></i>
          </a>
        </td>

        <td>{{ row.no }}</td>
        <td>{{ row.fabrika }}</td>
        <td>{{ row.departman }}</td>
        <td>{{ row.sorumlu_personel }}</td>
        <td>{{ row.marka }} {{ row.model }}</td>

        <td>
          <select class="form-select form-select-sm action-select" data-id="{{ row.id }}">
            <option value="" selected>İşlem Seç...</option>
            <option value="assign">Atama Yap</option>
            <option value="edit">Düzenle</option>
            <option value="scrap">Hurdaya Ayır</option>
          </select>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<style>
  /* Satırın tamamı tıklanmasın */
  tr.inv-row { cursor: default; }
  tr.inv-row a, tr.inv-row button, tr.inv-row select { cursor: pointer; }
</style>

<!-- Atama Modal -->
<div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="assignForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Envanter Atama</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body row g-3">
        <input type="hidden" name="item_id" id="assign_item_id">
        <div class="col-md-3">
          <label class="form-label">Fabrika</label>
          <select name="fabrika" id="selFabrika" class="form-select"></select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Departman</label>
          <select name="departman" id="selDepartman" class="form-select"></select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Sorumlu Personel</label>
          <select name="sorumlu_personel" id="selPersonel" class="form-select"></select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Bağlı Olduğu Envanter</label>
          <select name="bagli_envanter_no" id="selBagli" class="form-select"></select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" type="submit">Atamayı Kaydet</button>
      </div>
    </form>
  </div>
</div>

<!-- Hurdaya Ayır Modal -->
<div class="modal fade" id="scrapModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="scrapForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Hurdaya Ayır</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="item_id" id="scrap_item_id">
        <p>Bu envanter hurdaya ayrılacak. Onaylıyor musunuz?</p>
        <div class="mb-2">
          <label class="form-label">Açıklama (opsiyonel)</label>
          <textarea name="aciklama" class="form-control" rows="3"
            placeholder="Hurda sebebi / not"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Vazgeç</button>
        <button class="btn btn-danger" type="submit">Hurdaya Ayır</button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const assignModal = new bootstrap.Modal(document.getElementById('assignModal'));
  const scrapModal  = new bootstrap.Modal(document.getElementById('scrapModal'));

  // İşlem seçimi
  document.querySelectorAll('.action-select').forEach(sel => {
    sel.addEventListener('change', async (e) => {
      const id = e.target.dataset.id;
      const val = e.target.value;
      if (!val) return;

      if (val === 'assign') {
        await preloadAssignDropdowns(id);
        document.getElementById('assign_item_id').value = id;
        assignModal.show();
      } else if (val === 'edit') {
        window.location.href = `{{ url_for('inventory.edit', item_id='__ID__') }}`.replace('__ID__', id);
      } else if (val === 'scrap') {
        document.getElementById('scrap_item_id').value = id;
        scrapModal.show();
      }
      e.target.value = '';
    });
  });

  async function preloadAssignDropdowns(itemId) {
    const [fabr, dept, users, invs] = await Promise.all([
      fetch(`{{ url_for('inventory.assign_sources') }}?type=fabrika`).then(r=>r.json()),
      fetch(`{{ url_for('inventory.assign_sources') }}?type=departman`).then(r=>r.json()),
      fetch(`{{ url_for('inventory.assign_sources') }}?type=users`).then(r=>r.json()),
      fetch(`{{ url_for('inventory.assign_sources') }}?type=envanter&exclude_id=` + itemId).then(r=>r.json()),
    ]);
    fillSelect('selFabrika', fabr);
    fillSelect('selDepartman', dept);
    fillSelect('selPersonel', users);
    fillSelect('selBagli', invs);
  }
  function fillSelect(id, arr) {
    const el = document.getElementById(id);
    el.innerHTML = '<option value="">Seçiniz</option>' + arr.map(x =>
      `<option value="${x.value}">${x.label}</option>`).join('');
  }

  // Atama submit
  document.getElementById('assignForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const res = await fetch(`{{ url_for('inventory.assign') }}`, { method: 'POST', body: fd });
    if (res.ok) location.reload(); else alert('Atama kaydedilemedi');
  });

  // Hurda submit
  document.getElementById('scrapForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const res = await fetch(`{{ url_for('inventory.scrap') }}`, { method: 'POST', body: fd });
    if (res.ok) window.location.href = `{{ url_for('inventory.hurdalar') }}`;
    else alert('Hurdaya ayırma başarısız');
  });
});
</script>
{% endblock %}
