<div class="env-grid">
  <div class="field">
    <label>Donanım Tipi</label>
    <select id="saDonanim" class="ctrl" required></select>
  </div>
  <div class="field">
    <label>IFS No</label>
    <select id="saIfs" class="ctrl">
      <option value="">(Otomatik/tekse seçilmez)</option>
    </select>
  </div>
  <div class="field">
    <label>Miktar</label>
    <input id="saMiktar" type="number" min="1" class="ctrl" required />
    <div class="text-muted small" id="saMaxInfo"></div>
  </div>
  <div class="field">
    <label>Hedef Tür</label>
    <select id="saHedefTur" class="ctrl" required>
      <option value="envanter">Envanter</option>
      <option value="lisans">Lisans</option>
      <option value="yazici">Yazıcı</option>
    </select>
  </div>
  <div class="field">
    <label>Hedef Envanter No (ops)</label>
    <input id="saHedefEnv" type="text" class="ctrl" />
  </div>
  <div class="field">
    <label>Sorumlu Personel</label>
    <select id="saPersonel" class="ctrl">
      <option value="">Seçiniz</option>
    </select>
  </div>
  <div class="field">
    <label>Kullanım Alanı</label>
    <select id="saKullanim" class="ctrl">
      <option value="">Seçiniz</option>
    </select>
  </div>
</div>
<script>
  let STATUS = { totals: {}, detail: {} };
  const el = (id) => document.getElementById(id);
  function loadStatus() {
    return fetch("/api/stock/detail")
      .then((r) => r.json())
      .then((s) => {
        STATUS = s;
        const sel = el("saDonanim");
        sel.innerHTML = "";
        Object.keys(s.totals).forEach((dt) => {
          const o = document.createElement("option");
          o.value = o.textContent = `${dt} (stok: ${s.totals[dt]})`;
          sel.appendChild(o);
        });
        onDonanimChange();
      });
  }
  function onDonanimChange() {
    const dt = el("saDonanim").value.split(" (")[0];
    const max = STATUS.totals[dt] || 0;
    el("saMiktar").max = max;
    el("saMaxInfo").textContent = `Maksimum: ${max}`;
    const ifsSel = el("saIfs");
    ifsSel.innerHTML = '<option value="">(Otomatik/tekse seçilmez)</option>';
    const detail = STATUS.detail[dt] || {};
    Object.keys(detail).forEach((ifs) => {
      const o = document.createElement("option");
      o.value = ifs;
      o.textContent = `${ifs} (${detail[ifs]})`;
      ifsSel.appendChild(o);
    });
  }
  el("saDonanim").addEventListener("change", onDonanimChange);
  // kullanıcı ve kullanım alanı
  fetch("/api/users/names")
    .then((r) => r.json())
    .then((list) => {
      const sel = el("saPersonel");
      list.forEach((n) => {
        const o = document.createElement("option");
        o.value = o.textContent = n;
        sel.appendChild(o);
      });
    });
  fetch("/api/lookup/kullanim_alani")
    .then((r) => r.json())
    .then((list) => {
      const sel = el("saKullanim");
      list.forEach((n) => {
        const o = document.createElement("option");
        o.value = o.textContent = n;
        sel.appendChild(o);
      });
    });
  loadStatus();
  async function submitAssign() {
    const body = {
      donanim_tipi: el("saDonanim").value.split(" (")[0],
      miktar: Number(el("saMiktar").value),
      ifs_no: el("saIfs").value || null,
      hedef_tur: el("saHedefTur").value,
      hedef_envanter_no: el("saHedefEnv").value || null,
      sorumlu_personel: el("saPersonel").value || null,
      kullanim_alani: el("saKullanim").value || null,
    };
    if (body.miktar > Number(el("saMiktar").max)) {
      alert("Miktar stoktan fazla");
      return;
    }
    const r = await fetch("/api/stock/assign", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });
    if (!r.ok) {
      const e = await r.json();
      alert(e.detail || "Hata");
      return;
    }
    alert("Atama başarılı");
    loadStatus();
  }
</script>
