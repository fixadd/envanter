{% extends "base.html" %}
{% block title %}Stok Logları{% endblock %}

{% block content %}
<div class="container-fluid p-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h5 class="mb-0">Stok Logları (En Güncel)</h5>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-info btn-sm" type="button"
              data-bs-toggle="modal" data-bs-target="#stockStatusModal">
        Stok Durumu
      </button>
      <button class="btn btn-success btn-sm d-flex align-items-center gap-1" title="Yeni Ekle" data-bs-toggle="modal" data-bs-target="#modalStockAdd">
        <i class="bi bi-plus-lg"></i>
        <span>Ekle</span>
      </button>
      <div class="dropdown">
        <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          Excel
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="/stock/export">Dışa Aktar</a></li>
          <li>
            <form action="/stock/import" method="post" enctype="multipart/form-data">
              <input type="file" name="file" id="stockExcel" class="d-none" onchange="this.form.submit()">
              <label for="stockExcel" class="dropdown-item mb-0">İçe Aktar</label>
            </form>
          </li>
        </ul>
      </div>
      <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#stokAtamaModal">Atama</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead class="table-light">
        <tr>
          <th style="width:72px;">ID</th>
          <th>Donanım Tipi</th>
          <th>Miktar</th>
          <th>IFS No</th>
          <th>Tarih</th>
          <th>İşlem</th>
          <th>İşlem Yapan</th>
        </tr>
      </thead>
      <tbody>
        {% for r in logs %}
        <tr>
          <td>#{{ r.id }}</td>
          <td>{{ r.donanim_tipi }}</td>
          <td>{{ r.miktar }}</td>
          <td>{{ r.ifs_no or '-' }}</td>
          <td>{{ (r.tarih).strftime("%d.%m.%Y %H:%M") if r.tarih else '-' }}</td>
          <td>
            {% if r.islem == 'girdi' %}<span class="badge text-bg-success">Girdi</span>
            {% elif r.islem == 'cikti' %}<span class="badge text-bg-warning">Çıktı</span>
            {% else %}<span class="badge text-bg-secondary">Atama</span>{% endif %}
          </td>
          <td>{{ r.actor or '-' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- STOK DURUMU MODALI -->
<div class="modal fade" id="stockStatusModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Stok Durumu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-sm" id="tblStockStatus">
            <thead class="table-light">
              <tr>
                <th>Donanım Tipi</th>
                <th>Stok</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- STOK EKLE MODALI -->
<div class="modal fade" id="modalStockAdd" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="frmStockAdd" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Stok Ekle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body row g-3">
        <div class="col-12">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="chkIsLicense" name="is_license">
            <label class="form-check-label" for="chkIsLicense">Lisans</label>
          </div>
        </div>

        <div id="hardwareFields" class="col-12 row g-3">
          <div class="col-md-4">
            <label class="form-label">Donanım Tipi</label>
            <select id="stok_donanim_tipi" name="donanim_tipi" class="form-select" required></select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Marka (opsiyonel)</label>
            <select id="stok_marka" name="marka" class="form-select"></select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Model (opsiyonel)</label>
            <select id="stok_model" name="model" class="form-select"></select>
          </div>
          <div class="col-md-2" id="rowMiktar">
            <label class="form-label">Miktar</label>
            <input type="number" min="1" id="miktar" name="miktar" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">IFS No (opsiyonel)</label>
            <input type="text" id="ifs_no" name="ifs_no" class="form-control">
          </div>
        </div>

        <div id="licenseFields" class="col-12 row g-3 d-none">
          <div class="col-md-4">
            <label class="form-label">Lisans Adı</label>
            <select id="lisans_adi" name="lisans_adi" class="form-select" required></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Lisans Anahtarı</label>
            <input type="text" id="lisans_anahtari" name="lisans_anahtari" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">E-posta (opsiyonel)</label>
            <input type="email" id="mail_adresi" name="mail_adresi" class="form-control">
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
        <button class="btn btn-primary" type="submit">Kaydet</button>
      </div>
    </form>
  </div>
</div>

<!-- STOK ATAMA MODALI -->
<div class="modal fade" id="stokAtamaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Stok Atama</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>

      <div class="modal-body">
        <form id="stockAssignForm" class="vstack gap-3">
          <!-- 1) STOK SEÇ (Stok Durumu'ndan) -->
          <div>
            <label class="form-label fw-semibold">Stok Seç</label>
            <select id="sa_stock" class="form-select" required>
              <option value="">Seçiniz...</option>
            </select>
            <div id="sa_stock_meta" class="small text-muted mt-1 d-none">
              <span id="sa_meta_tip"></span> ·
              IFS: <span id="sa_meta_ifs"></span> ·
              Mevcut: <span id="sa_meta_qty"></span>
            </div>
          </div>

          <!-- 2) Atama Türü -->
          <div>
            <label class="form-label fw-semibold">Atama Türü</label>
            <ul class="nav nav-tabs" id="sa_tabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#sa_tab_lisans" type="button" role="tab">Lisans</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#sa_tab_envanter" type="button" role="tab">Envanter</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#sa_tab_yazici" type="button" role="tab">Yazıcı</button>
              </li>
            </ul>

            <div class="tab-content border border-top-0 p-3 rounded-bottom">
              <!-- LISANS -->
              <div class="tab-pane fade show active" id="sa_tab_lisans" role="tabpanel">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Lisans</label>
                    <select id="sa_lisans" class="form-select">
                      <option value="">Seçiniz...</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Sorumlu Personel</label>
                    <select id="sa_user" class="form-select">
                      <option value="">Seçiniz...</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Bağlı Envanter (opsiyonel)</label>
                    <select id="sa_envanter_for_lic" class="form-select">
                      <option value="">Seçiniz...</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- ENVANTER -->
              <div class="tab-pane fade" id="sa_tab_envanter" role="tabpanel">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Hedef Envanter</label>
                    <select id="sa_envanter" class="form-select">
                      <option value="">Seçiniz...</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Sorumlu Personel (opsiyonel)</label>
                    <select id="sa_user2" class="form-select">
                      <option value="">Seçiniz...</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- YAZICI -->
              <div class="tab-pane fade" id="sa_tab_yazici" role="tabpanel">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Hedef Yazıcı</label>
                    <select id="sa_yazici" class="form-select">
                      <option value="">Seçiniz...</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 3) Genel Alanlar -->
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Miktar</label>
              <input id="sa_miktar" type="number" class="form-control" value="1" min="1">
            </div>
            <div class="col-md-8">
              <label class="form-label">Notlar (opsiyonel)</label>
              <input id="sa_not" type="text" class="form-control" placeholder="İsteğe bağlı açıklama">
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
        <button id="sa_submit" class="btn btn-primary">Atamayı Yap</button>
  </div>
  </div>
</div>
</div>
</div>

<!-- Lookup ile doldurulacak örnek selectler -->
<div class="d-none" id="lookup-demo-selects">
  <select id="stok_durumu_select" class="form-select" name="stok_durumu"></select>
  <select id="islem_select" class="form-select" name="islem"></select>
  <select id="donanim_tipi_select" class="form-select" name="donanim_tipi"></select>
  <!-- <select id="ifs_no_select" class="form-select" name="ifs_no"></select> -->
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/stock.js"></script>
<script>
async function fillSelect(id, entity) {
  const el = document.getElementById(id);
  if (!el) return;
  el.innerHTML = '<option value="">Yükleniyor...</option>';
  try {
    const r = await fetch(`/api/lookup/${entity}`);
    if (!r.ok) throw new Error(await r.text());
    const data = await r.json();
    el.innerHTML = '<option value="">Seçiniz…</option>' + (data || []).map(v => `<option value="${v}">${v}</option>`).join('');
  } catch (e) {
    console.error(e);
    el.innerHTML = '<option value="">(Veri Yok)</option>';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  fillSelect('stok_durumu_select', 'stok_durumu');
  fillSelect('islem_select', 'islem');
  fillSelect('donanim_tipi_select', 'donanim_tipi');
  // fillSelect('ifs_no_select', 'ifs_no');
});
</script>
<script>
// Basit fetch helper
async function getLookup(entity) {
  try {
    const r = await fetch(`/api/lookup/${encodeURIComponent(entity)}`);
    if (!r.ok) return [];
    return await r.json();
  } catch (_) {
    return [];
  }
}

// Select'e seçenek yazan helper
function setOptions(selectEl, items) {
  if (!selectEl) return;

  // Düz <select> içeriği
  const html = ['<option value="">Seçiniz…</option>']
    .concat(items.map(v => `<option value="${v}">${v}</option>`))
    .join('');
  selectEl.innerHTML = html;

  // Eğer Select2 kullanıyorsan yeniden kur
  if (window.jQuery && jQuery(selectEl).data('select2')) {
    jQuery(selectEl).off('select2:select');          // olası eski event'leri temizle
    jQuery(selectEl).select2('destroy');             // eski instance'ı yok et
    jQuery(selectEl).select2({
      width: '100%',
      language: {
        noResults: () => 'Seçenek yok',
        searching: () => 'Aranıyor…'
      }
    });
  }

  // Eğer Choices.js kullanıyorsan:
  if (selectEl.classList.contains('choices')) {
    // basit bir reset için:
    selectEl._choices && selectEl._choices.destroy && selectEl._choices.destroy();
    const choices = items.map(v => ({ value: v, label: v }));
    // global Choices varsa:
    if (window.Choices) {
      selectEl._choices = new Choices(selectEl, { searchEnabled: true, shouldSort: true, itemSelectText: '' });
      // mevcut “Seçiniz…” kalsın, diğerlerini ekle
      choices.forEach(c => selectEl._choices.setChoices([c], 'value', 'label', false));
    }
  }
}

// Modal açıldığında doldur
document.addEventListener('DOMContentLoaded', () => {
  const modal = document.getElementById('modalStockAdd'); // Modal id’n bu olmalı
  if (!modal) return;

  modal.addEventListener('shown.bs.modal', async () => {
    const donanimSel = document.getElementById('stok_donanim_tipi');
    const markaSel   = document.getElementById('stok_marka');
    const modelSel   = document.getElementById('stok_model');

    // Paralel çek
    const [donanimlar, markalar, modeller] = await Promise.all([
      getLookup('donanim_tipi'),
      getLookup('marka'),
      getLookup('model')
    ]);

    setOptions(donanimSel, donanimlar);
    setOptions(markaSel, markalar);
    setOptions(modelSel, modeller);
  });

  // Eğer modal içeriği dinamik yükleniyorsa (HTMX/AJAX),
  // butona tıklayınca da zorla açılışta doldurt:
  const openBtn = document.querySelector('[data-bs-target="#modalStockAdd"]');
  if (openBtn) {
    openBtn.addEventListener('click', () => {
      // Bootstrap modal açılınca zaten shown.bs.modal ateşlenecek
      // burada ekstra işleme gerek yok.
    });
  }
});
</script>
{% endblock %}

