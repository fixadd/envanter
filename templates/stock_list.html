{% extends "base.html" %}
{% block title %}Stok Takibi{% endblock %}

{% block content %}
<div class="container-fluid p-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h5 class="mb-0">Stok Takibi</h5>
    <div class="d-flex gap-2">
      <button class="btn btn-success btn-sm d-flex align-items-center gap-1" title="Yeni Ekle" data-bs-toggle="modal" data-bs-target="#modalStockAdd">
        <i class="bi bi-plus-lg"></i>
        <span>Ekle</span>
      </button>
      <div class="dropdown">
        <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          Excel
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="/stock/export">Dışa Aktar</a></li>
          <li>
            <form action="/stock/import" method="post" enctype="multipart/form-data">
              <input type="file" name="file" id="stockExcel" class="d-none" onchange="this.form.submit()">
              <label for="stockExcel" class="dropdown-item mb-0">İçe Aktar</label>
            </form>
          </li>
        </ul>
      </div>
      <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#stokAtamaModal">Atama</button>
      <input type="text" id="stockSearch" class="form-control form-control-sm" placeholder="Ara" style="width:200px">
    </div>
  </div>

  <div class="tabs-wrap">
    <ul class="nav nav-tabs" id="stockTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-log" data-bs-toggle="tab" data-bs-target="#pane-log" type="button" role="tab">Log</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-status" data-bs-toggle="tab" data-bs-target="#pane-status" type="button" role="tab">Stok Durumu</button>
      </li>
    </ul>
  </div>
  <div class="page-section">
    <div class="tab-content" id="stockTabContent">
      <div class="tab-pane fade show active" id="pane-log" role="tabpanel">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th style="width:72px;">ID</th>
                <th>Donanım Tipi</th>
                <th>Miktar</th>
                <th>IFS No</th>
                <th>Tarih</th>
                <th>İşlem</th>
                <th>İşlem Yapan</th>
              </tr>
            </thead>
            <tbody>
              {% for r in logs %}
              <tr>
                <td>#{{ r.id }}</td>
                <td>{{ hardware_map.get(r.donanim_tipi) or license_map.get(r.donanim_tipi) or r.donanim_tipi }}</td>
                <td>{{ r.miktar }}</td>
                <td>{{ r.ifs_no or '-' }}</td>
                <td>{{ (r.tarih).strftime("%d.%m.%Y %H:%M") if r.tarih else '-' }}</td>
                <td>
                  {% if r.islem == 'girdi' %}<span class="badge text-bg-success">Girdi</span>
                  {% elif r.islem == 'cikti' %}<span class="badge text-bg-warning">Çıktı</span>
                  {% else %}<span class="badge text-bg-secondary">Atama</span>{% endif %}
                </td>
                <td>{{ r.actor or '-' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="tab-pane fade" id="pane-status" role="tabpanel">
        <div class="tabs-wrap mt-3">
          <ul class="nav nav-tabs" id="stockStatusTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="status-tab-inventory" data-bs-toggle="tab" data-bs-target="#stock-status-inventory" type="button" role="tab" aria-controls="stock-status-inventory" aria-selected="true">Envanter</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="status-tab-license" data-bs-toggle="tab" data-bs-target="#stock-status-license" type="button" role="tab" aria-controls="stock-status-license" aria-selected="false">Lisans</button>
            </li>
          </ul>
        </div>
        <div class="tab-content mt-3" id="stockStatusTabContent">
          <div class="tab-pane fade show active" id="stock-status-inventory" role="tabpanel" aria-labelledby="status-tab-inventory">
            <div class="table-responsive">
              <table class="table table-sm stock-status-table" id="tblStockStatusInventory">
                <thead class="table-light">
                  <tr>
                    <th>Donanım Tipi</th>
                    <th>Marka</th>
                    <th>Model</th>
                    <th>IFS No</th>
                    <th class="text-end">Stok</th>
                    <th>Son İşlem</th>
                    <th class="text-center">İşlemler</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div class="tab-pane fade" id="stock-status-license" role="tabpanel" aria-labelledby="status-tab-license">
            <div class="table-responsive">
              <table class="table table-sm stock-status-table" id="tblStockStatusLicense">
                <thead class="table-light">
                  <tr>
                    <th>Donanım Tipi</th>
                    <th>Marka</th>
                    <th>Model</th>
                    <th>IFS No</th>
                    <th class="text-end">Stok</th>
                    <th>Son İşlem</th>
                    <th class="text-center">İşlemler</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="stokDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Stok Detayı</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <dl class="row mb-0 small" id="stokDetailList"></dl>
        <div class="mt-3 d-none" id="stokDetailLinkWrap">
          <a id="stokDetailLink" class="btn btn-link btn-sm ps-0" href="#" target="_blank" rel="noopener">Kaynağı aç</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- STOK EKLE MODALI -->
<div class="modal fade" id="modalStockAdd" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="frmStockAdd" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Stok Ekle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body row g-3">
        <div class="col-12">
          <ul class="nav nav-pills" id="stockAddType" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" type="button" data-stock-add-type="inventory" aria-selected="true">Envanter</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" type="button" data-stock-add-type="license" aria-selected="false">Lisans</button>
            </li>
          </ul>
        </div>

        <div id="hardwareFields" class="col-12">
          <div class="row g-3 stok-row">
            <div class="col-md-3">
              <label class="form-label">Donanım Tipi</label>
              <select name="donanim_tipi" class="form-select" data-lookup="donanim_tipi" id="stok_donanim_tipi" required></select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Marka (ops.)</label>
              <select name="marka" class="form-select" data-lookup="marka" id="stok_marka"></select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Model (ops.)</label>
              <select name="model" class="form-select" data-lookup="model" data-depends="#stok_marka" id="stok_model"></select>
            </div>
            <div class="col-md-2" id="rowMiktar">
              <label class="form-label">Miktar</label>
              <input type="number" min="1" id="miktar" name="miktar" class="form-control" required>
            </div>
            <div class="col-md-2">
              <label class="form-label">IFS No (opsiyonel)</label>
              <input type="text" id="ifs_no" name="ifs_no" class="form-control">
            </div>
          </div>
        </div>

        <div id="licenseFields" class="col-12 row g-3 d-none">
          <div class="col-md-4">
            <label class="form-label">Lisans Adı</label>
            <select id="lisans_adi" name="lisans_adi" class="form-select" data-lookup="lisans_adi" required></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Lisans Anahtarı</label>
            <input type="text" id="lisans_anahtari" name="lisans_anahtari" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">E-posta (opsiyonel)</label>
            <input type="email" id="mail_adresi" name="mail_adresi" class="form-control">
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
        <button class="btn btn-primary" type="submit">Kaydet</button>
      </div>
    </form>
  </div>
</div>

<!-- STOK ATAMA MODALI -->
<div class="modal fade" id="stokAtamaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Stok Atama</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>

      <div class="modal-body">
        <form id="stockAssignForm" class="vstack gap-3">
          <!-- 1) STOK SEÇ (Stok Durumu'ndan) -->
          <div>
            <label class="form-label fw-semibold">Stok Seç</label>
            <select id="sa_stock" class="form-select" required>
              <option value="">Seçiniz...</option>
            </select>
            <div id="sa_stock_meta" class="small text-muted mt-1 d-none">
              <span id="sa_meta_tip"></span> ·
              IFS: <span id="sa_meta_ifs"></span> ·
              Mevcut: <span id="sa_meta_qty"></span>
            </div>
          </div>

          <!-- 2) Atama Türü -->
          <div>
            <label class="form-label fw-semibold">Atama Türü</label>
            <ul class="nav nav-tabs" id="sa_tabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#sa_tab_lisans" type="button" role="tab">Lisans</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#sa_tab_envanter" type="button" role="tab">Envanter</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#sa_tab_yazici" type="button" role="tab">Yazıcı</button>
              </li>
            </ul>

            <div class="tab-content border border-top-0 p-3 rounded-bottom">
              <!-- LISANS -->
              <div class="tab-pane fade show active" id="sa_tab_lisans" role="tabpanel">
                <div class="row g-3" id="sa_license_form">
                  <div class="col-md-6" data-auto-field>
                    <label class="form-label">Lisans Adı</label>
                    <input id="sa_license_name" class="form-control" data-auto-key="donanim_tipi" placeholder="Lisans adı" required>
                  </div>
                  <div class="col-md-6" data-auto-field>
                    <label class="form-label">Lisans Anahtarı</label>
                    <input id="sa_license_key" class="form-control" data-auto-key="lisans_anahtari" placeholder="Lisans anahtarı">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Sorumlu Personel</label>
                    <select id="sa_license_person" class="form-select" data-no-search>
                      <option value="">Seçiniz...</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Bağlı Envanter (opsiyonel)</label>
                    <select id="sa_license_inventory" class="form-select" data-no-search>
                      <option value="">Seçiniz...</option>
                    </select>
                  </div>
                  <div class="col-md-6" data-auto-field>
                    <label class="form-label">IFS No</label>
                    <input id="sa_license_ifs" class="form-control" data-auto-key="ifs_no" placeholder="IFS No">
                  </div>
                  <div class="col-md-6" data-auto-field>
                    <label class="form-label">Mail Adresi</label>
                    <input id="sa_license_mail" type="email" class="form-control" data-auto-key="mail_adresi" placeholder="ornek@firma.com">
                  </div>
                </div>
              </div>

              <!-- ENVANTER -->
              <div class="tab-pane fade" id="sa_tab_envanter" role="tabpanel">
                <div class="row g-3" id="sa_inventory_form">
                  <div class="col-md-6">
                    <label class="form-label">Envanter No</label>
                    <input id="sa_inv_no" class="form-control" placeholder="ENV-000123" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Bilgisayar Adı</label>
                    <input id="sa_inv_pc" class="form-control" placeholder="PC-OFIS-01">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Fabrika</label>
                    <select id="sa_inv_factory" class="form-select" data-no-search>
                      <option value="">Seçiniz...</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Departman</label>
                    <select id="sa_inv_department" class="form-select" data-no-search>
                      <option value="">Seçiniz...</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Kullanım Alanı</label>
                    <select id="sa_inv_usage" class="form-select" data-no-search>
                      <option value="">Seçiniz...</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Sorumlu Personel</label>
                    <select id="sa_inv_person" class="form-select" data-no-search>
                      <option value="">Seçiniz...</option>
                    </select>
                  </div>
                  <div class="col-md-6" data-auto-field>
                    <label class="form-label">Donanım Tipi</label>
                    <input id="sa_inv_hardware" class="form-control" data-auto-key="donanim_tipi" placeholder="Donanım tipi">
                  </div>
                  <div class="col-md-6" data-auto-field>
                    <label class="form-label">Marka</label>
                    <input id="sa_inv_brand" class="form-control" data-auto-key="marka" placeholder="Marka">
                  </div>
                  <div class="col-md-6" data-auto-field>
                    <label class="form-label">Model</label>
                    <input id="sa_inv_model" class="form-control" data-auto-key="model" placeholder="Model">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Seri No</label>
                    <input id="sa_inv_serial" class="form-control" placeholder="Seri no">
                  </div>
                  <div class="col-md-6" data-auto-field>
                    <label class="form-label">IFS No</label>
                    <input id="sa_inv_ifs" class="form-control" data-auto-key="ifs_no" placeholder="IFS No">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Bağlı Makina No</label>
                    <input id="sa_inv_machine" class="form-control" placeholder="Makina no">
                  </div>
                  <div class="col-12">
                    <label class="form-label">Notlar (opsiyonel)</label>
                    <textarea id="sa_inv_note" class="form-control" rows="2" placeholder="Ek bilgi"></textarea>
                  </div>
                </div>
              </div>

              <!-- YAZICI -->
              <div class="tab-pane fade" id="sa_tab_yazici" role="tabpanel">
                <div class="row g-3" id="sa_printer_form">
                  <div class="col-md-6">
                    <label class="form-label">Envanter No</label>
                    <input id="sa_prn_no" class="form-control" placeholder="PRN-000123" required>
                  </div>
                  <div class="col-md-6" data-auto-field>
                    <label class="form-label">Marka</label>
                    <input id="sa_prn_brand" class="form-control" data-auto-key="marka" placeholder="Marka">
                  </div>
                  <div class="col-md-6" data-auto-field>
                    <label class="form-label">Model</label>
                    <input id="sa_prn_model" class="form-control" data-auto-key="model" placeholder="Model">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Kullanım Alanı</label>
                    <select id="sa_prn_usage" class="form-select" data-no-search>
                      <option value="">Seçiniz...</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">IP Adresi</label>
                    <input id="sa_prn_ip" class="form-control" placeholder="192.168.x.x">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">MAC</label>
                    <input id="sa_prn_mac" class="form-control" placeholder="AA:BB:CC:DD:EE:FF">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Hostname</label>
                    <input id="sa_prn_host" class="form-control" placeholder="Yazıcı adı">
                  </div>
                  <div class="col-md-6" data-auto-field>
                    <label class="form-label">IFS No</label>
                    <input id="sa_prn_ifs" class="form-control" data-auto-key="ifs_no" placeholder="IFS No">
                  </div>
                  <div class="col-12">
                    <label class="form-label">Notlar (opsiyonel)</label>
                    <textarea id="sa_prn_note" class="form-control" rows="2" placeholder="Ek bilgi"></textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 3) Genel Alanlar -->
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Miktar</label>
              <input id="sa_miktar" type="number" class="form-control" value="1" min="1" readonly>
              <div class="form-text">Atamalar tekil kayıt oluşturur.</div>
            </div>
            <div class="col-md-8">
              <label class="form-label">Notlar (opsiyonel)</label>
              <input id="sa_not" type="text" class="form-control" placeholder="İsteğe bağlı açıklama">
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
        <button id="sa_submit" class="btn btn-primary">Atamayı Yap</button>
  </div>
  </div>
</div>
</div>
</div>

<!-- Lookup ile doldurulacak örnek selectler -->
<div class="d-none" id="lookup-demo-selects">
  <select id="stok_durumu_select" class="form-select" name="stok_durumu"></select>
  <select id="islem_select" class="form-select" name="islem"></select>
  <select id="donanim_tipi_select" class="form-select" name="donanim_tipi"></select>
  <!-- <select id="ifs_no_select" class="form-select" name="ifs_no"></select> -->
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/stock.js"></script>
<script>
async function fillSelect(id, entity) {
  const el = document.getElementById(id);
  if (!el) return;
  el.innerHTML = '<option value="">Yükleniyor...</option>';
  try {
    const r = await fetch(`/api/lookup/${entity}`);
    if (!r.ok) throw new Error(await r.text());
    const data = await r.json();
    el.innerHTML = '<option value="">Seçiniz…</option>' + (data || []).map(v => {
      const text = typeof v === 'string' ? v : (v.name || v.text || v.id);
      return `<option value="${text}">${text}</option>`;
    }).join('');
  } catch (e) {
    console.error(e);
    el.innerHTML = '<option value="">(Veri Yok)</option>';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  fillSelect('stok_durumu_select', 'stok_durumu');
  fillSelect('islem_select', 'islem');
  fillSelect('donanim_tipi_select', 'donanim_tipi');
  // fillSelect('ifs_no_select', 'ifs_no');
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const modal = document.getElementById('modalStockAdd');
  if (!modal) return;
  modal.addEventListener('shown.bs.modal', async () => {
    await _selects.fillChoices({ endpoint: '/api/lookup/donanim_tipi', selectId: 'stok_donanim_tipi', placeholder: 'Donanım tipi seçiniz…' });
    await _selects.fillChoices({ endpoint: '/api/lookup/marka', selectId: 'stok_marka', placeholder: 'Marka seçiniz…' });
    await _selects.fillChoices({ endpoint: '/api/lookup/lisans_adi', selectId: 'lisans_adi', placeholder: 'Lisans adı seçiniz…' });
    _selects.bindMarkaModel('stok_marka', 'stok_model');
  });
});
</script>
{% endblock %}

